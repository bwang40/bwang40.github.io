
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://docs.llamaindex.ai/en/stable/api_reference/agent/">
      
      
        <link rel="prev" href="../">
      
      
        <link rel="next" href="azure_foundry_agent/">
      
      
      <link rel="icon" href="../../_static/assets/LlamaLogoBrowserTab.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.49">
    
    
      
        <title>Agent Classes - LlamaIndex</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.6f8fc17f.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../css/style.css">
    
      <link rel="stylesheet" href="../../css/algolia.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-BYVB1ZVE6J"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-BYVB1ZVE6J",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-BYVB1ZVE6J",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#agent-classes" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="LlamaIndex" class="md-header__button md-logo" aria-label="LlamaIndex" data-md-component="logo">
      
  <img src="../../_static/assets/LlamaSquareBlack.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            LlamaIndex
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Agent Classes
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="purple"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="purple"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      

<!-- Search interface -->
<div id="docsearch"></div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../.." class="md-tabs__link">
          
  
    
  
  Home

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../understanding/" class="md-tabs__link">
          
  
    
  
  Learn

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../use_cases/" class="md-tabs__link">
          
  
    
  
  Use Cases

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../examples/" class="md-tabs__link">
          
  
    
  
  Examples

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../module_guides/" class="md-tabs__link">
          
  
    
  
  Component Guides

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../optimizing/production_rag/" class="md-tabs__link">
          
  
    
  
  Advanced Topics

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../" class="md-tabs__link">
          
  
    
  
  API Reference

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../community/integrations/" class="md-tabs__link">
          
  
    
  
  Open-Source Community

        </a>
      </li>
    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="https://docs.cloud.llamaindex.ai/" class="md-tabs__link">
        
  
    
  
  LlamaCloud

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="LlamaIndex" class="md-nav__button md-logo" aria-label="LlamaIndex" data-md-component="logo">
      
  <img src="../../_static/assets/LlamaSquareBlack.svg" alt="logo">

    </a>
    LlamaIndex
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../.." class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Home
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../understanding/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Learn
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../use_cases/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Use Cases
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../examples/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Examples
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../module_guides/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Component Guides
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../optimizing/production_rag/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Advanced Topics
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
        
        
      
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    API Reference
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7" id="__nav_7_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_2" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="./" class="md-nav__link md-nav__link--active">
              
  
  <span class="md-ellipsis">
    Agents
  </span>
  

            </a>
            
              
              <label class="md-nav__link md-nav__link--active" for="__nav_7_2" id="__nav_7_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7_2">
            <span class="md-nav__icon md-icon"></span>
            Agents
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="azure_foundry_agent/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Azure foundry agent
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="coa/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Coa
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="dashscope/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Dashscope
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="introspective/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introspective
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="lats/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lats
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="llm_compiler/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Llm compiler
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="openai/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Openai
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="openai_legacy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Openai legacy
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../callbacks/agentops/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Callbacks
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
          
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../chat_engines/condense_plus_context/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Chat Engines
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../embeddings/adapter/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Embeddings
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../evaluation/answer_relevancy/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Evaluation
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../graph_rag/cognee/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Graph RAG
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../indices/bge_m3/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Indexes
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../ingestion/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Ingestion
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
          
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../instrumentation/event_handlers/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Instrumentation
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../llms/ai21/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    LLMs
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../llama_dataset/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Llama Datasets
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../llama_deploy" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Llama Deploy
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../packs/agent_search_retriever/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Llama Packs
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../llama_deploy/apiserver.md" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    LlamaDeploy
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../memory/chat_memory_buffer/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Memory
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../llama_deploy/message_queues/index.md" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Message Queues
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../extractors/documentcontext/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Metadata Extractors
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../multi_modal_llms/anthropic/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Multi-Modal LLMs
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../node_parser/alibabacloud_aisearch/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Node Parsers & Text Splitters
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../postprocessor/NER_PII/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Node Postprocessors
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../objects/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Object Stores
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../observability/otel/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Observability
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../output_parsers/guardrails/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Output Parsers
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../program/evaporate/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Programs
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../prompts/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Prompts
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../protocols/ag_ui/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Protocols
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../query_engine/FLARE/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Query Engines
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../query_pipeline/agent/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Query Pipeline
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../question_gen/guidance/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Question Generators
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../readers/agent_search/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Readers
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../response_synthesizers/accumulate/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Response Synthesizers
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../retrievers/auto_merging/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Retrievers
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../schema/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Schema
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../selectors/notdiamond/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Selectors
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../sparse_embeddings/fastembed/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Sparse Embeddings
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    
  
  
    <a href="../storage/chat_store/async_sql/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Storage
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../tools/agentql/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Tools
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../voice_agents/elevenlabs/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Voice Agents
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../workflow/decorators/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Workflow
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../community/integrations/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Open-Source Community
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="https://docs.cloud.llamaindex.ai/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    LlamaCloud
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#llama_index.core.agent.workflow.AgentWorkflow" class="md-nav__link">
    <span class="md-ellipsis">
      AgentWorkflow
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AgentWorkflow">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#llama_index.core.agent.workflow.AgentWorkflow.get_tools" class="md-nav__link">
    <span class="md-ellipsis">
      get_tools
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llama_index.core.agent.workflow.AgentWorkflow.init_run" class="md-nav__link">
    <span class="md-ellipsis">
      init_run
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llama_index.core.agent.workflow.AgentWorkflow.setup_agent" class="md-nav__link">
    <span class="md-ellipsis">
      setup_agent
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llama_index.core.agent.workflow.AgentWorkflow.run_agent_step" class="md-nav__link">
    <span class="md-ellipsis">
      run_agent_step
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llama_index.core.agent.workflow.AgentWorkflow.call_tool" class="md-nav__link">
    <span class="md-ellipsis">
      call_tool
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llama_index.core.agent.workflow.AgentWorkflow.aggregate_tool_results" class="md-nav__link">
    <span class="md-ellipsis">
      aggregate_tool_results
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llama_index.core.agent.workflow.AgentWorkflow.from_tools_or_functions" class="md-nav__link">
    <span class="md-ellipsis">
      from_tools_or_functions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llama_index.core.agent.workflow.BaseWorkflowAgent" class="md-nav__link">
    <span class="md-ellipsis">
      BaseWorkflowAgent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="BaseWorkflowAgent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#llama_index.core.agent.workflow.BaseWorkflowAgent.validate_tools" class="md-nav__link">
    <span class="md-ellipsis">
      validate_tools
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llama_index.core.agent.workflow.BaseWorkflowAgent.take_step" class="md-nav__link">
    <span class="md-ellipsis">
      take_step
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llama_index.core.agent.workflow.BaseWorkflowAgent.handle_tool_call_results" class="md-nav__link">
    <span class="md-ellipsis">
      handle_tool_call_results
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llama_index.core.agent.workflow.BaseWorkflowAgent.finalize" class="md-nav__link">
    <span class="md-ellipsis">
      finalize
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llama_index.core.agent.workflow.BaseWorkflowAgent.get_tools" class="md-nav__link">
    <span class="md-ellipsis">
      get_tools
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llama_index.core.agent.workflow.BaseWorkflowAgent.init_run" class="md-nav__link">
    <span class="md-ellipsis">
      init_run
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llama_index.core.agent.workflow.BaseWorkflowAgent.setup_agent" class="md-nav__link">
    <span class="md-ellipsis">
      setup_agent
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llama_index.core.agent.workflow.BaseWorkflowAgent.run_agent_step" class="md-nav__link">
    <span class="md-ellipsis">
      run_agent_step
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llama_index.core.agent.workflow.BaseWorkflowAgent.call_tool" class="md-nav__link">
    <span class="md-ellipsis">
      call_tool
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llama_index.core.agent.workflow.BaseWorkflowAgent.aggregate_tool_results" class="md-nav__link">
    <span class="md-ellipsis">
      aggregate_tool_results
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llama_index.core.agent.workflow.FunctionAgent" class="md-nav__link">
    <span class="md-ellipsis">
      FunctionAgent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="FunctionAgent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#llama_index.core.agent.workflow.FunctionAgent.take_step" class="md-nav__link">
    <span class="md-ellipsis">
      take_step
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llama_index.core.agent.workflow.FunctionAgent.handle_tool_call_results" class="md-nav__link">
    <span class="md-ellipsis">
      handle_tool_call_results
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llama_index.core.agent.workflow.FunctionAgent.finalize" class="md-nav__link">
    <span class="md-ellipsis">
      finalize
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llama_index.core.agent.workflow.ReActAgent" class="md-nav__link">
    <span class="md-ellipsis">
      ReActAgent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ReActAgent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#llama_index.core.agent.workflow.ReActAgent.validate_formatter" class="md-nav__link">
    <span class="md-ellipsis">
      validate_formatter
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llama_index.core.agent.workflow.ReActAgent.take_step" class="md-nav__link">
    <span class="md-ellipsis">
      take_step
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llama_index.core.agent.workflow.ReActAgent.handle_tool_call_results" class="md-nav__link">
    <span class="md-ellipsis">
      handle_tool_call_results
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llama_index.core.agent.workflow.ReActAgent.finalize" class="md-nav__link">
    <span class="md-ellipsis">
      finalize
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llama_index.core.agent.workflow.CodeActAgent" class="md-nav__link">
    <span class="md-ellipsis">
      CodeActAgent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CodeActAgent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#llama_index.core.agent.workflow.CodeActAgent.take_step" class="md-nav__link">
    <span class="md-ellipsis">
      take_step
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llama_index.core.agent.workflow.CodeActAgent.handle_tool_call_results" class="md-nav__link">
    <span class="md-ellipsis">
      handle_tool_call_results
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llama_index.core.agent.workflow.CodeActAgent.finalize" class="md-nav__link">
    <span class="md-ellipsis">
      finalize
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llama_index.core.agent.workflow.AgentInput" class="md-nav__link">
    <span class="md-ellipsis">
      AgentInput
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llama_index.core.agent.workflow.AgentStream" class="md-nav__link">
    <span class="md-ellipsis">
      AgentStream
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llama_index.core.agent.workflow.AgentOutput" class="md-nav__link">
    <span class="md-ellipsis">
      AgentOutput
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llama_index.core.agent.workflow.ToolCall" class="md-nav__link">
    <span class="md-ellipsis">
      ToolCall
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llama_index.core.agent.workflow.ToolCallResult" class="md-nav__link">
    <span class="md-ellipsis">
      ToolCallResult
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="agent-classes">Agent Classes<a class="headerlink" href="#agent-classes" title="Permanent link">#</a></h1>


<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">








  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="llama_index.core.agent.workflow.AgentWorkflow" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">AgentWorkflow</span>


<a href="#llama_index.core.agent.workflow.AgentWorkflow" class="headerlink" title="Permanent link">#</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="llama_index.core.workflow.Workflow" href="../workflow/workflow/#workflows.workflow.Workflow">Workflow</a></code>, <code><span title="llama_index.core.prompts.mixin.PromptMixin">PromptMixin</span></code></p>


        <p>A workflow for managing multiple agents with handoffs.</p>






              <details class="quote">
                <summary>Source code in <code>llama_index\core\agent\workflow\multi_agent_workflow.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">AgentWorkflow</span><span class="p">(</span><span class="n">Workflow</span><span class="p">,</span> <span class="n">PromptMixin</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">AgentWorkflowMeta</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A workflow for managing multiple agents with handoffs.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">agents</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">BaseWorkflowAgent</span><span class="p">],</span>
        <span class="n">initial_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">root_agent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">handoff_prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">BasePromptTemplate</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">handoff_output_prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">BasePromptTemplate</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">state_prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">BasePromptTemplate</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">output_cls</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">structured_output_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
            <span class="n">Callable</span><span class="p">[[</span><span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>
        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">workflow_kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="o">**</span><span class="n">workflow_kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">agents</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;At least one agent must be provided&quot;</span><span class="p">)</span>

        <span class="c1"># Raise an error if any agent has no name or no description</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">agents</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">agent</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">DEFAULT_AGENT_NAME</span> <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">agents</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All agents must have a name in a multi-agent workflow&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">agents</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">agent</span><span class="o">.</span><span class="n">description</span> <span class="o">==</span> <span class="n">DEFAULT_AGENT_DESCRIPTION</span> <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">agents</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;All agents must have a description in a multi-agent workflow&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">initial_state</span> <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">agents</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Initial state is not supported per-agent in AgentWorkflow&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">agents</span> <span class="o">=</span> <span class="p">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">cfg</span> <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">agents</span><span class="p">}</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">agents</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">root_agent</span> <span class="o">=</span> <span class="n">agents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
        <span class="k">elif</span> <span class="n">root_agent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Exactly one root agent must be provided&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">root_agent</span> <span class="o">=</span> <span class="n">root_agent</span>

        <span class="k">if</span> <span class="n">root_agent</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Root agent </span><span class="si">{</span><span class="n">root_agent</span><span class="si">}</span><span class="s2"> not found in provided agents&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">root_agent</span> <span class="o">=</span> <span class="n">root_agent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_state</span> <span class="o">=</span> <span class="n">initial_state</span> <span class="ow">or</span> <span class="p">{}</span>

        <span class="n">handoff_prompt</span> <span class="o">=</span> <span class="n">handoff_prompt</span> <span class="ow">or</span> <span class="n">DEFAULT_HANDOFF_PROMPT</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">handoff_prompt</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">handoff_prompt</span> <span class="o">=</span> <span class="n">PromptTemplate</span><span class="p">(</span><span class="n">handoff_prompt</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;</span><span class="si">{agent_info}</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">handoff_prompt</span><span class="o">.</span><span class="n">get_template</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Handoff prompt must contain </span><span class="si">{agent_info}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handoff_prompt</span> <span class="o">=</span> <span class="n">handoff_prompt</span>

        <span class="n">handoff_output_prompt</span> <span class="o">=</span> <span class="n">handoff_output_prompt</span> <span class="ow">or</span> <span class="n">DEFAULT_HANDOFF_OUTPUT_PROMPT</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">handoff_output_prompt</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">handoff_output_prompt</span> <span class="o">=</span> <span class="n">PromptTemplate</span><span class="p">(</span><span class="n">handoff_output_prompt</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{to_agent}</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">handoff_output_prompt</span><span class="o">.</span><span class="n">get_template</span><span class="p">()</span>
                <span class="ow">or</span> <span class="s2">&quot;</span><span class="si">{reason}</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">handoff_output_prompt</span><span class="o">.</span><span class="n">get_template</span><span class="p">()</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Handoff output prompt must contain </span><span class="si">{to_agent}</span><span class="s2"> and </span><span class="si">{reason}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handoff_output_prompt</span> <span class="o">=</span> <span class="n">handoff_output_prompt</span>

        <span class="n">state_prompt</span> <span class="o">=</span> <span class="n">state_prompt</span> <span class="ow">or</span> <span class="n">DEFAULT_STATE_PROMPT</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state_prompt</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">state_prompt</span> <span class="o">=</span> <span class="n">PromptTemplate</span><span class="p">(</span><span class="n">state_prompt</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{state}</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">state_prompt</span><span class="o">.</span><span class="n">get_template</span><span class="p">()</span>
                <span class="ow">or</span> <span class="s2">&quot;</span><span class="si">{msg}</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">state_prompt</span><span class="o">.</span><span class="n">get_template</span><span class="p">()</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;State prompt must contain </span><span class="si">{state}</span><span class="s2"> and </span><span class="si">{msg}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_prompt</span> <span class="o">=</span> <span class="n">state_prompt</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">output_cls</span> <span class="o">=</span> <span class="n">output_cls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">structured_output_fn</span> <span class="o">=</span> <span class="n">structured_output_fn</span>
        <span class="k">if</span> <span class="n">output_cls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">structured_output_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">structured_output_fn</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_get_prompts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PromptDictType</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get prompts.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;handoff_prompt&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">handoff_prompt</span><span class="p">,</span>
            <span class="s2">&quot;handoff_output_prompt&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">handoff_output_prompt</span><span class="p">,</span>
            <span class="s2">&quot;state_prompt&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_prompt</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_get_prompt_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PromptMixinType</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get prompt sub-modules.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">agent</span> <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="o">.</span><span class="n">values</span><span class="p">()}</span>

    <span class="k">def</span> <span class="nf">_update_prompts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompts_dict</span><span class="p">:</span> <span class="n">PromptDictType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update prompts.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;handoff_prompt&quot;</span> <span class="ow">in</span> <span class="n">prompts_dict</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handoff_prompt</span> <span class="o">=</span> <span class="n">prompts_dict</span><span class="p">[</span><span class="s2">&quot;handoff_prompt&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;handoff_output_prompt&quot;</span> <span class="ow">in</span> <span class="n">prompts_dict</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handoff_output_prompt</span> <span class="o">=</span> <span class="n">prompts_dict</span><span class="p">[</span><span class="s2">&quot;handoff_output_prompt&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;state_prompt&quot;</span> <span class="ow">in</span> <span class="n">prompts_dict</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state_prompt</span> <span class="o">=</span> <span class="n">prompts_dict</span><span class="p">[</span><span class="s2">&quot;state_prompt&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_ensure_tools_are_async</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">BaseTool</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">AsyncBaseTool</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure all tools are async.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">adapt_to_async_tool</span><span class="p">(</span><span class="n">tool</span><span class="p">)</span> <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_get_handoff_tool</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">current_agent</span><span class="p">:</span> <span class="n">BaseWorkflowAgent</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AsyncBaseTool</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates a handoff tool for the given agent.&quot;&quot;&quot;</span>
        <span class="c1"># Do not create a handoff tool if there is only one agent</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">agent_info</span> <span class="o">=</span> <span class="p">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">description</span> <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="o">.</span><span class="n">values</span><span class="p">()}</span>

        <span class="c1"># Filter out agents that the current agent cannot handoff to</span>
        <span class="n">configs_to_remove</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">agent_info</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="n">current_agent</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="n">configs_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span>
                <span class="n">current_agent</span><span class="o">.</span><span class="n">can_handoff_to</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_agent</span><span class="o">.</span><span class="n">can_handoff_to</span>
            <span class="p">):</span>
                <span class="n">configs_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">configs_to_remove</span><span class="p">:</span>
            <span class="n">agent_info</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">agent_info</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">fn_tool_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handoff_prompt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">agent_info</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">agent_info</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">FunctionTool</span><span class="o">.</span><span class="n">from_defaults</span><span class="p">(</span>
            <span class="n">async_fn</span><span class="o">=</span><span class="n">handoff</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">fn_tool_prompt</span><span class="p">,</span> <span class="n">return_direct</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_tools</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">agent_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">input_str</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">AsyncBaseTool</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get tools for the given agent.&quot;&quot;&quot;</span>
        <span class="n">agent_tools</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">[</span><span class="n">agent_name</span><span class="p">]</span><span class="o">.</span><span class="n">tools</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">tools</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">agent_tools</span><span class="p">]</span>
        <span class="n">retriever</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">[</span><span class="n">agent_name</span><span class="p">]</span><span class="o">.</span><span class="n">tool_retriever</span>
        <span class="k">if</span> <span class="n">retriever</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">retrieved_tools</span> <span class="o">=</span> <span class="k">await</span> <span class="n">retriever</span><span class="o">.</span><span class="n">aretrieve</span><span class="p">(</span><span class="n">input_str</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">tools</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">retrieved_tools</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">[</span><span class="n">agent_name</span><span class="p">]</span><span class="o">.</span><span class="n">can_handoff_to</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">[</span><span class="n">agent_name</span><span class="p">]</span><span class="o">.</span><span class="n">can_handoff_to</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="n">handoff_tool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_handoff_tool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">[</span><span class="n">agent_name</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">handoff_tool</span><span class="p">:</span>
                <span class="n">tools</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">handoff_tool</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_tools_are_async</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">List</span><span class="p">[</span><span class="n">BaseTool</span><span class="p">],</span> <span class="n">tools</span><span class="p">))</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_init_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">ev</span><span class="p">:</span> <span class="n">StartEvent</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the context once, if needed.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;memory&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="n">default_memory</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;memory&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">default_memory</span> <span class="o">=</span> <span class="n">default_memory</span> <span class="ow">or</span> <span class="n">ChatMemoryBuffer</span><span class="o">.</span><span class="n">from_defaults</span><span class="p">(</span>
                <span class="n">llm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">root_agent</span><span class="p">]</span><span class="o">.</span><span class="n">llm</span> <span class="ow">or</span> <span class="n">Settings</span><span class="o">.</span><span class="n">llm</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;memory&quot;</span><span class="p">,</span> <span class="n">default_memory</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agents&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;agents&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;can_handoff_to&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                <span class="s2">&quot;can_handoff_to&quot;</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="n">agent</span><span class="p">:</span> <span class="n">agent_cfg</span><span class="o">.</span><span class="n">can_handoff_to</span>
                    <span class="k">for</span> <span class="n">agent</span><span class="p">,</span> <span class="n">agent_cfg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="p">},</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_state</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;current_agent_name&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;current_agent_name&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_agent</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;handoff_output_prompt&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                <span class="s2">&quot;handoff_output_prompt&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">handoff_output_prompt</span><span class="o">.</span><span class="n">get_template</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_iterations&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="n">max_iterations</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">ev</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_iterations&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">DEFAULT_MAX_ITERATIONS</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;max_iterations&quot;</span><span class="p">,</span> <span class="n">max_iterations</span><span class="p">)</span>

        <span class="c1"># Reset the number of iterations</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;num_iterations&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># always set to false initially</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;formatted_input_with_state&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_call_tool</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span>
        <span class="n">tool</span><span class="p">:</span> <span class="n">AsyncBaseTool</span><span class="p">,</span>
        <span class="n">tool_input</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ToolOutput</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Call the given tool with the given input.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">FunctionTool</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">tool</span><span class="o">.</span><span class="n">requires_context</span>
                <span class="ow">and</span> <span class="n">tool</span><span class="o">.</span><span class="n">ctx_param_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="p">):</span>
                <span class="n">new_tool_input</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">tool_input</span><span class="p">}</span>
                <span class="n">new_tool_input</span><span class="p">[</span><span class="n">tool</span><span class="o">.</span><span class="n">ctx_param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctx</span>
                <span class="n">tool_output</span> <span class="o">=</span> <span class="k">await</span> <span class="n">tool</span><span class="o">.</span><span class="n">acall</span><span class="p">(</span><span class="o">**</span><span class="n">new_tool_input</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tool_output</span> <span class="o">=</span> <span class="k">await</span> <span class="n">tool</span><span class="o">.</span><span class="n">acall</span><span class="p">(</span><span class="o">**</span><span class="n">tool_input</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">tool_output</span> <span class="o">=</span> <span class="n">ToolOutput</span><span class="p">(</span>
                <span class="n">content</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                <span class="n">tool_name</span><span class="o">=</span><span class="n">tool</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span>
                <span class="n">raw_input</span><span class="o">=</span><span class="n">tool_input</span><span class="p">,</span>
                <span class="n">raw_output</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                <span class="n">is_error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">tool_output</span>

    <span class="nd">@step</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">init_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">ev</span><span class="p">:</span> <span class="n">AgentWorkflowStartEvent</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentInput</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets up the workflow and validates inputs.&quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_context</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ev</span><span class="p">)</span>

        <span class="n">user_msg</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ChatMessage</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_msg&quot;</span><span class="p">)</span>
        <span class="n">chat_history</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;chat_history&quot;</span><span class="p">,</span> <span class="p">[])</span>

        <span class="c1"># Convert string user_msg to ChatMessage</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">user_msg</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">user_msg</span> <span class="o">=</span> <span class="n">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">user_msg</span><span class="p">)</span>

        <span class="c1"># Add messages to memory</span>
        <span class="n">memory</span><span class="p">:</span> <span class="n">BaseMemory</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;memory&quot;</span><span class="p">)</span>

        <span class="c1"># First set chat history if it exists</span>
        <span class="k">if</span> <span class="n">chat_history</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">memory</span><span class="o">.</span><span class="n">aset</span><span class="p">(</span><span class="n">chat_history</span><span class="p">)</span>

        <span class="c1"># Then add user message if it exists</span>
        <span class="k">if</span> <span class="n">user_msg</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">memory</span><span class="o">.</span><span class="n">aput</span><span class="p">(</span><span class="n">user_msg</span><span class="p">)</span>
            <span class="n">content_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">block</span><span class="o">.</span><span class="n">text</span>
                    <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">user_msg</span><span class="o">.</span><span class="n">blocks</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">TextBlock</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;user_msg_str&quot;</span><span class="p">,</span> <span class="n">content_str</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">chat_history</span><span class="p">:</span>
            <span class="c1"># If no user message, use the last message from chat history as user_msg_str</span>
            <span class="n">content_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">block</span><span class="o">.</span><span class="n">text</span>
                    <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">chat_history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">blocks</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">TextBlock</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;user_msg_str&quot;</span><span class="p">,</span> <span class="n">content_str</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must provide either user_msg or chat_history&quot;</span><span class="p">)</span>

        <span class="c1"># Get all messages from memory</span>
        <span class="n">input_messages</span> <span class="o">=</span> <span class="k">await</span> <span class="n">memory</span><span class="o">.</span><span class="n">aget</span><span class="p">()</span>

        <span class="c1"># send to the current agent</span>
        <span class="n">current_agent_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;current_agent_name&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">AgentInput</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">input_messages</span><span class="p">,</span> <span class="n">current_agent_name</span><span class="o">=</span><span class="n">current_agent_name</span><span class="p">)</span>

    <span class="nd">@step</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">setup_agent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">ev</span><span class="p">:</span> <span class="n">AgentInput</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentSetup</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Main agent handling logic.&quot;&quot;&quot;</span>
        <span class="n">current_agent_name</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">current_agent_name</span>
        <span class="n">agent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">[</span><span class="n">current_agent_name</span><span class="p">]</span>
        <span class="n">llm_input</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">ev</span><span class="o">.</span><span class="n">input</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">system_prompt</span><span class="p">:</span>
            <span class="n">llm_input</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">agent</span><span class="o">.</span><span class="n">system_prompt</span><span class="p">),</span>
                <span class="o">*</span><span class="n">llm_input</span><span class="p">,</span>
            <span class="p">]</span>

        <span class="n">state</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">formatted_input_with_state</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;formatted_input_with_state&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">state</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">formatted_input_with_state</span><span class="p">:</span>
            <span class="c1"># update last message with current state</span>
            <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">llm_input</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">blocks</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">TextBlock</span><span class="p">):</span>
                    <span class="n">block</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_prompt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">block</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;formatted_input_with_state&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">AgentSetup</span><span class="p">(</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">llm_input</span><span class="p">,</span>
            <span class="n">current_agent_name</span><span class="o">=</span><span class="n">ev</span><span class="o">.</span><span class="n">current_agent_name</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@step</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">run_agent_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">ev</span><span class="p">:</span> <span class="n">AgentSetup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentOutput</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the agent.&quot;&quot;&quot;</span>
        <span class="n">memory</span><span class="p">:</span> <span class="n">BaseMemory</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;memory&quot;</span><span class="p">)</span>
        <span class="n">agent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">[</span><span class="n">ev</span><span class="o">.</span><span class="n">current_agent_name</span><span class="p">]</span>
        <span class="n">user_msg_str</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_msg_str&quot;</span><span class="p">)</span>
        <span class="n">tools</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tools</span><span class="p">(</span><span class="n">ev</span><span class="o">.</span><span class="n">current_agent_name</span><span class="p">,</span> <span class="n">user_msg_str</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">agent_output</span> <span class="o">=</span> <span class="k">await</span> <span class="n">agent</span><span class="o">.</span><span class="n">take_step</span><span class="p">(</span>
            <span class="n">ctx</span><span class="p">,</span>
            <span class="n">ev</span><span class="o">.</span><span class="n">input</span><span class="p">,</span>
            <span class="n">tools</span><span class="p">,</span>
            <span class="n">memory</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">ctx</span><span class="o">.</span><span class="n">write_event_to_stream</span><span class="p">(</span><span class="n">agent_output</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">agent_output</span>

    <span class="nd">@step</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">parse_agent_output</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">ev</span><span class="p">:</span> <span class="n">AgentOutput</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">StopEvent</span><span class="p">,</span> <span class="n">AgentInput</span><span class="p">,</span> <span class="n">ToolCall</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="n">max_iterations</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;max_iterations&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_MAX_ITERATIONS</span>
        <span class="p">)</span>
        <span class="n">num_iterations</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;num_iterations&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">num_iterations</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;num_iterations&quot;</span><span class="p">,</span> <span class="n">num_iterations</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">num_iterations</span> <span class="o">&gt;=</span> <span class="n">max_iterations</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">WorkflowRuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Max iterations of </span><span class="si">{</span><span class="n">max_iterations</span><span class="si">}</span><span class="s2"> reached! Either something went wrong, or you can &quot;</span>
                <span class="s2">&quot;increase the max iterations with `.run(.., max_iterations=...)`&quot;</span>
            <span class="p">)</span>

        <span class="n">memory</span><span class="p">:</span> <span class="n">BaseMemory</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;memory&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ev</span><span class="o">.</span><span class="n">retry_messages</span><span class="p">:</span>
            <span class="c1"># Retry with the given messages to let the LLM fix potential errors</span>
            <span class="n">history</span> <span class="o">=</span> <span class="k">await</span> <span class="n">memory</span><span class="o">.</span><span class="n">aget</span><span class="p">()</span>
            <span class="n">user_msg_str</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_msg_str&quot;</span><span class="p">)</span>
            <span class="n">agent_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;current_agent_name&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">AgentInput</span><span class="p">(</span>
                <span class="nb">input</span><span class="o">=</span><span class="p">[</span>
                    <span class="o">*</span><span class="n">history</span><span class="p">,</span>
                    <span class="n">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">user_msg_str</span><span class="p">),</span>
                    <span class="o">*</span><span class="n">ev</span><span class="o">.</span><span class="n">retry_messages</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="n">current_agent_name</span><span class="o">=</span><span class="n">agent_name</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ev</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="n">agent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">[</span><span class="n">ev</span><span class="o">.</span><span class="n">current_agent_name</span><span class="p">]</span>
            <span class="n">memory</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;memory&quot;</span><span class="p">)</span>
            <span class="n">messages</span> <span class="o">=</span> <span class="k">await</span> <span class="n">memory</span><span class="o">.</span><span class="n">aget</span><span class="p">()</span>
            <span class="n">output</span> <span class="o">=</span> <span class="k">await</span> <span class="n">agent</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">memory</span><span class="p">)</span>

            <span class="n">cur_tool_calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolCallResult</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;current_tool_calls&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[]</span>
            <span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">tool_calls</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cur_tool_calls</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;current_tool_calls&quot;</span><span class="p">,</span> <span class="p">[])</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">structured_output_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">iscoroutinefunction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structured_output_fn</span><span class="p">):</span>
                        <span class="n">output</span><span class="o">.</span><span class="n">structured_response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">structured_output_fn</span><span class="p">(</span>
                            <span class="n">messages</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">output</span><span class="o">.</span><span class="n">structured_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structured_output_fn</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;An error occurred while producing the structured output from your agent: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">.&quot;</span>
                    <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_cls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">xml_message</span> <span class="o">=</span> <span class="n">messages_to_xml_format</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
                    <span class="n">structured_response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">agent</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">as_structured_llm</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">output_cls</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">achat</span><span class="p">(</span><span class="n">messages</span><span class="o">=</span><span class="p">[</span><span class="n">xml_message</span><span class="p">],</span> <span class="n">tool_required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">structured_response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span>
                        <span class="n">structured_response</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;An error occurred while producing the structured output from your agent: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">.&quot;</span>
                    <span class="p">)</span>

            <span class="k">return</span> <span class="n">StopEvent</span><span class="p">(</span><span class="n">result</span><span class="o">=</span><span class="n">output</span><span class="p">)</span>

        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;num_tool_calls&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ev</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">tool_call</span> <span class="ow">in</span> <span class="n">ev</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">send_event</span><span class="p">(</span>
                <span class="n">ToolCall</span><span class="p">(</span>
                    <span class="n">tool_name</span><span class="o">=</span><span class="n">tool_call</span><span class="o">.</span><span class="n">tool_name</span><span class="p">,</span>
                    <span class="n">tool_kwargs</span><span class="o">=</span><span class="n">tool_call</span><span class="o">.</span><span class="n">tool_kwargs</span><span class="p">,</span>
                    <span class="n">tool_id</span><span class="o">=</span><span class="n">tool_call</span><span class="o">.</span><span class="n">tool_id</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@step</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">call_tool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">ev</span><span class="p">:</span> <span class="n">ToolCall</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ToolCallResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calls the tool and handles the result.&quot;&quot;&quot;</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">write_event_to_stream</span><span class="p">(</span>
            <span class="n">ToolCall</span><span class="p">(</span>
                <span class="n">tool_name</span><span class="o">=</span><span class="n">ev</span><span class="o">.</span><span class="n">tool_name</span><span class="p">,</span>
                <span class="n">tool_kwargs</span><span class="o">=</span><span class="n">ev</span><span class="o">.</span><span class="n">tool_kwargs</span><span class="p">,</span>
                <span class="n">tool_id</span><span class="o">=</span><span class="n">ev</span><span class="o">.</span><span class="n">tool_id</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">current_agent_name</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;current_agent_name&quot;</span><span class="p">)</span>
        <span class="n">tools</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tools</span><span class="p">(</span><span class="n">current_agent_name</span><span class="p">,</span> <span class="n">ev</span><span class="o">.</span><span class="n">tool_name</span><span class="p">)</span>
        <span class="n">tools_by_name</span> <span class="o">=</span> <span class="p">{</span><span class="n">tool</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">tool</span> <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">ev</span><span class="o">.</span><span class="n">tool_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tools_by_name</span><span class="p">:</span>
            <span class="n">tool</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">ToolOutput</span><span class="p">(</span>
                <span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Tool </span><span class="si">{</span><span class="n">ev</span><span class="o">.</span><span class="n">tool_name</span><span class="si">}</span><span class="s2"> not found. Please select a tool that is available.&quot;</span><span class="p">,</span>
                <span class="n">tool_name</span><span class="o">=</span><span class="n">ev</span><span class="o">.</span><span class="n">tool_name</span><span class="p">,</span>
                <span class="n">raw_input</span><span class="o">=</span><span class="n">ev</span><span class="o">.</span><span class="n">tool_kwargs</span><span class="p">,</span>
                <span class="n">raw_output</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">is_error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tool</span> <span class="o">=</span> <span class="n">tools_by_name</span><span class="p">[</span><span class="n">ev</span><span class="o">.</span><span class="n">tool_name</span><span class="p">]</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_tool</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">tool</span><span class="p">,</span> <span class="n">ev</span><span class="o">.</span><span class="n">tool_kwargs</span><span class="p">)</span>

        <span class="n">result_ev</span> <span class="o">=</span> <span class="n">ToolCallResult</span><span class="p">(</span>
            <span class="n">tool_name</span><span class="o">=</span><span class="n">ev</span><span class="o">.</span><span class="n">tool_name</span><span class="p">,</span>
            <span class="n">tool_kwargs</span><span class="o">=</span><span class="n">ev</span><span class="o">.</span><span class="n">tool_kwargs</span><span class="p">,</span>
            <span class="n">tool_id</span><span class="o">=</span><span class="n">ev</span><span class="o">.</span><span class="n">tool_id</span><span class="p">,</span>
            <span class="n">tool_output</span><span class="o">=</span><span class="n">result</span><span class="p">,</span>
            <span class="n">return_direct</span><span class="o">=</span><span class="n">tool</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">return_direct</span> <span class="k">if</span> <span class="n">tool</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">ctx</span><span class="o">.</span><span class="n">write_event_to_stream</span><span class="p">(</span><span class="n">result_ev</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result_ev</span>

    <span class="nd">@step</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">aggregate_tool_results</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">ev</span><span class="p">:</span> <span class="n">ToolCallResult</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">AgentInput</span><span class="p">,</span> <span class="n">StopEvent</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Aggregate tool results and return the next agent input.&quot;&quot;&quot;</span>
        <span class="n">num_tool_calls</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;num_tool_calls&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_tool_calls</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No tool calls found, cannot aggregate results.&quot;</span><span class="p">)</span>

        <span class="n">tool_call_results</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ToolCallResult</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">collect_events</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
            <span class="n">ev</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="p">[</span><span class="n">ToolCallResult</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_tool_calls</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tool_call_results</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">memory</span><span class="p">:</span> <span class="n">BaseMemory</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;memory&quot;</span><span class="p">)</span>
        <span class="n">agent_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;current_agent_name&quot;</span><span class="p">)</span>
        <span class="n">agent</span><span class="p">:</span> <span class="n">BaseWorkflowAgent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">[</span><span class="n">agent_name</span><span class="p">]</span>

        <span class="c1"># track tool calls made during a .run() call</span>
        <span class="n">cur_tool_calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolCallResult</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;current_tool_calls&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[]</span>
        <span class="p">)</span>
        <span class="n">cur_tool_calls</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tool_call_results</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;current_tool_calls&quot;</span><span class="p">,</span> <span class="n">cur_tool_calls</span><span class="p">)</span>

        <span class="k">await</span> <span class="n">agent</span><span class="o">.</span><span class="n">handle_tool_call_results</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">tool_call_results</span><span class="p">,</span> <span class="n">memory</span><span class="p">)</span>

        <span class="c1"># set the next agent, if needed</span>
        <span class="c1"># the handoff tool sets this</span>
        <span class="n">next_agent_name</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;next_agent&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">next_agent_name</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;current_agent_name&quot;</span><span class="p">,</span> <span class="n">next_agent_name</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;next_agent&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">tool_call_result</span><span class="o">.</span><span class="n">return_direct</span> <span class="k">for</span> <span class="n">tool_call_result</span> <span class="ow">in</span> <span class="n">tool_call_results</span>
        <span class="p">):</span>
            <span class="c1"># if any tool calls return directly, take the first one</span>
            <span class="n">return_direct_tool</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
                <span class="n">tool_call_result</span>
                <span class="k">for</span> <span class="n">tool_call_result</span> <span class="ow">in</span> <span class="n">tool_call_results</span>
                <span class="k">if</span> <span class="n">tool_call_result</span><span class="o">.</span><span class="n">return_direct</span>
            <span class="p">)</span>

            <span class="c1"># always finalize the agent, even if we&#39;re just handing off</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">AgentOutput</span><span class="p">(</span>
                <span class="n">response</span><span class="o">=</span><span class="n">ChatMessage</span><span class="p">(</span>
                    <span class="n">role</span><span class="o">=</span><span class="s2">&quot;assistant&quot;</span><span class="p">,</span>
                    <span class="n">content</span><span class="o">=</span><span class="n">return_direct_tool</span><span class="o">.</span><span class="n">tool_output</span><span class="o">.</span><span class="n">content</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">tool_calls</span><span class="o">=</span><span class="p">[</span>
                    <span class="n">ToolSelection</span><span class="p">(</span>
                        <span class="n">tool_id</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">tool_id</span><span class="p">,</span>
                        <span class="n">tool_name</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">tool_name</span><span class="p">,</span>
                        <span class="n">tool_kwargs</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">tool_kwargs</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">cur_tool_calls</span>
                <span class="p">],</span>
                <span class="n">raw</span><span class="o">=</span><span class="n">return_direct_tool</span><span class="o">.</span><span class="n">tool_output</span><span class="o">.</span><span class="n">raw_output</span><span class="p">,</span>
                <span class="n">current_agent_name</span><span class="o">=</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">agent</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">memory</span><span class="p">)</span>

            <span class="c1"># we don&#39;t want to stop the system if we&#39;re just handing off</span>
            <span class="k">if</span> <span class="n">return_direct_tool</span><span class="o">.</span><span class="n">tool_name</span> <span class="o">!=</span> <span class="s2">&quot;handoff&quot;</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;current_tool_calls&quot;</span><span class="p">,</span> <span class="p">[])</span>
                <span class="k">return</span> <span class="n">StopEvent</span><span class="p">(</span><span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>

        <span class="n">user_msg_str</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_msg_str&quot;</span><span class="p">)</span>
        <span class="n">input_messages</span> <span class="o">=</span> <span class="k">await</span> <span class="n">memory</span><span class="o">.</span><span class="n">aget</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">user_msg_str</span><span class="p">)</span>

        <span class="c1"># get this again, in case it changed</span>
        <span class="n">agent_name</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;current_agent_name&quot;</span><span class="p">)</span>
        <span class="n">agent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">[</span><span class="n">agent_name</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">AgentInput</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">input_messages</span><span class="p">,</span> <span class="n">current_agent_name</span><span class="o">=</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">user_msg</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ChatMessage</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">chat_history</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">memory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseMemory</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ctx</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Context</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">stepwise</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">checkpoint_callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CheckpointCallback</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_iterations</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WorkflowHandler</span><span class="p">:</span>
        <span class="c1"># Detect if hitl is needed</span>
        <span class="k">if</span> <span class="n">ctx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ctx</span><span class="o">.</span><span class="n">is_running</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                <span class="n">ctx</span><span class="o">=</span><span class="n">ctx</span><span class="p">,</span>
                <span class="n">stepwise</span><span class="o">=</span><span class="n">stepwise</span><span class="p">,</span>
                <span class="n">checkpoint_callback</span><span class="o">=</span><span class="n">checkpoint_callback</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                <span class="n">start_event</span><span class="o">=</span><span class="n">AgentWorkflowStartEvent</span><span class="p">(</span>
                    <span class="n">user_msg</span><span class="o">=</span><span class="n">user_msg</span><span class="p">,</span>
                    <span class="n">chat_history</span><span class="o">=</span><span class="n">chat_history</span><span class="p">,</span>
                    <span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">,</span>
                    <span class="n">max_iterations</span><span class="o">=</span><span class="n">max_iterations</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">ctx</span><span class="o">=</span><span class="n">ctx</span><span class="p">,</span>
                <span class="n">stepwise</span><span class="o">=</span><span class="n">stepwise</span><span class="p">,</span>
                <span class="n">checkpoint_callback</span><span class="o">=</span><span class="n">checkpoint_callback</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_tools_or_functions</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">tools_or_functions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">BaseTool</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]],</span>
        <span class="n">llm</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LLM</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">system_prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">state_prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">BasePromptTemplate</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">initial_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;AgentWorkflow&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes an AgentWorkflow from a list of tools or functions.</span>

<span class="sd">        The workflow will be initialized with a single agent that uses the provided tools or functions.</span>

<span class="sd">        If the LLM is a function calling model, the workflow will use the FunctionAgent.</span>
<span class="sd">        Otherwise, it will use the ReActAgent.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">llm</span> <span class="o">=</span> <span class="n">llm</span> <span class="ow">or</span> <span class="n">Settings</span><span class="o">.</span><span class="n">llm</span>
        <span class="n">agent_cls</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">FunctionAgent</span> <span class="k">if</span> <span class="n">llm</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">is_function_calling_model</span> <span class="k">else</span> <span class="n">ReActAgent</span>
        <span class="p">)</span>

        <span class="n">tools</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">FunctionTool</span><span class="o">.</span><span class="n">from_defaults</span><span class="p">(</span><span class="n">fn</span><span class="o">=</span><span class="n">tool</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">BaseTool</span><span class="p">)</span>
            <span class="k">else</span> <span class="n">tool</span>
            <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">tools_or_functions</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">agents</span><span class="o">=</span><span class="p">[</span>
                <span class="n">agent_cls</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Agent&quot;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;A single agent that uses the provided tools or functions.&quot;</span><span class="p">,</span>
                    <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
                    <span class="n">llm</span><span class="o">=</span><span class="n">llm</span><span class="p">,</span>
                    <span class="n">system_prompt</span><span class="o">=</span><span class="n">system_prompt</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">],</span>
            <span class="n">state_prompt</span><span class="o">=</span><span class="n">state_prompt</span><span class="p">,</span>
            <span class="n">initial_state</span><span class="o">=</span><span class="n">initial_state</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="llama_index.core.agent.workflow.AgentWorkflow.get_tools" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">get_tools</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#llama_index.core.agent.workflow.AgentWorkflow.get_tools" class="headerlink" title="Permanent link">#</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">get_tools</span><span class="p">(</span><span class="n">agent_name</span><span class="p">:</span> <span class="n">str</span><span class="p">,</span> <span class="n">input_str</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="typing.Sequence">Sequence</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.tools.AsyncBaseTool" href="../tools/#llama_index.core.tools.types.AsyncBaseTool">AsyncBaseTool</a></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Get tools for the given agent.</p>

            <details class="quote">
              <summary>Source code in <code>llama_index\core\agent\workflow\multi_agent_workflow.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">get_tools</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">agent_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">input_str</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">AsyncBaseTool</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get tools for the given agent.&quot;&quot;&quot;</span>
    <span class="n">agent_tools</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">[</span><span class="n">agent_name</span><span class="p">]</span><span class="o">.</span><span class="n">tools</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">agent_tools</span><span class="p">]</span>
    <span class="n">retriever</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">[</span><span class="n">agent_name</span><span class="p">]</span><span class="o">.</span><span class="n">tool_retriever</span>
    <span class="k">if</span> <span class="n">retriever</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">retrieved_tools</span> <span class="o">=</span> <span class="k">await</span> <span class="n">retriever</span><span class="o">.</span><span class="n">aretrieve</span><span class="p">(</span><span class="n">input_str</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">tools</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">retrieved_tools</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">[</span><span class="n">agent_name</span><span class="p">]</span><span class="o">.</span><span class="n">can_handoff_to</span>
        <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">[</span><span class="n">agent_name</span><span class="p">]</span><span class="o">.</span><span class="n">can_handoff_to</span> <span class="ow">is</span> <span class="kc">None</span>
    <span class="p">):</span>
        <span class="n">handoff_tool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_handoff_tool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">[</span><span class="n">agent_name</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">handoff_tool</span><span class="p">:</span>
            <span class="n">tools</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">handoff_tool</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_tools_are_async</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">List</span><span class="p">[</span><span class="n">BaseTool</span><span class="p">],</span> <span class="n">tools</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="llama_index.core.agent.workflow.AgentWorkflow.init_run" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">init_run</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#llama_index.core.agent.workflow.AgentWorkflow.init_run" class="headerlink" title="Permanent link">#</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">init_run</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.workflow.Context" href="../workflow/context/#workflows.context.Context">Context</a></span><span class="p">,</span> <span class="n">ev</span><span class="p">:</span> <span class="n"><span title="llama_index.core.agent.workflow.workflow_events.AgentWorkflowStartEvent">AgentWorkflowStartEvent</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.agent.workflow.workflow_events.AgentInput" href="#llama_index.core.agent.workflow.AgentInput">AgentInput</a></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Sets up the workflow and validates inputs.</p>

            <details class="quote">
              <summary>Source code in <code>llama_index\core\agent\workflow\multi_agent_workflow.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@step</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">init_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">ev</span><span class="p">:</span> <span class="n">AgentWorkflowStartEvent</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentInput</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sets up the workflow and validates inputs.&quot;&quot;&quot;</span>
    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_context</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ev</span><span class="p">)</span>

    <span class="n">user_msg</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ChatMessage</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_msg&quot;</span><span class="p">)</span>
    <span class="n">chat_history</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;chat_history&quot;</span><span class="p">,</span> <span class="p">[])</span>

    <span class="c1"># Convert string user_msg to ChatMessage</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">user_msg</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">user_msg</span> <span class="o">=</span> <span class="n">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">user_msg</span><span class="p">)</span>

    <span class="c1"># Add messages to memory</span>
    <span class="n">memory</span><span class="p">:</span> <span class="n">BaseMemory</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;memory&quot;</span><span class="p">)</span>

    <span class="c1"># First set chat history if it exists</span>
    <span class="k">if</span> <span class="n">chat_history</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">memory</span><span class="o">.</span><span class="n">aset</span><span class="p">(</span><span class="n">chat_history</span><span class="p">)</span>

    <span class="c1"># Then add user message if it exists</span>
    <span class="k">if</span> <span class="n">user_msg</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">memory</span><span class="o">.</span><span class="n">aput</span><span class="p">(</span><span class="n">user_msg</span><span class="p">)</span>
        <span class="n">content_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">block</span><span class="o">.</span><span class="n">text</span>
                <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">user_msg</span><span class="o">.</span><span class="n">blocks</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">TextBlock</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;user_msg_str&quot;</span><span class="p">,</span> <span class="n">content_str</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">chat_history</span><span class="p">:</span>
        <span class="c1"># If no user message, use the last message from chat history as user_msg_str</span>
        <span class="n">content_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">block</span><span class="o">.</span><span class="n">text</span>
                <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">chat_history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">blocks</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">TextBlock</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;user_msg_str&quot;</span><span class="p">,</span> <span class="n">content_str</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must provide either user_msg or chat_history&quot;</span><span class="p">)</span>

    <span class="c1"># Get all messages from memory</span>
    <span class="n">input_messages</span> <span class="o">=</span> <span class="k">await</span> <span class="n">memory</span><span class="o">.</span><span class="n">aget</span><span class="p">()</span>

    <span class="c1"># send to the current agent</span>
    <span class="n">current_agent_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;current_agent_name&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">AgentInput</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">input_messages</span><span class="p">,</span> <span class="n">current_agent_name</span><span class="o">=</span><span class="n">current_agent_name</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="llama_index.core.agent.workflow.AgentWorkflow.setup_agent" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">setup_agent</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#llama_index.core.agent.workflow.AgentWorkflow.setup_agent" class="headerlink" title="Permanent link">#</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">setup_agent</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.workflow.Context" href="../workflow/context/#workflows.context.Context">Context</a></span><span class="p">,</span> <span class="n">ev</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.agent.workflow.workflow_events.AgentInput" href="#llama_index.core.agent.workflow.AgentInput">AgentInput</a></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="llama_index.core.agent.workflow.workflow_events.AgentSetup">AgentSetup</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Main agent handling logic.</p>

            <details class="quote">
              <summary>Source code in <code>llama_index\core\agent\workflow\multi_agent_workflow.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@step</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">setup_agent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">ev</span><span class="p">:</span> <span class="n">AgentInput</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentSetup</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Main agent handling logic.&quot;&quot;&quot;</span>
    <span class="n">current_agent_name</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">current_agent_name</span>
    <span class="n">agent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">[</span><span class="n">current_agent_name</span><span class="p">]</span>
    <span class="n">llm_input</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">ev</span><span class="o">.</span><span class="n">input</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">system_prompt</span><span class="p">:</span>
        <span class="n">llm_input</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">agent</span><span class="o">.</span><span class="n">system_prompt</span><span class="p">),</span>
            <span class="o">*</span><span class="n">llm_input</span><span class="p">,</span>
        <span class="p">]</span>

    <span class="n">state</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">formatted_input_with_state</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s2">&quot;formatted_input_with_state&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">state</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">formatted_input_with_state</span><span class="p">:</span>
        <span class="c1"># update last message with current state</span>
        <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">llm_input</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">blocks</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">TextBlock</span><span class="p">):</span>
                <span class="n">block</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_prompt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">block</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;formatted_input_with_state&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">AgentSetup</span><span class="p">(</span>
        <span class="nb">input</span><span class="o">=</span><span class="n">llm_input</span><span class="p">,</span>
        <span class="n">current_agent_name</span><span class="o">=</span><span class="n">ev</span><span class="o">.</span><span class="n">current_agent_name</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="llama_index.core.agent.workflow.AgentWorkflow.run_agent_step" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">run_agent_step</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#llama_index.core.agent.workflow.AgentWorkflow.run_agent_step" class="headerlink" title="Permanent link">#</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">run_agent_step</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.workflow.Context" href="../workflow/context/#workflows.context.Context">Context</a></span><span class="p">,</span> <span class="n">ev</span><span class="p">:</span> <span class="n"><span title="llama_index.core.agent.workflow.workflow_events.AgentSetup">AgentSetup</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.agent.workflow.workflow_events.AgentOutput" href="#llama_index.core.agent.workflow.AgentOutput">AgentOutput</a></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Run the agent.</p>

            <details class="quote">
              <summary>Source code in <code>llama_index\core\agent\workflow\multi_agent_workflow.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@step</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">run_agent_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">ev</span><span class="p">:</span> <span class="n">AgentSetup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentOutput</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run the agent.&quot;&quot;&quot;</span>
    <span class="n">memory</span><span class="p">:</span> <span class="n">BaseMemory</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;memory&quot;</span><span class="p">)</span>
    <span class="n">agent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">[</span><span class="n">ev</span><span class="o">.</span><span class="n">current_agent_name</span><span class="p">]</span>
    <span class="n">user_msg_str</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_msg_str&quot;</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tools</span><span class="p">(</span><span class="n">ev</span><span class="o">.</span><span class="n">current_agent_name</span><span class="p">,</span> <span class="n">user_msg_str</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="n">agent_output</span> <span class="o">=</span> <span class="k">await</span> <span class="n">agent</span><span class="o">.</span><span class="n">take_step</span><span class="p">(</span>
        <span class="n">ctx</span><span class="p">,</span>
        <span class="n">ev</span><span class="o">.</span><span class="n">input</span><span class="p">,</span>
        <span class="n">tools</span><span class="p">,</span>
        <span class="n">memory</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">ctx</span><span class="o">.</span><span class="n">write_event_to_stream</span><span class="p">(</span><span class="n">agent_output</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">agent_output</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="llama_index.core.agent.workflow.AgentWorkflow.call_tool" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">call_tool</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#llama_index.core.agent.workflow.AgentWorkflow.call_tool" class="headerlink" title="Permanent link">#</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">call_tool</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.workflow.Context" href="../workflow/context/#workflows.context.Context">Context</a></span><span class="p">,</span> <span class="n">ev</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.agent.workflow.workflow_events.ToolCall" href="#llama_index.core.agent.workflow.ToolCall">ToolCall</a></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.agent.workflow.workflow_events.ToolCallResult" href="#llama_index.core.agent.workflow.ToolCallResult">ToolCallResult</a></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Calls the tool and handles the result.</p>

            <details class="quote">
              <summary>Source code in <code>llama_index\core\agent\workflow\multi_agent_workflow.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@step</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">call_tool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">ev</span><span class="p">:</span> <span class="n">ToolCall</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ToolCallResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calls the tool and handles the result.&quot;&quot;&quot;</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">write_event_to_stream</span><span class="p">(</span>
        <span class="n">ToolCall</span><span class="p">(</span>
            <span class="n">tool_name</span><span class="o">=</span><span class="n">ev</span><span class="o">.</span><span class="n">tool_name</span><span class="p">,</span>
            <span class="n">tool_kwargs</span><span class="o">=</span><span class="n">ev</span><span class="o">.</span><span class="n">tool_kwargs</span><span class="p">,</span>
            <span class="n">tool_id</span><span class="o">=</span><span class="n">ev</span><span class="o">.</span><span class="n">tool_id</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="n">current_agent_name</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;current_agent_name&quot;</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tools</span><span class="p">(</span><span class="n">current_agent_name</span><span class="p">,</span> <span class="n">ev</span><span class="o">.</span><span class="n">tool_name</span><span class="p">)</span>
    <span class="n">tools_by_name</span> <span class="o">=</span> <span class="p">{</span><span class="n">tool</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">tool</span> <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">ev</span><span class="o">.</span><span class="n">tool_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tools_by_name</span><span class="p">:</span>
        <span class="n">tool</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">ToolOutput</span><span class="p">(</span>
            <span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Tool </span><span class="si">{</span><span class="n">ev</span><span class="o">.</span><span class="n">tool_name</span><span class="si">}</span><span class="s2"> not found. Please select a tool that is available.&quot;</span><span class="p">,</span>
            <span class="n">tool_name</span><span class="o">=</span><span class="n">ev</span><span class="o">.</span><span class="n">tool_name</span><span class="p">,</span>
            <span class="n">raw_input</span><span class="o">=</span><span class="n">ev</span><span class="o">.</span><span class="n">tool_kwargs</span><span class="p">,</span>
            <span class="n">raw_output</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">is_error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tool</span> <span class="o">=</span> <span class="n">tools_by_name</span><span class="p">[</span><span class="n">ev</span><span class="o">.</span><span class="n">tool_name</span><span class="p">]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_tool</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">tool</span><span class="p">,</span> <span class="n">ev</span><span class="o">.</span><span class="n">tool_kwargs</span><span class="p">)</span>

    <span class="n">result_ev</span> <span class="o">=</span> <span class="n">ToolCallResult</span><span class="p">(</span>
        <span class="n">tool_name</span><span class="o">=</span><span class="n">ev</span><span class="o">.</span><span class="n">tool_name</span><span class="p">,</span>
        <span class="n">tool_kwargs</span><span class="o">=</span><span class="n">ev</span><span class="o">.</span><span class="n">tool_kwargs</span><span class="p">,</span>
        <span class="n">tool_id</span><span class="o">=</span><span class="n">ev</span><span class="o">.</span><span class="n">tool_id</span><span class="p">,</span>
        <span class="n">tool_output</span><span class="o">=</span><span class="n">result</span><span class="p">,</span>
        <span class="n">return_direct</span><span class="o">=</span><span class="n">tool</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">return_direct</span> <span class="k">if</span> <span class="n">tool</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">ctx</span><span class="o">.</span><span class="n">write_event_to_stream</span><span class="p">(</span><span class="n">result_ev</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result_ev</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="llama_index.core.agent.workflow.AgentWorkflow.aggregate_tool_results" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">aggregate_tool_results</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#llama_index.core.agent.workflow.AgentWorkflow.aggregate_tool_results" class="headerlink" title="Permanent link">#</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">aggregate_tool_results</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.workflow.Context" href="../workflow/context/#workflows.context.Context">Context</a></span><span class="p">,</span> <span class="n">ev</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.agent.workflow.workflow_events.ToolCallResult" href="#llama_index.core.agent.workflow.ToolCallResult">ToolCallResult</a></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="typing.Union">Union</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.agent.workflow.workflow_events.AgentInput" href="#llama_index.core.agent.workflow.AgentInput">AgentInput</a></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.workflow.StopEvent" href="../workflow/events/#workflows.events.StopEvent">StopEvent</a></span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Aggregate tool results and return the next agent input.</p>

            <details class="quote">
              <summary>Source code in <code>llama_index\core\agent\workflow\multi_agent_workflow.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@step</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">aggregate_tool_results</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">ev</span><span class="p">:</span> <span class="n">ToolCallResult</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">AgentInput</span><span class="p">,</span> <span class="n">StopEvent</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Aggregate tool results and return the next agent input.&quot;&quot;&quot;</span>
    <span class="n">num_tool_calls</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;num_tool_calls&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num_tool_calls</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No tool calls found, cannot aggregate results.&quot;</span><span class="p">)</span>

    <span class="n">tool_call_results</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ToolCallResult</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">collect_events</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
        <span class="n">ev</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="p">[</span><span class="n">ToolCallResult</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_tool_calls</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">tool_call_results</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">memory</span><span class="p">:</span> <span class="n">BaseMemory</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;memory&quot;</span><span class="p">)</span>
    <span class="n">agent_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;current_agent_name&quot;</span><span class="p">)</span>
    <span class="n">agent</span><span class="p">:</span> <span class="n">BaseWorkflowAgent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">[</span><span class="n">agent_name</span><span class="p">]</span>

    <span class="c1"># track tool calls made during a .run() call</span>
    <span class="n">cur_tool_calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolCallResult</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s2">&quot;current_tool_calls&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[]</span>
    <span class="p">)</span>
    <span class="n">cur_tool_calls</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tool_call_results</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;current_tool_calls&quot;</span><span class="p">,</span> <span class="n">cur_tool_calls</span><span class="p">)</span>

    <span class="k">await</span> <span class="n">agent</span><span class="o">.</span><span class="n">handle_tool_call_results</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">tool_call_results</span><span class="p">,</span> <span class="n">memory</span><span class="p">)</span>

    <span class="c1"># set the next agent, if needed</span>
    <span class="c1"># the handoff tool sets this</span>
    <span class="n">next_agent_name</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;next_agent&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">next_agent_name</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;current_agent_name&quot;</span><span class="p">,</span> <span class="n">next_agent_name</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;next_agent&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
        <span class="n">tool_call_result</span><span class="o">.</span><span class="n">return_direct</span> <span class="k">for</span> <span class="n">tool_call_result</span> <span class="ow">in</span> <span class="n">tool_call_results</span>
    <span class="p">):</span>
        <span class="c1"># if any tool calls return directly, take the first one</span>
        <span class="n">return_direct_tool</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
            <span class="n">tool_call_result</span>
            <span class="k">for</span> <span class="n">tool_call_result</span> <span class="ow">in</span> <span class="n">tool_call_results</span>
            <span class="k">if</span> <span class="n">tool_call_result</span><span class="o">.</span><span class="n">return_direct</span>
        <span class="p">)</span>

        <span class="c1"># always finalize the agent, even if we&#39;re just handing off</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">AgentOutput</span><span class="p">(</span>
            <span class="n">response</span><span class="o">=</span><span class="n">ChatMessage</span><span class="p">(</span>
                <span class="n">role</span><span class="o">=</span><span class="s2">&quot;assistant&quot;</span><span class="p">,</span>
                <span class="n">content</span><span class="o">=</span><span class="n">return_direct_tool</span><span class="o">.</span><span class="n">tool_output</span><span class="o">.</span><span class="n">content</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">tool_calls</span><span class="o">=</span><span class="p">[</span>
                <span class="n">ToolSelection</span><span class="p">(</span>
                    <span class="n">tool_id</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">tool_id</span><span class="p">,</span>
                    <span class="n">tool_name</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">tool_name</span><span class="p">,</span>
                    <span class="n">tool_kwargs</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">tool_kwargs</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">cur_tool_calls</span>
            <span class="p">],</span>
            <span class="n">raw</span><span class="o">=</span><span class="n">return_direct_tool</span><span class="o">.</span><span class="n">tool_output</span><span class="o">.</span><span class="n">raw_output</span><span class="p">,</span>
            <span class="n">current_agent_name</span><span class="o">=</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">agent</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">memory</span><span class="p">)</span>

        <span class="c1"># we don&#39;t want to stop the system if we&#39;re just handing off</span>
        <span class="k">if</span> <span class="n">return_direct_tool</span><span class="o">.</span><span class="n">tool_name</span> <span class="o">!=</span> <span class="s2">&quot;handoff&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;current_tool_calls&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">return</span> <span class="n">StopEvent</span><span class="p">(</span><span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>

    <span class="n">user_msg_str</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_msg_str&quot;</span><span class="p">)</span>
    <span class="n">input_messages</span> <span class="o">=</span> <span class="k">await</span> <span class="n">memory</span><span class="o">.</span><span class="n">aget</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">user_msg_str</span><span class="p">)</span>

    <span class="c1"># get this again, in case it changed</span>
    <span class="n">agent_name</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;current_agent_name&quot;</span><span class="p">)</span>
    <span class="n">agent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">[</span><span class="n">agent_name</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">AgentInput</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">input_messages</span><span class="p">,</span> <span class="n">current_agent_name</span><span class="o">=</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="llama_index.core.agent.workflow.AgentWorkflow.from_tools_or_functions" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">from_tools_or_functions</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#llama_index.core.agent.workflow.AgentWorkflow.from_tools_or_functions" class="headerlink" title="Permanent link">#</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">from_tools_or_functions</span><span class="p">(</span><span class="n">tools_or_functions</span><span class="p">:</span> <span class="n"><span title="typing.List">List</span></span><span class="p">[</span><span class="n"><span title="typing.Union">Union</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.tools.BaseTool" href="../tools/#llama_index.core.tools.types.BaseTool">BaseTool</a></span><span class="p">,</span> <span class="n"><span title="typing.Callable">Callable</span></span><span class="p">]],</span> <span class="n">llm</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.llms.llm.LLM" href="../llms/#llama_index.core.llms.llm.LLM">LLM</a></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">system_prompt</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">state_prompt</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="typing.Union">Union</span></span><span class="p">[</span><span class="n">str</span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.prompts.BasePromptTemplate" href="../prompts/#llama_index.core.prompts.BasePromptTemplate">BasePromptTemplate</a></span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">initial_state</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.agent.workflow.multi_agent_workflow.AgentWorkflow" href="#llama_index.core.agent.workflow.AgentWorkflow">AgentWorkflow</a></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Initializes an AgentWorkflow from a list of tools or functions.</p>
<p>The workflow will be initialized with a single agent that uses the provided tools or functions.</p>
<p>If the LLM is a function calling model, the workflow will use the FunctionAgent.
Otherwise, it will use the ReActAgent.</p>

            <details class="quote">
              <summary>Source code in <code>llama_index\core\agent\workflow\multi_agent_workflow.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">from_tools_or_functions</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span>
    <span class="n">tools_or_functions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">BaseTool</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]],</span>
    <span class="n">llm</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LLM</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">system_prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">state_prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">BasePromptTemplate</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">initial_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;AgentWorkflow&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initializes an AgentWorkflow from a list of tools or functions.</span>

<span class="sd">    The workflow will be initialized with a single agent that uses the provided tools or functions.</span>

<span class="sd">    If the LLM is a function calling model, the workflow will use the FunctionAgent.</span>
<span class="sd">    Otherwise, it will use the ReActAgent.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">llm</span> <span class="o">=</span> <span class="n">llm</span> <span class="ow">or</span> <span class="n">Settings</span><span class="o">.</span><span class="n">llm</span>
    <span class="n">agent_cls</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">FunctionAgent</span> <span class="k">if</span> <span class="n">llm</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">is_function_calling_model</span> <span class="k">else</span> <span class="n">ReActAgent</span>
    <span class="p">)</span>

    <span class="n">tools</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">FunctionTool</span><span class="o">.</span><span class="n">from_defaults</span><span class="p">(</span><span class="n">fn</span><span class="o">=</span><span class="n">tool</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">BaseTool</span><span class="p">)</span>
        <span class="k">else</span> <span class="n">tool</span>
        <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">tools_or_functions</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
        <span class="n">agents</span><span class="o">=</span><span class="p">[</span>
            <span class="n">agent_cls</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Agent&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;A single agent that uses the provided tools or functions.&quot;</span><span class="p">,</span>
                <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
                <span class="n">llm</span><span class="o">=</span><span class="n">llm</span><span class="p">,</span>
                <span class="n">system_prompt</span><span class="o">=</span><span class="n">system_prompt</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">],</span>
        <span class="n">state_prompt</span><span class="o">=</span><span class="n">state_prompt</span><span class="p">,</span>
        <span class="n">initial_state</span><span class="o">=</span><span class="n">initial_state</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="llama_index.core.agent.workflow.BaseWorkflowAgent" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">BaseWorkflowAgent</span>


<a href="#llama_index.core.agent.workflow.BaseWorkflowAgent" class="headerlink" title="Permanent link">#</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="llama_index.core.workflow.workflow.Workflow" href="../workflow/workflow/#workflows.workflow.Workflow">Workflow</a></code>, <code><span title="llama_index.core.bridge.pydantic.BaseModel">BaseModel</span></code>, <code><span title="llama_index.core.prompts.mixin.PromptMixin">PromptMixin</span></code></p>


        <p>Base class for all agents, combining config and logic.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>name</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the agent</p>
              </div>
            </td>
            <td>
                  <code>&#39;Agent&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>description</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The description of what the agent does and is responsible for</p>
              </div>
            </td>
            <td>
                  <code>&#39;An agent that can perform a task&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>system_prompt</code>
            </td>
            <td>
                  <code>str | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The system prompt for the agent</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tools</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="typing.Union">Union</span>[<a class="autorefs autorefs-internal" title="llama_index.core.tools.BaseTool" href="../tools/#llama_index.core.tools.types.BaseTool">BaseTool</a>, <span title="typing.Callable">Callable</span>]] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The tools that the agent can use</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tool_retriever</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="llama_index.core.objects.ObjectRetriever" href="../objects/#llama_index.core.objects.ObjectRetriever">ObjectRetriever</a> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The tool retriever for the agent, can be provided instead of tools</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>can_handoff_to</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[str] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The agent names that this agent can hand off to</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>llm</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="llama_index.core.llms.LLM" href="../llms/#llama_index.core.llms.llm.LLM">LLM</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The LLM that the agent uses</p>
              </div>
            </td>
            <td>
                  <code>OpenAI(callback_manager=&lt;llama_index.core.callbacks.base.CallbackManager object at 0x0000022D4AF73EF0&gt;, system_prompt=None, messages_to_prompt=&lt;function messages_to_prompt at 0x0000022D478E5EE0&gt;, completion_to_prompt=&lt;function default_completion_to_prompt at 0x0000022D479794E0&gt;, output_parser=None, pydantic_program_mode=&lt;PydanticProgramMode.DEFAULT: &#39;default&#39;&gt;, query_wrapper_prompt=None, model=&#39;gpt-3.5-turbo&#39;, temperature=0.1, max_tokens=None, logprobs=None, top_logprobs=0, additional_kwargs={}, max_retries=3, timeout=60.0, default_headers=None, reuse_client=True, api_key=&#39;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&#39;, api_base=&#39;https://api.openai.com/v1&#39;, api_version=&#39;&#39;, strict=False, reasoning_effort=None, modalities=None, audio_config=None)</code>
            </td>
          </tr>
      </tbody>
    </table>






              <details class="quote">
                <summary>Source code in <code>llama_index\core\agent\workflow\base_agent.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">BaseWorkflowAgent</span><span class="p">(</span>
    <span class="n">Workflow</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">PromptMixin</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">BaseWorkflowAgentMeta</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for all agents, combining config and logic.&quot;&quot;&quot;</span>

    <span class="n">model_config</span> <span class="o">=</span> <span class="n">ConfigDict</span><span class="p">(</span><span class="n">arbitrary_types_allowed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_AGENT_NAME</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The name of the agent&quot;</span><span class="p">)</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_AGENT_DESCRIPTION</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The description of what the agent does and is responsible for&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">system_prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The system prompt for the agent&quot;</span>
    <span class="p">)</span>
    <span class="n">tools</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">BaseTool</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The tools that the agent can use&quot;</span>
    <span class="p">)</span>
    <span class="n">tool_retriever</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ObjectRetriever</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The tool retriever for the agent, can be provided instead of tools&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">can_handoff_to</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The agent names that this agent can hand off to&quot;</span>
    <span class="p">)</span>
    <span class="n">llm</span><span class="p">:</span> <span class="n">LLM</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="n">get_default_llm</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The LLM that the agent uses&quot;</span>
    <span class="p">)</span>
    <span class="n">initial_state</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The initial state of the agent, can be used by accessed under `await ctx.store.get(&#39;state&#39;)`&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">state_prompt</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">BasePromptTemplate</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_STATE_PROMPT</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The prompt to use to update the state of the agent&quot;</span><span class="p">,</span>
        <span class="n">validate_default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">output_cls</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Output class for the agent. If you set this field to a non-null value, `structured_output_fn` will be ignored.&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">exclude</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">structured_output_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Field</span><span class="p">(</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Custom function to generate structured output from the agent&#39;s run. It has to take a list of ChatMessage instances (derived from the memory) and output a BaseModel subclass instance. If you set `output_cls` to a non-null value, this field will be ignored.&quot;</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">DEFAULT_AGENT_NAME</span><span class="p">,</span>
        <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">DEFAULT_AGENT_DESCRIPTION</span><span class="p">,</span>
        <span class="n">system_prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tools</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">BaseTool</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tool_retriever</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ObjectRetriever</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">can_handoff_to</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">llm</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LLM</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">initial_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">state_prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">BasePromptTemplate</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">output_cls</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">structured_output_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]],</span> <span class="n">BaseModel</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># Filter out workflow-specific kwargs</span>
        <span class="n">workflow_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">WORKFLOW_KWARGS</span><span class="p">}</span>
        <span class="n">model_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">WORKFLOW_KWARGS</span><span class="p">}</span>

        <span class="c1"># Initialize BaseModel with the Pydantic fields</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state_prompt</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">state_prompt</span> <span class="o">=</span> <span class="n">PromptTemplate</span><span class="p">(</span><span class="n">state_prompt</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">state_prompt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">state_prompt</span> <span class="o">=</span> <span class="n">DEFAULT_STATE_PROMPT</span>

        <span class="k">if</span> <span class="n">output_cls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">structured_output_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">structured_output_fn</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">BaseModel</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
            <span class="n">system_prompt</span><span class="o">=</span><span class="n">system_prompt</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="n">tool_retriever</span><span class="o">=</span><span class="n">tool_retriever</span><span class="p">,</span>
            <span class="n">can_handoff_to</span><span class="o">=</span><span class="n">can_handoff_to</span><span class="p">,</span>
            <span class="n">llm</span><span class="o">=</span><span class="n">llm</span> <span class="ow">or</span> <span class="n">get_default_llm</span><span class="p">(),</span>
            <span class="n">initial_state</span><span class="o">=</span><span class="n">initial_state</span> <span class="ow">or</span> <span class="p">{},</span>
            <span class="n">state_prompt</span><span class="o">=</span><span class="n">state_prompt</span><span class="p">,</span>
            <span class="n">output_cls</span><span class="o">=</span><span class="n">output_cls</span><span class="p">,</span>
            <span class="n">structured_output_fn</span><span class="o">=</span><span class="n">structured_output_fn</span><span class="p">,</span>
            <span class="o">**</span><span class="n">model_kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Initialize Workflow with workflow-specific parameters</span>
        <span class="n">Workflow</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="o">**</span><span class="n">workflow_kwargs</span><span class="p">)</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;tools&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;before&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">validate_tools</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">BaseTool</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">BaseTool</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate tools.</span>

<span class="sd">        If tools are not of type BaseTool, they will be converted to FunctionTools.</span>
<span class="sd">        This assumes the inputs are tools or callable functions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">validated_tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">BaseTool</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">BaseTool</span><span class="p">):</span>
                <span class="n">validated_tools</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">FunctionTool</span><span class="o">.</span><span class="n">from_defaults</span><span class="p">(</span><span class="n">tool</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">validated_tools</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tool</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">validated_tools</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tool</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;handoff&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;&#39;handoff&#39; is a reserved tool name. Please use a different name.&quot;</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">validated_tools</span>  <span class="c1"># type: ignore[return-value]</span>

    <span class="k">def</span> <span class="nf">_get_prompts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PromptDictType</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get prompts.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_get_prompt_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PromptMixinType</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get prompt sub-modules.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_update_prompts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompts_dict</span><span class="p">:</span> <span class="n">PromptDictType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update prompts.&quot;&quot;&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">take_step</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span>
        <span class="n">llm_input</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span>
        <span class="n">tools</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">AsyncBaseTool</span><span class="p">],</span>
        <span class="n">memory</span><span class="p">:</span> <span class="n">BaseMemory</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentOutput</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Take a single step with the agent.&quot;&quot;&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">handle_tool_call_results</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolCallResult</span><span class="p">],</span> <span class="n">memory</span><span class="p">:</span> <span class="n">BaseMemory</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle tool call results.&quot;&quot;&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">finalize</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">AgentOutput</span><span class="p">,</span> <span class="n">memory</span><span class="p">:</span> <span class="n">BaseMemory</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentOutput</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Finalize the agent&#39;s execution.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_ensure_tools_are_async</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">BaseTool</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">AsyncBaseTool</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure all tools are async.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">adapt_to_async_tool</span><span class="p">(</span><span class="n">tool</span><span class="p">)</span> <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">]</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_tools</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">input_str</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">AsyncBaseTool</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get tools for the given agent.&quot;&quot;&quot;</span>
        <span class="n">tools</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tool_retriever</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">retrieved_tools</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">tool_retriever</span><span class="o">.</span><span class="n">aretrieve</span><span class="p">(</span><span class="n">input_str</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">tools</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">retrieved_tools</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_tools_are_async</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">List</span><span class="p">[</span><span class="n">BaseTool</span><span class="p">],</span> <span class="n">tools</span><span class="p">))</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_init_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">ev</span><span class="p">:</span> <span class="n">AgentWorkflowStartEvent</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the context once, if needed.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;memory&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="n">default_memory</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;memory&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">default_memory</span> <span class="o">=</span> <span class="n">default_memory</span> <span class="ow">or</span> <span class="n">ChatMemoryBuffer</span><span class="o">.</span><span class="n">from_defaults</span><span class="p">(</span>
                <span class="n">llm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">llm</span> <span class="ow">or</span> <span class="n">Settings</span><span class="o">.</span><span class="n">llm</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;memory&quot;</span><span class="p">,</span> <span class="n">default_memory</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_state</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_iterations&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="n">max_iterations</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">ev</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_iterations&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">DEFAULT_MAX_ITERATIONS</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;max_iterations&quot;</span><span class="p">,</span> <span class="n">max_iterations</span><span class="p">)</span>

        <span class="c1"># Reset the number of iterations</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;num_iterations&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># always set to false initially</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;formatted_input_with_state&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_call_tool</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span>
        <span class="n">tool</span><span class="p">:</span> <span class="n">AsyncBaseTool</span><span class="p">,</span>
        <span class="n">tool_input</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ToolOutput</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Call the given tool with the given input.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">FunctionTool</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">tool</span><span class="o">.</span><span class="n">requires_context</span>
                <span class="ow">and</span> <span class="n">tool</span><span class="o">.</span><span class="n">ctx_param_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="p">):</span>
                <span class="n">new_tool_input</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">tool_input</span><span class="p">}</span>
                <span class="n">new_tool_input</span><span class="p">[</span><span class="n">tool</span><span class="o">.</span><span class="n">ctx_param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctx</span>
                <span class="n">tool_output</span> <span class="o">=</span> <span class="k">await</span> <span class="n">tool</span><span class="o">.</span><span class="n">acall</span><span class="p">(</span><span class="o">**</span><span class="n">new_tool_input</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tool_output</span> <span class="o">=</span> <span class="k">await</span> <span class="n">tool</span><span class="o">.</span><span class="n">acall</span><span class="p">(</span><span class="o">**</span><span class="n">tool_input</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">tool_output</span> <span class="o">=</span> <span class="n">ToolOutput</span><span class="p">(</span>
                <span class="n">content</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                <span class="n">tool_name</span><span class="o">=</span><span class="n">tool</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span>
                <span class="n">raw_input</span><span class="o">=</span><span class="n">tool_input</span><span class="p">,</span>
                <span class="n">raw_output</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                <span class="n">is_error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">tool_output</span>

    <span class="nd">@step</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">init_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">ev</span><span class="p">:</span> <span class="n">AgentWorkflowStartEvent</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentInput</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets up the workflow and validates inputs.&quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_context</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ev</span><span class="p">)</span>

        <span class="n">user_msg</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ChatMessage</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_msg&quot;</span><span class="p">)</span>
        <span class="n">chat_history</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;chat_history&quot;</span><span class="p">,</span> <span class="p">[])</span>

        <span class="c1"># Convert string user_msg to ChatMessage</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">user_msg</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">user_msg</span> <span class="o">=</span> <span class="n">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">user_msg</span><span class="p">)</span>

        <span class="c1"># Add messages to memory</span>
        <span class="n">memory</span><span class="p">:</span> <span class="n">BaseMemory</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;memory&quot;</span><span class="p">)</span>

        <span class="c1"># First set chat history if it exists</span>
        <span class="k">if</span> <span class="n">chat_history</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">memory</span><span class="o">.</span><span class="n">aset</span><span class="p">(</span><span class="n">chat_history</span><span class="p">)</span>

        <span class="c1"># Then add user message if it exists</span>
        <span class="k">if</span> <span class="n">user_msg</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">memory</span><span class="o">.</span><span class="n">aput</span><span class="p">(</span><span class="n">user_msg</span><span class="p">)</span>
            <span class="n">content_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">block</span><span class="o">.</span><span class="n">text</span>
                    <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">user_msg</span><span class="o">.</span><span class="n">blocks</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">TextBlock</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;user_msg_str&quot;</span><span class="p">,</span> <span class="n">content_str</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">chat_history</span><span class="p">:</span>
            <span class="c1"># If no user message, use the last message from chat history as user_msg_str</span>
            <span class="n">content_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">block</span><span class="o">.</span><span class="n">text</span>
                    <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">chat_history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">blocks</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">TextBlock</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;user_msg_str&quot;</span><span class="p">,</span> <span class="n">content_str</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must provide either user_msg or chat_history&quot;</span><span class="p">)</span>

        <span class="c1"># Get all messages from memory</span>
        <span class="n">input_messages</span> <span class="o">=</span> <span class="k">await</span> <span class="n">memory</span><span class="o">.</span><span class="n">aget</span><span class="p">()</span>

        <span class="c1"># send to the current agent</span>
        <span class="k">return</span> <span class="n">AgentInput</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">input_messages</span><span class="p">,</span> <span class="n">current_agent_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="nd">@step</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">setup_agent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">ev</span><span class="p">:</span> <span class="n">AgentInput</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentSetup</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Main agent handling logic.&quot;&quot;&quot;</span>
        <span class="n">llm_input</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">ev</span><span class="o">.</span><span class="n">input</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span><span class="p">:</span>
            <span class="n">llm_input</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span><span class="p">),</span>
                <span class="o">*</span><span class="n">llm_input</span><span class="p">,</span>
            <span class="p">]</span>

        <span class="n">state</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">formatted_input_with_state</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;formatted_input_with_state&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">state</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">formatted_input_with_state</span><span class="p">:</span>
            <span class="c1"># update last message with current state</span>
            <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">llm_input</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">blocks</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">TextBlock</span><span class="p">):</span>
                    <span class="n">block</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_prompt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">block</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;formatted_input_with_state&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">AgentSetup</span><span class="p">(</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">llm_input</span><span class="p">,</span>
            <span class="n">current_agent_name</span><span class="o">=</span><span class="n">ev</span><span class="o">.</span><span class="n">current_agent_name</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@step</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">run_agent_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">ev</span><span class="p">:</span> <span class="n">AgentSetup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentOutput</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the agent.&quot;&quot;&quot;</span>
        <span class="n">memory</span><span class="p">:</span> <span class="n">BaseMemory</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;memory&quot;</span><span class="p">)</span>
        <span class="n">user_msg_str</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_msg_str&quot;</span><span class="p">)</span>
        <span class="n">tools</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tools</span><span class="p">(</span><span class="n">user_msg_str</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">agent_output</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">take_step</span><span class="p">(</span>
            <span class="n">ctx</span><span class="p">,</span>
            <span class="n">ev</span><span class="o">.</span><span class="n">input</span><span class="p">,</span>
            <span class="n">tools</span><span class="p">,</span>
            <span class="n">memory</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">ctx</span><span class="o">.</span><span class="n">write_event_to_stream</span><span class="p">(</span><span class="n">agent_output</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">agent_output</span>

    <span class="nd">@step</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">parse_agent_output</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">ev</span><span class="p">:</span> <span class="n">AgentOutput</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">StopEvent</span><span class="p">,</span> <span class="n">AgentInput</span><span class="p">,</span> <span class="n">ToolCall</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="n">max_iterations</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;max_iterations&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_MAX_ITERATIONS</span>
        <span class="p">)</span>
        <span class="n">num_iterations</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;num_iterations&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">num_iterations</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;num_iterations&quot;</span><span class="p">,</span> <span class="n">num_iterations</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">num_iterations</span> <span class="o">&gt;=</span> <span class="n">max_iterations</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">WorkflowRuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Max iterations of </span><span class="si">{</span><span class="n">max_iterations</span><span class="si">}</span><span class="s2"> reached! Either something went wrong, or you can &quot;</span>
                <span class="s2">&quot;increase the max iterations with `.run(.., max_iterations=...)`&quot;</span>
            <span class="p">)</span>

        <span class="n">memory</span><span class="p">:</span> <span class="n">BaseMemory</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;memory&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ev</span><span class="o">.</span><span class="n">retry_messages</span><span class="p">:</span>
            <span class="c1"># Retry with the given messages to let the LLM fix potential errors</span>
            <span class="n">history</span> <span class="o">=</span> <span class="k">await</span> <span class="n">memory</span><span class="o">.</span><span class="n">aget</span><span class="p">()</span>
            <span class="n">user_msg_str</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_msg_str&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">AgentInput</span><span class="p">(</span>
                <span class="nb">input</span><span class="o">=</span><span class="p">[</span>
                    <span class="o">*</span><span class="n">history</span><span class="p">,</span>
                    <span class="n">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">user_msg_str</span><span class="p">),</span>
                    <span class="o">*</span><span class="n">ev</span><span class="o">.</span><span class="n">retry_messages</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="n">current_agent_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ev</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="n">memory</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;memory&quot;</span><span class="p">)</span>
            <span class="n">messages</span> <span class="o">=</span> <span class="k">await</span> <span class="n">memory</span><span class="o">.</span><span class="n">aget</span><span class="p">()</span>
            <span class="n">output</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">memory</span><span class="p">)</span>
            <span class="n">cur_tool_calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolCallResult</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;current_tool_calls&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[]</span>
            <span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">tool_calls</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cur_tool_calls</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">structured_output_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">iscoroutinefunction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structured_output_fn</span><span class="p">):</span>
                        <span class="n">output</span><span class="o">.</span><span class="n">structured_response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">structured_output_fn</span><span class="p">(</span>
                            <span class="n">messages</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">output</span><span class="o">.</span><span class="n">structured_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structured_output_fn</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;An error occurred while producing the structured output from your agent: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">.&quot;</span>
                    <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_cls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">xml_message</span> <span class="o">=</span> <span class="n">messages_to_xml_format</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
                    <span class="n">structured_response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">as_structured_llm</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">output_cls</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">achat</span><span class="p">(</span><span class="n">messages</span><span class="o">=</span><span class="p">[</span><span class="n">xml_message</span><span class="p">],</span> <span class="n">tool_required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">structured_response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span>
                        <span class="n">structured_response</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;An error occurred while producing the structured output from your agent: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">.&quot;</span>
                    <span class="p">)</span>

            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;current_tool_calls&quot;</span><span class="p">,</span> <span class="p">[])</span>

            <span class="k">return</span> <span class="n">StopEvent</span><span class="p">(</span><span class="n">result</span><span class="o">=</span><span class="n">output</span><span class="p">)</span>

        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;num_tool_calls&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ev</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">tool_call</span> <span class="ow">in</span> <span class="n">ev</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">send_event</span><span class="p">(</span>
                <span class="n">ToolCall</span><span class="p">(</span>
                    <span class="n">tool_name</span><span class="o">=</span><span class="n">tool_call</span><span class="o">.</span><span class="n">tool_name</span><span class="p">,</span>
                    <span class="n">tool_kwargs</span><span class="o">=</span><span class="n">tool_call</span><span class="o">.</span><span class="n">tool_kwargs</span><span class="p">,</span>
                    <span class="n">tool_id</span><span class="o">=</span><span class="n">tool_call</span><span class="o">.</span><span class="n">tool_id</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@step</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">call_tool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">ev</span><span class="p">:</span> <span class="n">ToolCall</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ToolCallResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calls the tool and handles the result.&quot;&quot;&quot;</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">write_event_to_stream</span><span class="p">(</span>
            <span class="n">ToolCall</span><span class="p">(</span>
                <span class="n">tool_name</span><span class="o">=</span><span class="n">ev</span><span class="o">.</span><span class="n">tool_name</span><span class="p">,</span>
                <span class="n">tool_kwargs</span><span class="o">=</span><span class="n">ev</span><span class="o">.</span><span class="n">tool_kwargs</span><span class="p">,</span>
                <span class="n">tool_id</span><span class="o">=</span><span class="n">ev</span><span class="o">.</span><span class="n">tool_id</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">tools</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tools</span><span class="p">(</span><span class="n">ev</span><span class="o">.</span><span class="n">tool_name</span><span class="p">)</span>
        <span class="n">tools_by_name</span> <span class="o">=</span> <span class="p">{</span><span class="n">tool</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">tool</span> <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">ev</span><span class="o">.</span><span class="n">tool_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tools_by_name</span><span class="p">:</span>
            <span class="n">tool</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">ToolOutput</span><span class="p">(</span>
                <span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Tool </span><span class="si">{</span><span class="n">ev</span><span class="o">.</span><span class="n">tool_name</span><span class="si">}</span><span class="s2"> not found. Please select a tool that is available.&quot;</span><span class="p">,</span>
                <span class="n">tool_name</span><span class="o">=</span><span class="n">ev</span><span class="o">.</span><span class="n">tool_name</span><span class="p">,</span>
                <span class="n">raw_input</span><span class="o">=</span><span class="n">ev</span><span class="o">.</span><span class="n">tool_kwargs</span><span class="p">,</span>
                <span class="n">raw_output</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">is_error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tool</span> <span class="o">=</span> <span class="n">tools_by_name</span><span class="p">[</span><span class="n">ev</span><span class="o">.</span><span class="n">tool_name</span><span class="p">]</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_tool</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">tool</span><span class="p">,</span> <span class="n">ev</span><span class="o">.</span><span class="n">tool_kwargs</span><span class="p">)</span>

        <span class="n">result_ev</span> <span class="o">=</span> <span class="n">ToolCallResult</span><span class="p">(</span>
            <span class="n">tool_name</span><span class="o">=</span><span class="n">ev</span><span class="o">.</span><span class="n">tool_name</span><span class="p">,</span>
            <span class="n">tool_kwargs</span><span class="o">=</span><span class="n">ev</span><span class="o">.</span><span class="n">tool_kwargs</span><span class="p">,</span>
            <span class="n">tool_id</span><span class="o">=</span><span class="n">ev</span><span class="o">.</span><span class="n">tool_id</span><span class="p">,</span>
            <span class="n">tool_output</span><span class="o">=</span><span class="n">result</span><span class="p">,</span>
            <span class="n">return_direct</span><span class="o">=</span><span class="n">tool</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">return_direct</span> <span class="k">if</span> <span class="n">tool</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">ctx</span><span class="o">.</span><span class="n">write_event_to_stream</span><span class="p">(</span><span class="n">result_ev</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result_ev</span>

    <span class="nd">@step</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">aggregate_tool_results</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">ev</span><span class="p">:</span> <span class="n">ToolCallResult</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">AgentInput</span><span class="p">,</span> <span class="n">StopEvent</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Aggregate tool results and return the next agent input.&quot;&quot;&quot;</span>
        <span class="n">num_tool_calls</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;num_tool_calls&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_tool_calls</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No tool calls found, cannot aggregate results.&quot;</span><span class="p">)</span>

        <span class="n">tool_call_results</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ToolCallResult</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">collect_events</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
            <span class="n">ev</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="p">[</span><span class="n">ToolCallResult</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_tool_calls</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tool_call_results</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">memory</span><span class="p">:</span> <span class="n">BaseMemory</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;memory&quot;</span><span class="p">)</span>

        <span class="c1"># track tool calls made during a .run() call</span>
        <span class="n">cur_tool_calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolCallResult</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;current_tool_calls&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[]</span>
        <span class="p">)</span>
        <span class="n">cur_tool_calls</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tool_call_results</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;current_tool_calls&quot;</span><span class="p">,</span> <span class="n">cur_tool_calls</span><span class="p">)</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_tool_call_results</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">tool_call_results</span><span class="p">,</span> <span class="n">memory</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">tool_call_result</span><span class="o">.</span><span class="n">return_direct</span> <span class="k">for</span> <span class="n">tool_call_result</span> <span class="ow">in</span> <span class="n">tool_call_results</span>
        <span class="p">):</span>
            <span class="c1"># if any tool calls return directly, take the first one</span>
            <span class="n">return_direct_tool</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
                <span class="n">tool_call_result</span>
                <span class="k">for</span> <span class="n">tool_call_result</span> <span class="ow">in</span> <span class="n">tool_call_results</span>
                <span class="k">if</span> <span class="n">tool_call_result</span><span class="o">.</span><span class="n">return_direct</span>
            <span class="p">)</span>

            <span class="c1"># always finalize the agent, even if we&#39;re just handing off</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">AgentOutput</span><span class="p">(</span>
                <span class="n">response</span><span class="o">=</span><span class="n">ChatMessage</span><span class="p">(</span>
                    <span class="n">role</span><span class="o">=</span><span class="s2">&quot;assistant&quot;</span><span class="p">,</span>
                    <span class="n">content</span><span class="o">=</span><span class="n">return_direct_tool</span><span class="o">.</span><span class="n">tool_output</span><span class="o">.</span><span class="n">content</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">tool_calls</span><span class="o">=</span><span class="p">[</span>
                    <span class="n">ToolSelection</span><span class="p">(</span>
                        <span class="n">tool_id</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">tool_id</span><span class="p">,</span>
                        <span class="n">tool_name</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">tool_name</span><span class="p">,</span>
                        <span class="n">tool_kwargs</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">tool_kwargs</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">cur_tool_calls</span>
                <span class="p">],</span>
                <span class="n">raw</span><span class="o">=</span><span class="n">return_direct_tool</span><span class="o">.</span><span class="n">tool_output</span><span class="o">.</span><span class="n">raw_output</span><span class="p">,</span>
                <span class="n">current_agent_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">memory</span><span class="p">)</span>

        <span class="n">user_msg_str</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_msg_str&quot;</span><span class="p">)</span>
        <span class="n">input_messages</span> <span class="o">=</span> <span class="k">await</span> <span class="n">memory</span><span class="o">.</span><span class="n">aget</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">user_msg_str</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">AgentInput</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">input_messages</span><span class="p">,</span> <span class="n">current_agent_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">user_msg</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ChatMessage</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">chat_history</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">memory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseMemory</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ctx</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Context</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">stepwise</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">checkpoint_callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CheckpointCallback</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_iterations</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WorkflowHandler</span><span class="p">:</span>
        <span class="c1"># Detect if hitl is needed</span>
        <span class="k">if</span> <span class="n">ctx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ctx</span><span class="o">.</span><span class="n">is_running</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                <span class="n">ctx</span><span class="o">=</span><span class="n">ctx</span><span class="p">,</span>
                <span class="n">stepwise</span><span class="o">=</span><span class="n">stepwise</span><span class="p">,</span>
                <span class="n">checkpoint_callback</span><span class="o">=</span><span class="n">checkpoint_callback</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                <span class="n">start_event</span><span class="o">=</span><span class="n">AgentWorkflowStartEvent</span><span class="p">(</span>
                    <span class="n">user_msg</span><span class="o">=</span><span class="n">user_msg</span><span class="p">,</span>
                    <span class="n">chat_history</span><span class="o">=</span><span class="n">chat_history</span><span class="p">,</span>
                    <span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">,</span>
                    <span class="n">max_iterations</span><span class="o">=</span><span class="n">max_iterations</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">ctx</span><span class="o">=</span><span class="n">ctx</span><span class="p">,</span>
                <span class="n">stepwise</span><span class="o">=</span><span class="n">stepwise</span><span class="p">,</span>
                <span class="n">checkpoint_callback</span><span class="o">=</span><span class="n">checkpoint_callback</span><span class="p">,</span>
            <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="llama_index.core.agent.workflow.BaseWorkflowAgent.validate_tools" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">validate_tools</span>


<a href="#llama_index.core.agent.workflow.BaseWorkflowAgent.validate_tools" class="headerlink" title="Permanent link">#</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">validate_tools</span><span class="p">(</span><span class="n">v</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="typing.Sequence">Sequence</span></span><span class="p">[</span><span class="n"><span title="typing.Union">Union</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.tools.BaseTool" href="../tools/#llama_index.core.tools.types.BaseTool">BaseTool</a></span><span class="p">,</span> <span class="n"><span title="typing.Callable">Callable</span></span><span class="p">]]])</span> <span class="o">-&gt;</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="typing.Sequence">Sequence</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.tools.BaseTool" href="../tools/#llama_index.core.tools.types.BaseTool">BaseTool</a></span><span class="p">]]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Validate tools.</p>
<p>If tools are not of type BaseTool, they will be converted to FunctionTools.
This assumes the inputs are tools or callable functions.</p>

            <details class="quote">
              <summary>Source code in <code>llama_index\core\agent\workflow\base_agent.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;tools&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;before&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">validate_tools</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">BaseTool</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]]]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">BaseTool</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate tools.</span>

<span class="sd">    If tools are not of type BaseTool, they will be converted to FunctionTools.</span>
<span class="sd">    This assumes the inputs are tools or callable functions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">validated_tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">BaseTool</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">BaseTool</span><span class="p">):</span>
            <span class="n">validated_tools</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">FunctionTool</span><span class="o">.</span><span class="n">from_defaults</span><span class="p">(</span><span class="n">tool</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">validated_tools</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tool</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">validated_tools</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">tool</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;handoff&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;&#39;handoff&#39; is a reserved tool name. Please use a different name.&quot;</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">validated_tools</span>  <span class="c1"># type: ignore[return-value]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="llama_index.core.agent.workflow.BaseWorkflowAgent.take_step" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">take_step</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#llama_index.core.agent.workflow.BaseWorkflowAgent.take_step" class="headerlink" title="Permanent link">#</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">take_step</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.workflow.context.Context" href="../workflow/context/#workflows.context.Context">Context</a></span><span class="p">,</span> <span class="n">llm_input</span><span class="p">:</span> <span class="n"><span title="typing.List">List</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.llms.ChatMessage" href="../llms/#llama_index.core.base.llms.types.ChatMessage">ChatMessage</a></span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n"><span title="typing.Sequence">Sequence</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.tools.AsyncBaseTool" href="../tools/#llama_index.core.tools.types.AsyncBaseTool">AsyncBaseTool</a></span><span class="p">],</span> <span class="n">memory</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.memory.BaseMemory" href="../memory/#llama_index.core.memory.types.BaseMemory">BaseMemory</a></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.agent.workflow.workflow_events.AgentOutput" href="#llama_index.core.agent.workflow.AgentOutput">AgentOutput</a></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Take a single step with the agent.</p>

            <details class="quote">
              <summary>Source code in <code>llama_index\core\agent\workflow\base_agent.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">take_step</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span>
    <span class="n">llm_input</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span>
    <span class="n">tools</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">AsyncBaseTool</span><span class="p">],</span>
    <span class="n">memory</span><span class="p">:</span> <span class="n">BaseMemory</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentOutput</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Take a single step with the agent.&quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="llama_index.core.agent.workflow.BaseWorkflowAgent.handle_tool_call_results" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">handle_tool_call_results</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#llama_index.core.agent.workflow.BaseWorkflowAgent.handle_tool_call_results" class="headerlink" title="Permanent link">#</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">handle_tool_call_results</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.workflow.context.Context" href="../workflow/context/#workflows.context.Context">Context</a></span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n"><span title="typing.List">List</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.agent.workflow.workflow_events.ToolCallResult" href="#llama_index.core.agent.workflow.ToolCallResult">ToolCallResult</a></span><span class="p">],</span> <span class="n">memory</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.memory.BaseMemory" href="../memory/#llama_index.core.memory.types.BaseMemory">BaseMemory</a></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Handle tool call results.</p>

            <details class="quote">
              <summary>Source code in <code>llama_index\core\agent\workflow\base_agent.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">handle_tool_call_results</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolCallResult</span><span class="p">],</span> <span class="n">memory</span><span class="p">:</span> <span class="n">BaseMemory</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle tool call results.&quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="llama_index.core.agent.workflow.BaseWorkflowAgent.finalize" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">finalize</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#llama_index.core.agent.workflow.BaseWorkflowAgent.finalize" class="headerlink" title="Permanent link">#</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">finalize</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.workflow.context.Context" href="../workflow/context/#workflows.context.Context">Context</a></span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.agent.workflow.workflow_events.AgentOutput" href="#llama_index.core.agent.workflow.AgentOutput">AgentOutput</a></span><span class="p">,</span> <span class="n">memory</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.memory.BaseMemory" href="../memory/#llama_index.core.memory.types.BaseMemory">BaseMemory</a></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.agent.workflow.workflow_events.AgentOutput" href="#llama_index.core.agent.workflow.AgentOutput">AgentOutput</a></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Finalize the agent's execution.</p>

            <details class="quote">
              <summary>Source code in <code>llama_index\core\agent\workflow\base_agent.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">finalize</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">AgentOutput</span><span class="p">,</span> <span class="n">memory</span><span class="p">:</span> <span class="n">BaseMemory</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentOutput</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Finalize the agent&#39;s execution.&quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="llama_index.core.agent.workflow.BaseWorkflowAgent.get_tools" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">get_tools</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#llama_index.core.agent.workflow.BaseWorkflowAgent.get_tools" class="headerlink" title="Permanent link">#</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">get_tools</span><span class="p">(</span><span class="n">input_str</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="typing.Sequence">Sequence</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.tools.AsyncBaseTool" href="../tools/#llama_index.core.tools.types.AsyncBaseTool">AsyncBaseTool</a></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Get tools for the given agent.</p>

            <details class="quote">
              <summary>Source code in <code>llama_index\core\agent\workflow\base_agent.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">get_tools</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">input_str</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">AsyncBaseTool</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get tools for the given agent.&quot;&quot;&quot;</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools</span> <span class="k">else</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tool_retriever</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">retrieved_tools</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">tool_retriever</span><span class="o">.</span><span class="n">aretrieve</span><span class="p">(</span><span class="n">input_str</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">tools</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">retrieved_tools</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_tools_are_async</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">List</span><span class="p">[</span><span class="n">BaseTool</span><span class="p">],</span> <span class="n">tools</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="llama_index.core.agent.workflow.BaseWorkflowAgent.init_run" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">init_run</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#llama_index.core.agent.workflow.BaseWorkflowAgent.init_run" class="headerlink" title="Permanent link">#</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">init_run</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.workflow.context.Context" href="../workflow/context/#workflows.context.Context">Context</a></span><span class="p">,</span> <span class="n">ev</span><span class="p">:</span> <span class="n"><span title="llama_index.core.agent.workflow.workflow_events.AgentWorkflowStartEvent">AgentWorkflowStartEvent</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.agent.workflow.workflow_events.AgentInput" href="#llama_index.core.agent.workflow.AgentInput">AgentInput</a></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Sets up the workflow and validates inputs.</p>

            <details class="quote">
              <summary>Source code in <code>llama_index\core\agent\workflow\base_agent.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@step</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">init_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">ev</span><span class="p">:</span> <span class="n">AgentWorkflowStartEvent</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentInput</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sets up the workflow and validates inputs.&quot;&quot;&quot;</span>
    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_context</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ev</span><span class="p">)</span>

    <span class="n">user_msg</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ChatMessage</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_msg&quot;</span><span class="p">)</span>
    <span class="n">chat_history</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;chat_history&quot;</span><span class="p">,</span> <span class="p">[])</span>

    <span class="c1"># Convert string user_msg to ChatMessage</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">user_msg</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">user_msg</span> <span class="o">=</span> <span class="n">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">user_msg</span><span class="p">)</span>

    <span class="c1"># Add messages to memory</span>
    <span class="n">memory</span><span class="p">:</span> <span class="n">BaseMemory</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;memory&quot;</span><span class="p">)</span>

    <span class="c1"># First set chat history if it exists</span>
    <span class="k">if</span> <span class="n">chat_history</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">memory</span><span class="o">.</span><span class="n">aset</span><span class="p">(</span><span class="n">chat_history</span><span class="p">)</span>

    <span class="c1"># Then add user message if it exists</span>
    <span class="k">if</span> <span class="n">user_msg</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">memory</span><span class="o">.</span><span class="n">aput</span><span class="p">(</span><span class="n">user_msg</span><span class="p">)</span>
        <span class="n">content_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">block</span><span class="o">.</span><span class="n">text</span>
                <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">user_msg</span><span class="o">.</span><span class="n">blocks</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">TextBlock</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;user_msg_str&quot;</span><span class="p">,</span> <span class="n">content_str</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">chat_history</span><span class="p">:</span>
        <span class="c1"># If no user message, use the last message from chat history as user_msg_str</span>
        <span class="n">content_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">block</span><span class="o">.</span><span class="n">text</span>
                <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">chat_history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">blocks</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">TextBlock</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;user_msg_str&quot;</span><span class="p">,</span> <span class="n">content_str</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must provide either user_msg or chat_history&quot;</span><span class="p">)</span>

    <span class="c1"># Get all messages from memory</span>
    <span class="n">input_messages</span> <span class="o">=</span> <span class="k">await</span> <span class="n">memory</span><span class="o">.</span><span class="n">aget</span><span class="p">()</span>

    <span class="c1"># send to the current agent</span>
    <span class="k">return</span> <span class="n">AgentInput</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">input_messages</span><span class="p">,</span> <span class="n">current_agent_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="llama_index.core.agent.workflow.BaseWorkflowAgent.setup_agent" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">setup_agent</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#llama_index.core.agent.workflow.BaseWorkflowAgent.setup_agent" class="headerlink" title="Permanent link">#</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">setup_agent</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.workflow.context.Context" href="../workflow/context/#workflows.context.Context">Context</a></span><span class="p">,</span> <span class="n">ev</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.agent.workflow.workflow_events.AgentInput" href="#llama_index.core.agent.workflow.AgentInput">AgentInput</a></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="llama_index.core.agent.workflow.workflow_events.AgentSetup">AgentSetup</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Main agent handling logic.</p>

            <details class="quote">
              <summary>Source code in <code>llama_index\core\agent\workflow\base_agent.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@step</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">setup_agent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">ev</span><span class="p">:</span> <span class="n">AgentInput</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentSetup</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Main agent handling logic.&quot;&quot;&quot;</span>
    <span class="n">llm_input</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">ev</span><span class="o">.</span><span class="n">input</span><span class="p">]</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span><span class="p">:</span>
        <span class="n">llm_input</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span><span class="p">),</span>
            <span class="o">*</span><span class="n">llm_input</span><span class="p">,</span>
        <span class="p">]</span>

    <span class="n">state</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">formatted_input_with_state</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s2">&quot;formatted_input_with_state&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">state</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">formatted_input_with_state</span><span class="p">:</span>
        <span class="c1"># update last message with current state</span>
        <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">llm_input</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">blocks</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">TextBlock</span><span class="p">):</span>
                <span class="n">block</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_prompt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">block</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;formatted_input_with_state&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">AgentSetup</span><span class="p">(</span>
        <span class="nb">input</span><span class="o">=</span><span class="n">llm_input</span><span class="p">,</span>
        <span class="n">current_agent_name</span><span class="o">=</span><span class="n">ev</span><span class="o">.</span><span class="n">current_agent_name</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="llama_index.core.agent.workflow.BaseWorkflowAgent.run_agent_step" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">run_agent_step</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#llama_index.core.agent.workflow.BaseWorkflowAgent.run_agent_step" class="headerlink" title="Permanent link">#</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">run_agent_step</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.workflow.context.Context" href="../workflow/context/#workflows.context.Context">Context</a></span><span class="p">,</span> <span class="n">ev</span><span class="p">:</span> <span class="n"><span title="llama_index.core.agent.workflow.workflow_events.AgentSetup">AgentSetup</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.agent.workflow.workflow_events.AgentOutput" href="#llama_index.core.agent.workflow.AgentOutput">AgentOutput</a></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Run the agent.</p>

            <details class="quote">
              <summary>Source code in <code>llama_index\core\agent\workflow\base_agent.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@step</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">run_agent_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">ev</span><span class="p">:</span> <span class="n">AgentSetup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentOutput</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run the agent.&quot;&quot;&quot;</span>
    <span class="n">memory</span><span class="p">:</span> <span class="n">BaseMemory</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;memory&quot;</span><span class="p">)</span>
    <span class="n">user_msg_str</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_msg_str&quot;</span><span class="p">)</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tools</span><span class="p">(</span><span class="n">user_msg_str</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="n">agent_output</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">take_step</span><span class="p">(</span>
        <span class="n">ctx</span><span class="p">,</span>
        <span class="n">ev</span><span class="o">.</span><span class="n">input</span><span class="p">,</span>
        <span class="n">tools</span><span class="p">,</span>
        <span class="n">memory</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">ctx</span><span class="o">.</span><span class="n">write_event_to_stream</span><span class="p">(</span><span class="n">agent_output</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">agent_output</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="llama_index.core.agent.workflow.BaseWorkflowAgent.call_tool" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">call_tool</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#llama_index.core.agent.workflow.BaseWorkflowAgent.call_tool" class="headerlink" title="Permanent link">#</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">call_tool</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.workflow.context.Context" href="../workflow/context/#workflows.context.Context">Context</a></span><span class="p">,</span> <span class="n">ev</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.agent.workflow.workflow_events.ToolCall" href="#llama_index.core.agent.workflow.ToolCall">ToolCall</a></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.agent.workflow.workflow_events.ToolCallResult" href="#llama_index.core.agent.workflow.ToolCallResult">ToolCallResult</a></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Calls the tool and handles the result.</p>

            <details class="quote">
              <summary>Source code in <code>llama_index\core\agent\workflow\base_agent.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@step</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">call_tool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">ev</span><span class="p">:</span> <span class="n">ToolCall</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ToolCallResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calls the tool and handles the result.&quot;&quot;&quot;</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">write_event_to_stream</span><span class="p">(</span>
        <span class="n">ToolCall</span><span class="p">(</span>
            <span class="n">tool_name</span><span class="o">=</span><span class="n">ev</span><span class="o">.</span><span class="n">tool_name</span><span class="p">,</span>
            <span class="n">tool_kwargs</span><span class="o">=</span><span class="n">ev</span><span class="o">.</span><span class="n">tool_kwargs</span><span class="p">,</span>
            <span class="n">tool_id</span><span class="o">=</span><span class="n">ev</span><span class="o">.</span><span class="n">tool_id</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="n">tools</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tools</span><span class="p">(</span><span class="n">ev</span><span class="o">.</span><span class="n">tool_name</span><span class="p">)</span>
    <span class="n">tools_by_name</span> <span class="o">=</span> <span class="p">{</span><span class="n">tool</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">tool</span> <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">ev</span><span class="o">.</span><span class="n">tool_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tools_by_name</span><span class="p">:</span>
        <span class="n">tool</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">ToolOutput</span><span class="p">(</span>
            <span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Tool </span><span class="si">{</span><span class="n">ev</span><span class="o">.</span><span class="n">tool_name</span><span class="si">}</span><span class="s2"> not found. Please select a tool that is available.&quot;</span><span class="p">,</span>
            <span class="n">tool_name</span><span class="o">=</span><span class="n">ev</span><span class="o">.</span><span class="n">tool_name</span><span class="p">,</span>
            <span class="n">raw_input</span><span class="o">=</span><span class="n">ev</span><span class="o">.</span><span class="n">tool_kwargs</span><span class="p">,</span>
            <span class="n">raw_output</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">is_error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tool</span> <span class="o">=</span> <span class="n">tools_by_name</span><span class="p">[</span><span class="n">ev</span><span class="o">.</span><span class="n">tool_name</span><span class="p">]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_tool</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">tool</span><span class="p">,</span> <span class="n">ev</span><span class="o">.</span><span class="n">tool_kwargs</span><span class="p">)</span>

    <span class="n">result_ev</span> <span class="o">=</span> <span class="n">ToolCallResult</span><span class="p">(</span>
        <span class="n">tool_name</span><span class="o">=</span><span class="n">ev</span><span class="o">.</span><span class="n">tool_name</span><span class="p">,</span>
        <span class="n">tool_kwargs</span><span class="o">=</span><span class="n">ev</span><span class="o">.</span><span class="n">tool_kwargs</span><span class="p">,</span>
        <span class="n">tool_id</span><span class="o">=</span><span class="n">ev</span><span class="o">.</span><span class="n">tool_id</span><span class="p">,</span>
        <span class="n">tool_output</span><span class="o">=</span><span class="n">result</span><span class="p">,</span>
        <span class="n">return_direct</span><span class="o">=</span><span class="n">tool</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">return_direct</span> <span class="k">if</span> <span class="n">tool</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">ctx</span><span class="o">.</span><span class="n">write_event_to_stream</span><span class="p">(</span><span class="n">result_ev</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result_ev</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="llama_index.core.agent.workflow.BaseWorkflowAgent.aggregate_tool_results" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">aggregate_tool_results</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#llama_index.core.agent.workflow.BaseWorkflowAgent.aggregate_tool_results" class="headerlink" title="Permanent link">#</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">aggregate_tool_results</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.workflow.context.Context" href="../workflow/context/#workflows.context.Context">Context</a></span><span class="p">,</span> <span class="n">ev</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.agent.workflow.workflow_events.ToolCallResult" href="#llama_index.core.agent.workflow.ToolCallResult">ToolCallResult</a></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="typing.Union">Union</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.agent.workflow.workflow_events.AgentInput" href="#llama_index.core.agent.workflow.AgentInput">AgentInput</a></span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.workflow.events.StopEvent" href="../workflow/events/#workflows.events.StopEvent">StopEvent</a></span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Aggregate tool results and return the next agent input.</p>

            <details class="quote">
              <summary>Source code in <code>llama_index\core\agent\workflow\base_agent.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@step</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">aggregate_tool_results</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">ev</span><span class="p">:</span> <span class="n">ToolCallResult</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">AgentInput</span><span class="p">,</span> <span class="n">StopEvent</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Aggregate tool results and return the next agent input.&quot;&quot;&quot;</span>
    <span class="n">num_tool_calls</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;num_tool_calls&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num_tool_calls</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No tool calls found, cannot aggregate results.&quot;</span><span class="p">)</span>

    <span class="n">tool_call_results</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ToolCallResult</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">collect_events</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
        <span class="n">ev</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="p">[</span><span class="n">ToolCallResult</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_tool_calls</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">tool_call_results</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">memory</span><span class="p">:</span> <span class="n">BaseMemory</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;memory&quot;</span><span class="p">)</span>

    <span class="c1"># track tool calls made during a .run() call</span>
    <span class="n">cur_tool_calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolCallResult</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s2">&quot;current_tool_calls&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[]</span>
    <span class="p">)</span>
    <span class="n">cur_tool_calls</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tool_call_results</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;current_tool_calls&quot;</span><span class="p">,</span> <span class="n">cur_tool_calls</span><span class="p">)</span>

    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_tool_call_results</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">tool_call_results</span><span class="p">,</span> <span class="n">memory</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
        <span class="n">tool_call_result</span><span class="o">.</span><span class="n">return_direct</span> <span class="k">for</span> <span class="n">tool_call_result</span> <span class="ow">in</span> <span class="n">tool_call_results</span>
    <span class="p">):</span>
        <span class="c1"># if any tool calls return directly, take the first one</span>
        <span class="n">return_direct_tool</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
            <span class="n">tool_call_result</span>
            <span class="k">for</span> <span class="n">tool_call_result</span> <span class="ow">in</span> <span class="n">tool_call_results</span>
            <span class="k">if</span> <span class="n">tool_call_result</span><span class="o">.</span><span class="n">return_direct</span>
        <span class="p">)</span>

        <span class="c1"># always finalize the agent, even if we&#39;re just handing off</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">AgentOutput</span><span class="p">(</span>
            <span class="n">response</span><span class="o">=</span><span class="n">ChatMessage</span><span class="p">(</span>
                <span class="n">role</span><span class="o">=</span><span class="s2">&quot;assistant&quot;</span><span class="p">,</span>
                <span class="n">content</span><span class="o">=</span><span class="n">return_direct_tool</span><span class="o">.</span><span class="n">tool_output</span><span class="o">.</span><span class="n">content</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">tool_calls</span><span class="o">=</span><span class="p">[</span>
                <span class="n">ToolSelection</span><span class="p">(</span>
                    <span class="n">tool_id</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">tool_id</span><span class="p">,</span>
                    <span class="n">tool_name</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">tool_name</span><span class="p">,</span>
                    <span class="n">tool_kwargs</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">tool_kwargs</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">cur_tool_calls</span>
            <span class="p">],</span>
            <span class="n">raw</span><span class="o">=</span><span class="n">return_direct_tool</span><span class="o">.</span><span class="n">tool_output</span><span class="o">.</span><span class="n">raw_output</span><span class="p">,</span>
            <span class="n">current_agent_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">memory</span><span class="p">)</span>

    <span class="n">user_msg_str</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_msg_str&quot;</span><span class="p">)</span>
    <span class="n">input_messages</span> <span class="o">=</span> <span class="k">await</span> <span class="n">memory</span><span class="o">.</span><span class="n">aget</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">user_msg_str</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">AgentInput</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">input_messages</span><span class="p">,</span> <span class="n">current_agent_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="llama_index.core.agent.workflow.FunctionAgent" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">FunctionAgent</span>


<a href="#llama_index.core.agent.workflow.FunctionAgent" class="headerlink" title="Permanent link">#</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="llama_index.core.agent.workflow.base_agent.BaseWorkflowAgent" href="#llama_index.core.agent.workflow.BaseWorkflowAgent">BaseWorkflowAgent</a></code></p>


        <p>Function calling agent implementation.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>scratchpad_key</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                  <code>&#39;scratchpad&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>allow_parallel_tool_calls</code>
            </td>
            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, the agent will call multiple tools in parallel. If False, the agent will call tools sequentially.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>






              <details class="quote">
                <summary>Source code in <code>llama_index\core\agent\workflow\function_agent.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">FunctionAgent</span><span class="p">(</span><span class="n">BaseWorkflowAgent</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function calling agent implementation.&quot;&quot;&quot;</span>

    <span class="n">scratchpad_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;scratchpad&quot;</span>
    <span class="n">allow_parallel_tool_calls</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;If True, the agent will call multiple tools in parallel. If False, the agent will call tools sequentially.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">take_step</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span>
        <span class="n">llm_input</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span>
        <span class="n">tools</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">AsyncBaseTool</span><span class="p">],</span>
        <span class="n">memory</span><span class="p">:</span> <span class="n">BaseMemory</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentOutput</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Take a single step with the function calling agent.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">is_function_calling_model</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;LLM must be a FunctionCallingLLM&quot;</span><span class="p">)</span>

        <span class="n">scratchpad</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scratchpad_key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[]</span>
        <span class="p">)</span>
        <span class="n">current_llm_input</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">llm_input</span><span class="p">,</span> <span class="o">*</span><span class="n">scratchpad</span><span class="p">]</span>

        <span class="n">ctx</span><span class="o">.</span><span class="n">write_event_to_stream</span><span class="p">(</span>
            <span class="n">AgentInput</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">current_llm_input</span><span class="p">,</span> <span class="n">current_agent_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">astream_chat_with_tools</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="n">chat_history</span><span class="o">=</span><span class="n">current_llm_input</span><span class="p">,</span>
            <span class="n">allow_parallel_tool_calls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">allow_parallel_tool_calls</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># last_chat_response will be used later, after the loop.</span>
        <span class="c1"># We initialize it so it&#39;s valid even when &#39;response&#39; is empty</span>
        <span class="n">last_chat_response</span> <span class="o">=</span> <span class="n">ChatResponse</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">ChatMessage</span><span class="p">())</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">last_chat_response</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
            <span class="n">tool_calls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">get_tool_calls_from_response</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
                <span class="n">last_chat_response</span><span class="p">,</span> <span class="n">error_on_no_tool_call</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">last_chat_response</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">last_chat_response</span><span class="o">.</span><span class="n">raw</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">)</span>
                <span class="k">else</span> <span class="n">last_chat_response</span><span class="o">.</span><span class="n">raw</span>
            <span class="p">)</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">write_event_to_stream</span><span class="p">(</span>
                <span class="n">AgentStream</span><span class="p">(</span>
                    <span class="n">delta</span><span class="o">=</span><span class="n">last_chat_response</span><span class="o">.</span><span class="n">delta</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="n">response</span><span class="o">=</span><span class="n">last_chat_response</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="n">tool_calls</span><span class="o">=</span><span class="n">tool_calls</span> <span class="ow">or</span> <span class="p">[],</span>
                    <span class="n">raw</span><span class="o">=</span><span class="n">raw</span><span class="p">,</span>
                    <span class="n">current_agent_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="n">tool_calls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">get_tool_calls_from_response</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
            <span class="n">last_chat_response</span><span class="p">,</span> <span class="n">error_on_no_tool_call</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="c1"># only add to scratchpad if we didn&#39;t select the handoff tool</span>
        <span class="n">scratchpad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">last_chat_response</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scratchpad_key</span><span class="p">,</span> <span class="n">scratchpad</span><span class="p">)</span>

        <span class="n">raw</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">last_chat_response</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">last_chat_response</span><span class="o">.</span><span class="n">raw</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">)</span>
            <span class="k">else</span> <span class="n">last_chat_response</span><span class="o">.</span><span class="n">raw</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">AgentOutput</span><span class="p">(</span>
            <span class="n">response</span><span class="o">=</span><span class="n">last_chat_response</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
            <span class="n">tool_calls</span><span class="o">=</span><span class="n">tool_calls</span> <span class="ow">or</span> <span class="p">[],</span>
            <span class="n">raw</span><span class="o">=</span><span class="n">raw</span><span class="p">,</span>
            <span class="n">current_agent_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">handle_tool_call_results</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolCallResult</span><span class="p">],</span> <span class="n">memory</span><span class="p">:</span> <span class="n">BaseMemory</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle tool call results for function calling agent.&quot;&quot;&quot;</span>
        <span class="n">scratchpad</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scratchpad_key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[]</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">tool_call_result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">scratchpad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">ChatMessage</span><span class="p">(</span>
                    <span class="n">role</span><span class="o">=</span><span class="s2">&quot;tool&quot;</span><span class="p">,</span>
                    <span class="n">blocks</span><span class="o">=</span><span class="n">tool_call_result</span><span class="o">.</span><span class="n">tool_output</span><span class="o">.</span><span class="n">blocks</span><span class="p">,</span>
                    <span class="n">additional_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;tool_call_id&quot;</span><span class="p">:</span> <span class="n">tool_call_result</span><span class="o">.</span><span class="n">tool_id</span><span class="p">},</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="n">tool_call_result</span><span class="o">.</span><span class="n">return_direct</span>
                <span class="ow">and</span> <span class="n">tool_call_result</span><span class="o">.</span><span class="n">tool_name</span> <span class="o">!=</span> <span class="s2">&quot;handoff&quot;</span>
            <span class="p">):</span>
                <span class="n">scratchpad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">ChatMessage</span><span class="p">(</span>
                        <span class="n">role</span><span class="o">=</span><span class="s2">&quot;assistant&quot;</span><span class="p">,</span>
                        <span class="n">content</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">tool_call_result</span><span class="o">.</span><span class="n">tool_output</span><span class="o">.</span><span class="n">content</span><span class="p">),</span>
                        <span class="n">additional_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;tool_call_id&quot;</span><span class="p">:</span> <span class="n">tool_call_result</span><span class="o">.</span><span class="n">tool_id</span><span class="p">},</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">break</span>

        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scratchpad_key</span><span class="p">,</span> <span class="n">scratchpad</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">finalize</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">AgentOutput</span><span class="p">,</span> <span class="n">memory</span><span class="p">:</span> <span class="n">BaseMemory</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentOutput</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finalize the function calling agent.</span>

<span class="sd">        Adds all in-progress messages to memory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scratchpad</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scratchpad_key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[]</span>
        <span class="p">)</span>
        <span class="k">await</span> <span class="n">memory</span><span class="o">.</span><span class="n">aput_messages</span><span class="p">(</span><span class="n">scratchpad</span><span class="p">)</span>

        <span class="c1"># reset scratchpad</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scratchpad_key</span><span class="p">,</span> <span class="p">[])</span>

        <span class="k">return</span> <span class="n">output</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="llama_index.core.agent.workflow.FunctionAgent.take_step" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">take_step</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#llama_index.core.agent.workflow.FunctionAgent.take_step" class="headerlink" title="Permanent link">#</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">take_step</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.workflow.Context" href="../workflow/context/#workflows.context.Context">Context</a></span><span class="p">,</span> <span class="n">llm_input</span><span class="p">:</span> <span class="n"><span title="typing.List">List</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.llms.ChatMessage" href="../llms/#llama_index.core.base.llms.types.ChatMessage">ChatMessage</a></span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n"><span title="typing.Sequence">Sequence</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.tools.AsyncBaseTool" href="../tools/#llama_index.core.tools.types.AsyncBaseTool">AsyncBaseTool</a></span><span class="p">],</span> <span class="n">memory</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.memory.BaseMemory" href="../memory/#llama_index.core.memory.types.BaseMemory">BaseMemory</a></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.agent.workflow.workflow_events.AgentOutput" href="#llama_index.core.agent.workflow.AgentOutput">AgentOutput</a></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Take a single step with the function calling agent.</p>

            <details class="quote">
              <summary>Source code in <code>llama_index\core\agent\workflow\function_agent.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">take_step</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span>
    <span class="n">llm_input</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span>
    <span class="n">tools</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">AsyncBaseTool</span><span class="p">],</span>
    <span class="n">memory</span><span class="p">:</span> <span class="n">BaseMemory</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentOutput</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Take a single step with the function calling agent.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">is_function_calling_model</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;LLM must be a FunctionCallingLLM&quot;</span><span class="p">)</span>

    <span class="n">scratchpad</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scratchpad_key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[]</span>
    <span class="p">)</span>
    <span class="n">current_llm_input</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">llm_input</span><span class="p">,</span> <span class="o">*</span><span class="n">scratchpad</span><span class="p">]</span>

    <span class="n">ctx</span><span class="o">.</span><span class="n">write_event_to_stream</span><span class="p">(</span>
        <span class="n">AgentInput</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">current_llm_input</span><span class="p">,</span> <span class="n">current_agent_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">astream_chat_with_tools</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
        <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
        <span class="n">chat_history</span><span class="o">=</span><span class="n">current_llm_input</span><span class="p">,</span>
        <span class="n">allow_parallel_tool_calls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">allow_parallel_tool_calls</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># last_chat_response will be used later, after the loop.</span>
    <span class="c1"># We initialize it so it&#39;s valid even when &#39;response&#39; is empty</span>
    <span class="n">last_chat_response</span> <span class="o">=</span> <span class="n">ChatResponse</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">ChatMessage</span><span class="p">())</span>
    <span class="k">async</span> <span class="k">for</span> <span class="n">last_chat_response</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
        <span class="n">tool_calls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">get_tool_calls_from_response</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
            <span class="n">last_chat_response</span><span class="p">,</span> <span class="n">error_on_no_tool_call</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">last_chat_response</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">last_chat_response</span><span class="o">.</span><span class="n">raw</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">)</span>
            <span class="k">else</span> <span class="n">last_chat_response</span><span class="o">.</span><span class="n">raw</span>
        <span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">write_event_to_stream</span><span class="p">(</span>
            <span class="n">AgentStream</span><span class="p">(</span>
                <span class="n">delta</span><span class="o">=</span><span class="n">last_chat_response</span><span class="o">.</span><span class="n">delta</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">response</span><span class="o">=</span><span class="n">last_chat_response</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">tool_calls</span><span class="o">=</span><span class="n">tool_calls</span> <span class="ow">or</span> <span class="p">[],</span>
                <span class="n">raw</span><span class="o">=</span><span class="n">raw</span><span class="p">,</span>
                <span class="n">current_agent_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="n">tool_calls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">get_tool_calls_from_response</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
        <span class="n">last_chat_response</span><span class="p">,</span> <span class="n">error_on_no_tool_call</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>

    <span class="c1"># only add to scratchpad if we didn&#39;t select the handoff tool</span>
    <span class="n">scratchpad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">last_chat_response</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scratchpad_key</span><span class="p">,</span> <span class="n">scratchpad</span><span class="p">)</span>

    <span class="n">raw</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">last_chat_response</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">last_chat_response</span><span class="o">.</span><span class="n">raw</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">)</span>
        <span class="k">else</span> <span class="n">last_chat_response</span><span class="o">.</span><span class="n">raw</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">AgentOutput</span><span class="p">(</span>
        <span class="n">response</span><span class="o">=</span><span class="n">last_chat_response</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
        <span class="n">tool_calls</span><span class="o">=</span><span class="n">tool_calls</span> <span class="ow">or</span> <span class="p">[],</span>
        <span class="n">raw</span><span class="o">=</span><span class="n">raw</span><span class="p">,</span>
        <span class="n">current_agent_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="llama_index.core.agent.workflow.FunctionAgent.handle_tool_call_results" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">handle_tool_call_results</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#llama_index.core.agent.workflow.FunctionAgent.handle_tool_call_results" class="headerlink" title="Permanent link">#</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">handle_tool_call_results</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.workflow.Context" href="../workflow/context/#workflows.context.Context">Context</a></span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n"><span title="typing.List">List</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.agent.workflow.workflow_events.ToolCallResult" href="#llama_index.core.agent.workflow.ToolCallResult">ToolCallResult</a></span><span class="p">],</span> <span class="n">memory</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.memory.BaseMemory" href="../memory/#llama_index.core.memory.types.BaseMemory">BaseMemory</a></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Handle tool call results for function calling agent.</p>

            <details class="quote">
              <summary>Source code in <code>llama_index\core\agent\workflow\function_agent.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">handle_tool_call_results</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolCallResult</span><span class="p">],</span> <span class="n">memory</span><span class="p">:</span> <span class="n">BaseMemory</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle tool call results for function calling agent.&quot;&quot;&quot;</span>
    <span class="n">scratchpad</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scratchpad_key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[]</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">tool_call_result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="n">scratchpad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">ChatMessage</span><span class="p">(</span>
                <span class="n">role</span><span class="o">=</span><span class="s2">&quot;tool&quot;</span><span class="p">,</span>
                <span class="n">blocks</span><span class="o">=</span><span class="n">tool_call_result</span><span class="o">.</span><span class="n">tool_output</span><span class="o">.</span><span class="n">blocks</span><span class="p">,</span>
                <span class="n">additional_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;tool_call_id&quot;</span><span class="p">:</span> <span class="n">tool_call_result</span><span class="o">.</span><span class="n">tool_id</span><span class="p">},</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">tool_call_result</span><span class="o">.</span><span class="n">return_direct</span>
            <span class="ow">and</span> <span class="n">tool_call_result</span><span class="o">.</span><span class="n">tool_name</span> <span class="o">!=</span> <span class="s2">&quot;handoff&quot;</span>
        <span class="p">):</span>
            <span class="n">scratchpad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">ChatMessage</span><span class="p">(</span>
                    <span class="n">role</span><span class="o">=</span><span class="s2">&quot;assistant&quot;</span><span class="p">,</span>
                    <span class="n">content</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">tool_call_result</span><span class="o">.</span><span class="n">tool_output</span><span class="o">.</span><span class="n">content</span><span class="p">),</span>
                    <span class="n">additional_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;tool_call_id&quot;</span><span class="p">:</span> <span class="n">tool_call_result</span><span class="o">.</span><span class="n">tool_id</span><span class="p">},</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">break</span>

    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scratchpad_key</span><span class="p">,</span> <span class="n">scratchpad</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="llama_index.core.agent.workflow.FunctionAgent.finalize" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">finalize</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#llama_index.core.agent.workflow.FunctionAgent.finalize" class="headerlink" title="Permanent link">#</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">finalize</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.workflow.Context" href="../workflow/context/#workflows.context.Context">Context</a></span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.agent.workflow.workflow_events.AgentOutput" href="#llama_index.core.agent.workflow.AgentOutput">AgentOutput</a></span><span class="p">,</span> <span class="n">memory</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.memory.BaseMemory" href="../memory/#llama_index.core.memory.types.BaseMemory">BaseMemory</a></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.agent.workflow.workflow_events.AgentOutput" href="#llama_index.core.agent.workflow.AgentOutput">AgentOutput</a></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Finalize the function calling agent.</p>
<p>Adds all in-progress messages to memory.</p>

            <details class="quote">
              <summary>Source code in <code>llama_index\core\agent\workflow\function_agent.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">finalize</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">AgentOutput</span><span class="p">,</span> <span class="n">memory</span><span class="p">:</span> <span class="n">BaseMemory</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentOutput</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Finalize the function calling agent.</span>

<span class="sd">    Adds all in-progress messages to memory.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">scratchpad</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scratchpad_key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[]</span>
    <span class="p">)</span>
    <span class="k">await</span> <span class="n">memory</span><span class="o">.</span><span class="n">aput_messages</span><span class="p">(</span><span class="n">scratchpad</span><span class="p">)</span>

    <span class="c1"># reset scratchpad</span>
    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scratchpad_key</span><span class="p">,</span> <span class="p">[])</span>

    <span class="k">return</span> <span class="n">output</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="llama_index.core.agent.workflow.ReActAgent" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">ReActAgent</span>


<a href="#llama_index.core.agent.workflow.ReActAgent" class="headerlink" title="Permanent link">#</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="llama_index.core.agent.workflow.base_agent.BaseWorkflowAgent" href="#llama_index.core.agent.workflow.BaseWorkflowAgent">BaseWorkflowAgent</a></code></p>


        <p>React agent implementation.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>reasoning_key</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                  <code>&#39;current_reasoning&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_parser</code>
            </td>
            <td>
                  <code><span title="llama_index.core.agent.react.output_parser.ReActOutputParser">ReActOutputParser</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The react output parser</p>
              </div>
            </td>
            <td>
                  <code>&lt;llama_index.core.agent.react.output_parser.ReActOutputParser object at 0x0000022D834C9AC0&gt;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>formatter</code>
            </td>
            <td>
                  <code><span title="llama_index.core.agent.react.formatter.ReActChatFormatter">ReActChatFormatter</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The react chat formatter to format the reasoning steps and chat history into an llm input.</p>
              </div>
            </td>
            <td>
                  <code>ReActChatFormatter(system_header=&#39;You are designed to help with a variety of tasks, from answering questions to providing summaries to other types of analyses.\n\n## Tools\n\nYou have access to a wide variety of tools. You are responsible for using the tools in any sequence you deem appropriate to complete the task at hand.\nThis may require breaking the task into subtasks and using different tools to complete each subtask.\n\nYou have access to the following tools:\n{tool_desc}\n\n\n## Output Format\n\nPlease answer in the same language as the question and use the following format:\n\n```\nThought: The current language of the user is: (user\&#39;s language). I need to use a tool to help me answer the question.\nAction: tool name (one of {tool_names}) if using a tool.\nAction Input: the input to the tool, in a JSON format representing the kwargs (e.g. {{&#34;input&#34;: &#34;hello world&#34;, &#34;num_beams&#34;: 5}})\n```\n\nPlease ALWAYS start with a Thought.\n\nNEVER surround your response with markdown code markers. You may use code markers within your response if you need to.\n\nPlease use a valid JSON format for the Action Input. Do NOT do this {{\&#39;input\&#39;: \&#39;hello world\&#39;, \&#39;num_beams\&#39;: 5}}. If you include the &#34;Action:&#34; line, then you MUST include the &#34;Action Input:&#34; line too, even if the tool does not need kwargs, in that case you MUST use &#34;Action Input: {{}}&#34;.\n\nIf this format is used, the tool will respond in the following format:\n\n```\nObservation: tool response\n```\n\nYou should keep repeating the above format till you have enough information to answer the question without using any more tools. At that point, you MUST respond in one of the following two formats:\n\n```\nThought: I can answer without using any more tools. I\&#39;ll use the user\&#39;s language to answer\nAnswer: [your answer here (In the same language as the user\&#39;s question)]\n```\n\n```\nThought: I cannot answer the question with the provided tools.\nAnswer: [your answer here (In the same language as the user\&#39;s question)]\n```\n\n## Current Conversation\n\nBelow is the current conversation consisting of interleaving human and assistant messages.\n&#39;, context=&#39;&#39;, observation_role=&lt;MessageRole.USER: &#39;user&#39;&gt;)</code>
            </td>
          </tr>
      </tbody>
    </table>






              <details class="quote">
                <summary>Source code in <code>llama_index\core\agent\workflow\react_agent.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">ReActAgent</span><span class="p">(</span><span class="n">BaseWorkflowAgent</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;React agent implementation.&quot;&quot;&quot;</span>

    <span class="n">reasoning_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;current_reasoning&quot;</span>
    <span class="n">output_parser</span><span class="p">:</span> <span class="n">ReActOutputParser</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="n">ReActOutputParser</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The react output parser&quot;</span>
    <span class="p">)</span>
    <span class="n">formatter</span><span class="p">:</span> <span class="n">ReActChatFormatter</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="n">default_formatter</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The react chat formatter to format the reasoning steps and chat history into an llm input.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="nd">@model_validator</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;after&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">validate_formatter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ReActAgent&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate the formatter.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">formatter</span><span class="o">.</span><span class="n">context</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatter</span><span class="o">.</span><span class="n">context</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">formatter</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatter</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatter</span><span class="o">.</span><span class="n">context</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">formatter</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">_get_prompts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PromptDictType</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get prompts.&quot;&quot;&quot;</span>
        <span class="c1"># TODO: the ReAct formatter does not explicitly specify PromptTemplate</span>
        <span class="c1"># objects, but wrap it in this to obey the interface</span>
        <span class="n">react_header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatter</span><span class="o">.</span><span class="n">system_header</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;react_header&quot;</span><span class="p">:</span> <span class="n">PromptTemplate</span><span class="p">(</span><span class="n">react_header</span><span class="p">)}</span>

    <span class="k">def</span> <span class="nf">_update_prompts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompts</span><span class="p">:</span> <span class="n">PromptDictType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update prompts.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;react_header&quot;</span> <span class="ow">in</span> <span class="n">prompts</span><span class="p">:</span>
            <span class="n">react_header</span> <span class="o">=</span> <span class="n">prompts</span><span class="p">[</span><span class="s2">&quot;react_header&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">react_header</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">react_header</span> <span class="o">=</span> <span class="n">PromptTemplate</span><span class="p">(</span><span class="n">react_header</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">formatter</span><span class="o">.</span><span class="n">system_header</span> <span class="o">=</span> <span class="n">react_header</span><span class="o">.</span><span class="n">get_template</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">take_step</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span>
        <span class="n">llm_input</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span>
        <span class="n">tools</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">AsyncBaseTool</span><span class="p">],</span>
        <span class="n">memory</span><span class="p">:</span> <span class="n">BaseMemory</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentOutput</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Take a single step with the React agent.&quot;&quot;&quot;</span>
        <span class="c1"># remove system prompt, since the react prompt will be combined with it</span>
        <span class="k">if</span> <span class="n">llm_input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;system&quot;</span><span class="p">:</span>
            <span class="n">system_prompt</span> <span class="o">=</span> <span class="n">llm_input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">content</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
            <span class="n">llm_input</span> <span class="o">=</span> <span class="n">llm_input</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">system_prompt</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="n">output_parser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_parser</span>
        <span class="n">react_chat_formatter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatter</span>

        <span class="c1"># Format initial chat input</span>
        <span class="n">current_reasoning</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">BaseReasoningStep</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reasoning_key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[]</span>
        <span class="p">)</span>
        <span class="n">input_chat</span> <span class="o">=</span> <span class="n">react_chat_formatter</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">tools</span><span class="p">,</span>
            <span class="n">chat_history</span><span class="o">=</span><span class="n">llm_input</span><span class="p">,</span>
            <span class="n">current_reasoning</span><span class="o">=</span><span class="n">current_reasoning</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">write_event_to_stream</span><span class="p">(</span>
            <span class="n">AgentInput</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">input_chat</span><span class="p">,</span> <span class="n">current_agent_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Initial LLM call</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">astream_chat</span><span class="p">(</span><span class="n">input_chat</span><span class="p">)</span>
        <span class="c1"># last_chat_response will be used later, after the loop.</span>
        <span class="c1"># We initialize it so it&#39;s valid even when &#39;response&#39; is empty</span>
        <span class="n">last_chat_response</span> <span class="o">=</span> <span class="n">ChatResponse</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">ChatMessage</span><span class="p">())</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">last_chat_response</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">last_chat_response</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">last_chat_response</span><span class="o">.</span><span class="n">raw</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">)</span>
                <span class="k">else</span> <span class="n">last_chat_response</span><span class="o">.</span><span class="n">raw</span>
            <span class="p">)</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">write_event_to_stream</span><span class="p">(</span>
                <span class="n">AgentStream</span><span class="p">(</span>
                    <span class="n">delta</span><span class="o">=</span><span class="n">last_chat_response</span><span class="o">.</span><span class="n">delta</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="n">response</span><span class="o">=</span><span class="n">last_chat_response</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="n">raw</span><span class="o">=</span><span class="n">raw</span><span class="p">,</span>
                    <span class="n">current_agent_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Parse reasoning step and check if done</span>
        <span class="n">message_content</span> <span class="o">=</span> <span class="n">last_chat_response</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">message_content</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Got empty message&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">reasoning_step</span> <span class="o">=</span> <span class="n">output_parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">message_content</span><span class="p">,</span> <span class="n">is_streaming</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error: Could not parse output. Please follow the thought-action-input format. Try again. Details: </span><span class="si">{</span><span class="n">e</span><span class="si">!s}</span><span class="s2">&quot;</span>

            <span class="n">raw</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">last_chat_response</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">last_chat_response</span><span class="o">.</span><span class="n">raw</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">)</span>
                <span class="k">else</span> <span class="n">last_chat_response</span><span class="o">.</span><span class="n">raw</span>
            <span class="p">)</span>
            <span class="c1"># Return with retry messages to let the LLM fix the error</span>
            <span class="k">return</span> <span class="n">AgentOutput</span><span class="p">(</span>
                <span class="n">response</span><span class="o">=</span><span class="n">last_chat_response</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
                <span class="n">raw</span><span class="o">=</span><span class="n">raw</span><span class="p">,</span>
                <span class="n">current_agent_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">retry_messages</span><span class="o">=</span><span class="p">[</span>
                    <span class="n">last_chat_response</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
                    <span class="n">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">error_msg</span><span class="p">),</span>
                <span class="p">],</span>
            <span class="p">)</span>

        <span class="c1"># add to reasoning if not a handoff</span>
        <span class="n">current_reasoning</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reasoning_step</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reasoning_key</span><span class="p">,</span> <span class="n">current_reasoning</span><span class="p">)</span>

        <span class="c1"># If response step, we&#39;re done</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">last_chat_response</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">last_chat_response</span><span class="o">.</span><span class="n">raw</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">)</span>
            <span class="k">else</span> <span class="n">last_chat_response</span><span class="o">.</span><span class="n">raw</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">reasoning_step</span><span class="o">.</span><span class="n">is_done</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">AgentOutput</span><span class="p">(</span>
                <span class="n">response</span><span class="o">=</span><span class="n">last_chat_response</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
                <span class="n">raw</span><span class="o">=</span><span class="n">raw</span><span class="p">,</span>
                <span class="n">current_agent_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">reasoning_step</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">ActionReasoningStep</span><span class="p">,</span> <span class="n">reasoning_step</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reasoning_step</span><span class="p">,</span> <span class="n">ActionReasoningStep</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected ActionReasoningStep, got </span><span class="si">{</span><span class="n">reasoning_step</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Create tool call</span>
        <span class="n">tool_calls</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">ToolSelection</span><span class="p">(</span>
                <span class="n">tool_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
                <span class="n">tool_name</span><span class="o">=</span><span class="n">reasoning_step</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
                <span class="n">tool_kwargs</span><span class="o">=</span><span class="n">reasoning_step</span><span class="o">.</span><span class="n">action_input</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">]</span>

        <span class="k">return</span> <span class="n">AgentOutput</span><span class="p">(</span>
            <span class="n">response</span><span class="o">=</span><span class="n">last_chat_response</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
            <span class="n">tool_calls</span><span class="o">=</span><span class="n">tool_calls</span><span class="p">,</span>
            <span class="n">raw</span><span class="o">=</span><span class="n">raw</span><span class="p">,</span>
            <span class="n">current_agent_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">handle_tool_call_results</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolCallResult</span><span class="p">],</span> <span class="n">memory</span><span class="p">:</span> <span class="n">BaseMemory</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle tool call results for React agent.&quot;&quot;&quot;</span>
        <span class="n">current_reasoning</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">BaseReasoningStep</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reasoning_key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[]</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">tool_call_result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">obs_step</span> <span class="o">=</span> <span class="n">ObservationReasoningStep</span><span class="p">(</span>
                <span class="n">observation</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">tool_call_result</span><span class="o">.</span><span class="n">tool_output</span><span class="o">.</span><span class="n">content</span><span class="p">),</span>
                <span class="n">return_direct</span><span class="o">=</span><span class="n">tool_call_result</span><span class="o">.</span><span class="n">return_direct</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">current_reasoning</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obs_step</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="n">tool_call_result</span><span class="o">.</span><span class="n">return_direct</span>
                <span class="ow">and</span> <span class="n">tool_call_result</span><span class="o">.</span><span class="n">tool_name</span> <span class="o">!=</span> <span class="s2">&quot;handoff&quot;</span>
            <span class="p">):</span>
                <span class="n">current_reasoning</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">ResponseReasoningStep</span><span class="p">(</span>
                        <span class="n">thought</span><span class="o">=</span><span class="n">obs_step</span><span class="o">.</span><span class="n">observation</span><span class="p">,</span>
                        <span class="n">response</span><span class="o">=</span><span class="n">obs_step</span><span class="o">.</span><span class="n">observation</span><span class="p">,</span>
                        <span class="n">is_streaming</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">break</span>

        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reasoning_key</span><span class="p">,</span> <span class="n">current_reasoning</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">finalize</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">AgentOutput</span><span class="p">,</span> <span class="n">memory</span><span class="p">:</span> <span class="n">BaseMemory</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentOutput</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Finalize the React agent.&quot;&quot;&quot;</span>
        <span class="n">current_reasoning</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">BaseReasoningStep</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reasoning_key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[]</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_reasoning</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">current_reasoning</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">ResponseReasoningStep</span>
        <span class="p">):</span>
            <span class="n">reasoning_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">get_content</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">current_reasoning</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">reasoning_str</span><span class="p">:</span>
                <span class="n">reasoning_msg</span> <span class="o">=</span> <span class="n">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;assistant&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">reasoning_str</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">memory</span><span class="o">.</span><span class="n">aput</span><span class="p">(</span><span class="n">reasoning_msg</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reasoning_key</span><span class="p">,</span> <span class="p">[])</span>

            <span class="c1"># remove &quot;Answer:&quot; from the response</span>
            <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">content</span> <span class="ow">and</span> <span class="s2">&quot;Answer:&quot;</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
                <span class="n">start_idx</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Answer:&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">start_idx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">[</span>
                        <span class="n">start_idx</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="s2">&quot;Answer:&quot;</span><span class="p">)</span> <span class="p">:</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

            <span class="c1"># clear scratchpad</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reasoning_key</span><span class="p">,</span> <span class="p">[])</span>

        <span class="k">return</span> <span class="n">output</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="llama_index.core.agent.workflow.ReActAgent.validate_formatter" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">validate_formatter</span>


<a href="#llama_index.core.agent.workflow.ReActAgent.validate_formatter" class="headerlink" title="Permanent link">#</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">validate_formatter</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.agent.workflow.react_agent.ReActAgent" href="#llama_index.core.agent.workflow.ReActAgent">ReActAgent</a></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Validate the formatter.</p>

            <details class="quote">
              <summary>Source code in <code>llama_index\core\agent\workflow\react_agent.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@model_validator</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;after&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">validate_formatter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ReActAgent&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate the formatter.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">formatter</span><span class="o">.</span><span class="n">context</span>
        <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span>
        <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatter</span><span class="o">.</span><span class="n">context</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">formatter</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatter</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatter</span><span class="o">.</span><span class="n">context</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">formatter</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span>

    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="llama_index.core.agent.workflow.ReActAgent.take_step" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">take_step</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#llama_index.core.agent.workflow.ReActAgent.take_step" class="headerlink" title="Permanent link">#</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">take_step</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.workflow.Context" href="../workflow/context/#workflows.context.Context">Context</a></span><span class="p">,</span> <span class="n">llm_input</span><span class="p">:</span> <span class="n"><span title="typing.List">List</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.llms.ChatMessage" href="../llms/#llama_index.core.base.llms.types.ChatMessage">ChatMessage</a></span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n"><span title="typing.Sequence">Sequence</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.tools.AsyncBaseTool" href="../tools/#llama_index.core.tools.types.AsyncBaseTool">AsyncBaseTool</a></span><span class="p">],</span> <span class="n">memory</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.memory.BaseMemory" href="../memory/#llama_index.core.memory.types.BaseMemory">BaseMemory</a></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.agent.workflow.workflow_events.AgentOutput" href="#llama_index.core.agent.workflow.AgentOutput">AgentOutput</a></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Take a single step with the React agent.</p>

            <details class="quote">
              <summary>Source code in <code>llama_index\core\agent\workflow\react_agent.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">take_step</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span>
    <span class="n">llm_input</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span>
    <span class="n">tools</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">AsyncBaseTool</span><span class="p">],</span>
    <span class="n">memory</span><span class="p">:</span> <span class="n">BaseMemory</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentOutput</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Take a single step with the React agent.&quot;&quot;&quot;</span>
    <span class="c1"># remove system prompt, since the react prompt will be combined with it</span>
    <span class="k">if</span> <span class="n">llm_input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;system&quot;</span><span class="p">:</span>
        <span class="n">system_prompt</span> <span class="o">=</span> <span class="n">llm_input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">content</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="n">llm_input</span> <span class="o">=</span> <span class="n">llm_input</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">system_prompt</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="n">output_parser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_parser</span>
    <span class="n">react_chat_formatter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatter</span>

    <span class="c1"># Format initial chat input</span>
    <span class="n">current_reasoning</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">BaseReasoningStep</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reasoning_key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[]</span>
    <span class="p">)</span>
    <span class="n">input_chat</span> <span class="o">=</span> <span class="n">react_chat_formatter</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">tools</span><span class="p">,</span>
        <span class="n">chat_history</span><span class="o">=</span><span class="n">llm_input</span><span class="p">,</span>
        <span class="n">current_reasoning</span><span class="o">=</span><span class="n">current_reasoning</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">write_event_to_stream</span><span class="p">(</span>
        <span class="n">AgentInput</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">input_chat</span><span class="p">,</span> <span class="n">current_agent_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Initial LLM call</span>
    <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">astream_chat</span><span class="p">(</span><span class="n">input_chat</span><span class="p">)</span>
    <span class="c1"># last_chat_response will be used later, after the loop.</span>
    <span class="c1"># We initialize it so it&#39;s valid even when &#39;response&#39; is empty</span>
    <span class="n">last_chat_response</span> <span class="o">=</span> <span class="n">ChatResponse</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">ChatMessage</span><span class="p">())</span>
    <span class="k">async</span> <span class="k">for</span> <span class="n">last_chat_response</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">last_chat_response</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">last_chat_response</span><span class="o">.</span><span class="n">raw</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">)</span>
            <span class="k">else</span> <span class="n">last_chat_response</span><span class="o">.</span><span class="n">raw</span>
        <span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">write_event_to_stream</span><span class="p">(</span>
            <span class="n">AgentStream</span><span class="p">(</span>
                <span class="n">delta</span><span class="o">=</span><span class="n">last_chat_response</span><span class="o">.</span><span class="n">delta</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">response</span><span class="o">=</span><span class="n">last_chat_response</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">raw</span><span class="o">=</span><span class="n">raw</span><span class="p">,</span>
                <span class="n">current_agent_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># Parse reasoning step and check if done</span>
    <span class="n">message_content</span> <span class="o">=</span> <span class="n">last_chat_response</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">message_content</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Got empty message&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">reasoning_step</span> <span class="o">=</span> <span class="n">output_parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">message_content</span><span class="p">,</span> <span class="n">is_streaming</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error: Could not parse output. Please follow the thought-action-input format. Try again. Details: </span><span class="si">{</span><span class="n">e</span><span class="si">!s}</span><span class="s2">&quot;</span>

        <span class="n">raw</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">last_chat_response</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">last_chat_response</span><span class="o">.</span><span class="n">raw</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">)</span>
            <span class="k">else</span> <span class="n">last_chat_response</span><span class="o">.</span><span class="n">raw</span>
        <span class="p">)</span>
        <span class="c1"># Return with retry messages to let the LLM fix the error</span>
        <span class="k">return</span> <span class="n">AgentOutput</span><span class="p">(</span>
            <span class="n">response</span><span class="o">=</span><span class="n">last_chat_response</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
            <span class="n">raw</span><span class="o">=</span><span class="n">raw</span><span class="p">,</span>
            <span class="n">current_agent_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">retry_messages</span><span class="o">=</span><span class="p">[</span>
                <span class="n">last_chat_response</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
                <span class="n">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">error_msg</span><span class="p">),</span>
            <span class="p">],</span>
        <span class="p">)</span>

    <span class="c1"># add to reasoning if not a handoff</span>
    <span class="n">current_reasoning</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reasoning_step</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reasoning_key</span><span class="p">,</span> <span class="n">current_reasoning</span><span class="p">)</span>

    <span class="c1"># If response step, we&#39;re done</span>
    <span class="n">raw</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">last_chat_response</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">last_chat_response</span><span class="o">.</span><span class="n">raw</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">)</span>
        <span class="k">else</span> <span class="n">last_chat_response</span><span class="o">.</span><span class="n">raw</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">reasoning_step</span><span class="o">.</span><span class="n">is_done</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">AgentOutput</span><span class="p">(</span>
            <span class="n">response</span><span class="o">=</span><span class="n">last_chat_response</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
            <span class="n">raw</span><span class="o">=</span><span class="n">raw</span><span class="p">,</span>
            <span class="n">current_agent_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">reasoning_step</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">ActionReasoningStep</span><span class="p">,</span> <span class="n">reasoning_step</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reasoning_step</span><span class="p">,</span> <span class="n">ActionReasoningStep</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected ActionReasoningStep, got </span><span class="si">{</span><span class="n">reasoning_step</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Create tool call</span>
    <span class="n">tool_calls</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">ToolSelection</span><span class="p">(</span>
            <span class="n">tool_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
            <span class="n">tool_name</span><span class="o">=</span><span class="n">reasoning_step</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
            <span class="n">tool_kwargs</span><span class="o">=</span><span class="n">reasoning_step</span><span class="o">.</span><span class="n">action_input</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">]</span>

    <span class="k">return</span> <span class="n">AgentOutput</span><span class="p">(</span>
        <span class="n">response</span><span class="o">=</span><span class="n">last_chat_response</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
        <span class="n">tool_calls</span><span class="o">=</span><span class="n">tool_calls</span><span class="p">,</span>
        <span class="n">raw</span><span class="o">=</span><span class="n">raw</span><span class="p">,</span>
        <span class="n">current_agent_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="llama_index.core.agent.workflow.ReActAgent.handle_tool_call_results" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">handle_tool_call_results</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#llama_index.core.agent.workflow.ReActAgent.handle_tool_call_results" class="headerlink" title="Permanent link">#</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">handle_tool_call_results</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.workflow.Context" href="../workflow/context/#workflows.context.Context">Context</a></span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n"><span title="typing.List">List</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.agent.workflow.workflow_events.ToolCallResult" href="#llama_index.core.agent.workflow.ToolCallResult">ToolCallResult</a></span><span class="p">],</span> <span class="n">memory</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.memory.BaseMemory" href="../memory/#llama_index.core.memory.types.BaseMemory">BaseMemory</a></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Handle tool call results for React agent.</p>

            <details class="quote">
              <summary>Source code in <code>llama_index\core\agent\workflow\react_agent.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">handle_tool_call_results</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolCallResult</span><span class="p">],</span> <span class="n">memory</span><span class="p">:</span> <span class="n">BaseMemory</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle tool call results for React agent.&quot;&quot;&quot;</span>
    <span class="n">current_reasoning</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">BaseReasoningStep</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reasoning_key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[]</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">tool_call_result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="n">obs_step</span> <span class="o">=</span> <span class="n">ObservationReasoningStep</span><span class="p">(</span>
            <span class="n">observation</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">tool_call_result</span><span class="o">.</span><span class="n">tool_output</span><span class="o">.</span><span class="n">content</span><span class="p">),</span>
            <span class="n">return_direct</span><span class="o">=</span><span class="n">tool_call_result</span><span class="o">.</span><span class="n">return_direct</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">current_reasoning</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obs_step</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">tool_call_result</span><span class="o">.</span><span class="n">return_direct</span>
            <span class="ow">and</span> <span class="n">tool_call_result</span><span class="o">.</span><span class="n">tool_name</span> <span class="o">!=</span> <span class="s2">&quot;handoff&quot;</span>
        <span class="p">):</span>
            <span class="n">current_reasoning</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">ResponseReasoningStep</span><span class="p">(</span>
                    <span class="n">thought</span><span class="o">=</span><span class="n">obs_step</span><span class="o">.</span><span class="n">observation</span><span class="p">,</span>
                    <span class="n">response</span><span class="o">=</span><span class="n">obs_step</span><span class="o">.</span><span class="n">observation</span><span class="p">,</span>
                    <span class="n">is_streaming</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">break</span>

    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reasoning_key</span><span class="p">,</span> <span class="n">current_reasoning</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="llama_index.core.agent.workflow.ReActAgent.finalize" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">finalize</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#llama_index.core.agent.workflow.ReActAgent.finalize" class="headerlink" title="Permanent link">#</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">finalize</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.workflow.Context" href="../workflow/context/#workflows.context.Context">Context</a></span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.agent.workflow.workflow_events.AgentOutput" href="#llama_index.core.agent.workflow.AgentOutput">AgentOutput</a></span><span class="p">,</span> <span class="n">memory</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.memory.BaseMemory" href="../memory/#llama_index.core.memory.types.BaseMemory">BaseMemory</a></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.agent.workflow.workflow_events.AgentOutput" href="#llama_index.core.agent.workflow.AgentOutput">AgentOutput</a></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Finalize the React agent.</p>

            <details class="quote">
              <summary>Source code in <code>llama_index\core\agent\workflow\react_agent.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">finalize</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">AgentOutput</span><span class="p">,</span> <span class="n">memory</span><span class="p">:</span> <span class="n">BaseMemory</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentOutput</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Finalize the React agent.&quot;&quot;&quot;</span>
    <span class="n">current_reasoning</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">BaseReasoningStep</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reasoning_key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[]</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_reasoning</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
        <span class="n">current_reasoning</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">ResponseReasoningStep</span>
    <span class="p">):</span>
        <span class="n">reasoning_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">get_content</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">current_reasoning</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">reasoning_str</span><span class="p">:</span>
            <span class="n">reasoning_msg</span> <span class="o">=</span> <span class="n">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;assistant&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">reasoning_str</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">memory</span><span class="o">.</span><span class="n">aput</span><span class="p">(</span><span class="n">reasoning_msg</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reasoning_key</span><span class="p">,</span> <span class="p">[])</span>

        <span class="c1"># remove &quot;Answer:&quot; from the response</span>
        <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">content</span> <span class="ow">and</span> <span class="s2">&quot;Answer:&quot;</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
            <span class="n">start_idx</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Answer:&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">start_idx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">output</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">[</span>
                    <span class="n">start_idx</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="s2">&quot;Answer:&quot;</span><span class="p">)</span> <span class="p">:</span>
                <span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="c1"># clear scratchpad</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reasoning_key</span><span class="p">,</span> <span class="p">[])</span>

    <span class="k">return</span> <span class="n">output</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="llama_index.core.agent.workflow.CodeActAgent" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">CodeActAgent</span>


<a href="#llama_index.core.agent.workflow.CodeActAgent" class="headerlink" title="Permanent link">#</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="llama_index.core.agent.workflow.base_agent.BaseWorkflowAgent" href="#llama_index.core.agent.workflow.BaseWorkflowAgent">BaseWorkflowAgent</a></code></p>


        <p>A workflow agent that can execute code.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>scratchpad_key</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                  <code>&#39;scratchpad&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>code_execute_fn</code>
            </td>
            <td>
                  <code><span title="typing.Callable">Callable</span> | <span title="typing.Awaitable">Awaitable</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The function to execute code. Required in order to execute code generated by the agent.
The function protocol is as follows: async def code_execute_fn(code: str) -&gt; Dict[str, Any]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>code_act_system_prompt</code>
            </td>
            <td>
                  <code>str | <a class="autorefs autorefs-internal" title="llama_index.core.prompts.BasePromptTemplate" href="../prompts/#llama_index.core.prompts.BasePromptTemplate">BasePromptTemplate</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The system prompt for the code act agent.</p>
              </div>
            </td>
            <td>
                  <code>&#39;You are a helpful AI assistant that can write and execute Python code to solve problems.\n\nYou will be given a task to perform. You should output:\n- Python code wrapped in &lt;execute&gt;...&lt;/execute&gt; tags that provides the solution to the task, or a step towards the solution. Any output you want to extract from the code should be printed to the console.\n- Text to be shown directly to the user, if you want to ask for more information or provide the final answer.\n- If the previous code execution can be used to respond to the user, then respond directly (typically you want to avoid mentioning anything related to the code execution in your response).\n\n## Response Format:\nExample of proper code format:\n&lt;execute&gt;\nimport math\n\ndef calculate_area(radius):\n    return math.pi * radius**2\n\n# Calculate the area for radius = 5\narea = calculate_area(5)\nprint(f&#34;The area of the circle is {area:.2f} square units&#34;)\n&lt;/execute&gt;\n\nIn addition to the Python Standard Library and any functions you have already written, you can use the following functions:\n{tool_descriptions}\n\nVariables defined at the top level of previous code snippets can be also be referenced in your code.\n\n## Final Answer Guidelines:\n- When providing a final answer, focus on directly answering the user\&#39;s question\n- Avoid referencing the code you generated unless specifically asked\n- Present the results clearly and concisely as if you computed them directly\n- If relevant, you can briefly mention general methods used, but don\&#39;t include code snippets in the final answer\n- Structure your response like you\&#39;re directly answering the user\&#39;s query, not explaining how you solved it\n\nReminder: Always place your Python code between &lt;execute&gt;...&lt;/execute&gt; tags when you want to run code. You can include explanations and other content outside these tags.\n&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>






              <details class="quote">
                <summary>Source code in <code>llama_index\core\agent\workflow\codeact_agent.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">CodeActAgent</span><span class="p">(</span><span class="n">BaseWorkflowAgent</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A workflow agent that can execute code.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">scratchpad_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;scratchpad&quot;</span>

    <span class="n">code_execute_fn</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="n">Awaitable</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;The function to execute code. Required in order to execute code generated by the agent.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;The function protocol is as follows: async def code_execute_fn(code: str) -&gt; Dict[str, Any]&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="n">code_act_system_prompt</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">BasePromptTemplate</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_CODE_ACT_PROMPT</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The system prompt for the code act agent.&quot;</span><span class="p">,</span>
        <span class="n">validate_default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">code_execute_fn</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="n">Awaitable</span><span class="p">],</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;code_act_agent&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;A workflow agent that can execute code.&quot;</span><span class="p">,</span>
        <span class="n">system_prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tools</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">BaseTool</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tool_retriever</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ObjectRetriever</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">can_handoff_to</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">llm</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LLM</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">code_act_system_prompt</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
            <span class="nb">str</span><span class="p">,</span> <span class="n">BasePromptTemplate</span>
        <span class="p">]</span> <span class="o">=</span> <span class="n">DEFAULT_CODE_ACT_PROMPT</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">tools</span> <span class="o">=</span> <span class="n">tools</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">tools</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
            <span class="n">FunctionTool</span><span class="o">.</span><span class="n">from_defaults</span><span class="p">(</span><span class="n">code_execute_fn</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">EXECUTE_TOOL_NAME</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">code_act_system_prompt</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">system_prompt</span><span class="p">:</span>
                <span class="n">code_act_system_prompt</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">system_prompt</span>
            <span class="n">code_act_system_prompt</span> <span class="o">=</span> <span class="n">PromptTemplate</span><span class="p">(</span><span class="n">code_act_system_prompt</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">code_act_system_prompt</span><span class="p">,</span> <span class="n">BasePromptTemplate</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">system_prompt</span><span class="p">:</span>
                <span class="n">code_act_system_str</span> <span class="o">=</span> <span class="n">code_act_system_prompt</span><span class="o">.</span><span class="n">get_template</span><span class="p">()</span>
                <span class="n">code_act_system_str</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">system_prompt</span>
            <span class="n">code_act_system_prompt</span> <span class="o">=</span> <span class="n">PromptTemplate</span><span class="p">(</span><span class="n">code_act_system_str</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
            <span class="n">system_prompt</span><span class="o">=</span><span class="n">system_prompt</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
            <span class="n">tool_retriever</span><span class="o">=</span><span class="n">tool_retriever</span><span class="p">,</span>
            <span class="n">can_handoff_to</span><span class="o">=</span><span class="n">can_handoff_to</span><span class="p">,</span>
            <span class="n">llm</span><span class="o">=</span><span class="n">llm</span><span class="p">,</span>
            <span class="n">code_act_system_prompt</span><span class="o">=</span><span class="n">code_act_system_prompt</span><span class="p">,</span>
            <span class="n">code_execute_fn</span><span class="o">=</span><span class="n">code_execute_fn</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_tool_fns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">BaseTool</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Callable</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the tool functions while validating that they are valid tools for the CodeActAgent.&quot;&quot;&quot;</span>
        <span class="n">callables</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">tool</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;handoff&quot;</span>
                <span class="ow">or</span> <span class="n">tool</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">EXECUTE_TOOL_NAME</span>
            <span class="p">):</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">FunctionTool</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">tool</span><span class="o">.</span><span class="n">requires_context</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Tool </span><span class="si">{</span><span class="n">tool</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> requires context. &quot;</span>
                        <span class="s2">&quot;CodeActAgent only supports tools that do not require context.&quot;</span>
                    <span class="p">)</span>

                <span class="n">callables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tool</span><span class="o">.</span><span class="n">real_fn</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Tool </span><span class="si">{</span><span class="n">tool</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> is not a FunctionTool. &quot;</span>
                    <span class="s2">&quot;CodeActAgent only supports Functions and FunctionTools.&quot;</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">callables</span>

    <span class="k">def</span> <span class="nf">_extract_code_from_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract code from the LLM response using XML-style &lt;execute&gt; tags.</span>

<span class="sd">        Args:</span>
<span class="sd">            response_text: The LLM response text</span>

<span class="sd">        Returns:</span>
<span class="sd">            Extracted code or None if no code found</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Match content between &lt;execute&gt; and &lt;/execute&gt; tags</span>
        <span class="n">execute_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&lt;execute&gt;(.*?)&lt;/execute&gt;&quot;</span>
        <span class="n">execute_matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">execute_pattern</span><span class="p">,</span> <span class="n">response_text</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">execute_matches</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">execute_matches</span><span class="p">])</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_get_tool_descriptions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">BaseTool</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate tool descriptions for the system prompt using tool metadata.</span>

<span class="sd">        Args:</span>
<span class="sd">            tools: List of available tools</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tool descriptions as a string</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tool_descriptions</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">tool_fns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_tool_fns</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">tool_fns</span><span class="p">:</span>
            <span class="n">signature</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
            <span class="n">fn_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="n">docstring</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>

            <span class="n">tool_description</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;def </span><span class="si">{</span><span class="n">fn_name</span><span class="si">}{</span><span class="n">signature</span><span class="si">!s}</span><span class="s2">:&quot;</span>
            <span class="k">if</span> <span class="n">docstring</span><span class="p">:</span>
                <span class="n">tool_description</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  &quot;&quot;&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">docstring</span><span class="si">}</span><span class="se">\n</span><span class="s1">  &quot;&quot;&quot;</span><span class="se">\n</span><span class="s1">&#39;</span>

            <span class="n">tool_description</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  ...</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">tool_descriptions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tool_description</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tool_descriptions</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">take_step</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span>
        <span class="n">llm_input</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span>
        <span class="n">tools</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">BaseTool</span><span class="p">],</span>
        <span class="n">memory</span><span class="p">:</span> <span class="n">BaseMemory</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentOutput</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Take a single step with the code act agent.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">code_execute_fn</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;code_execute_fn must be provided for CodeActAgent&quot;</span><span class="p">)</span>

        <span class="c1"># Get current scratchpad</span>
        <span class="n">scratchpad</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scratchpad_key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[]</span>
        <span class="p">)</span>
        <span class="n">current_llm_input</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">llm_input</span><span class="p">,</span> <span class="o">*</span><span class="n">scratchpad</span><span class="p">]</span>

        <span class="c1"># Create a system message with tool descriptions</span>
        <span class="n">tool_descriptions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_tool_descriptions</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
        <span class="n">system_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">code_act_system_prompt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">tool_descriptions</span><span class="o">=</span><span class="n">tool_descriptions</span>
        <span class="p">)</span>

        <span class="c1"># Add or overwrite system message</span>
        <span class="n">has_system</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">msg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">current_llm_input</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">role</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;system&quot;</span><span class="p">:</span>
                <span class="n">current_llm_input</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">system_prompt</span><span class="p">)</span>
                <span class="n">has_system</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">has_system</span><span class="p">:</span>
            <span class="n">current_llm_input</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
                <span class="mi">0</span><span class="p">,</span> <span class="n">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">system_prompt</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Write the input to the event stream</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">write_event_to_stream</span><span class="p">(</span>
            <span class="n">AgentInput</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">current_llm_input</span><span class="p">,</span> <span class="n">current_agent_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># For now, only support the handoff tool</span>
        <span class="c1"># All other tools should be part of the code execution</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">tool</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;handoff&quot;</span> <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="p">,</span> <span class="n">FunctionCallingLLM</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;llm must be a function calling LLM to use handoff&quot;</span><span class="p">)</span>

            <span class="n">tools</span> <span class="o">=</span> <span class="p">[</span><span class="n">tool</span> <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">tools</span> <span class="k">if</span> <span class="n">tool</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;handoff&quot;</span><span class="p">]</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">astream_chat_with_tools</span><span class="p">(</span>
                <span class="n">tools</span><span class="p">,</span> <span class="n">chat_history</span><span class="o">=</span><span class="n">current_llm_input</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">astream_chat</span><span class="p">(</span><span class="n">current_llm_input</span><span class="p">)</span>

        <span class="c1"># Initialize for streaming</span>
        <span class="n">last_chat_response</span> <span class="o">=</span> <span class="n">ChatResponse</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">ChatMessage</span><span class="p">())</span>
        <span class="n">full_response_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># Process streaming response</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">last_chat_response</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="n">last_chat_response</span><span class="o">.</span><span class="n">delta</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
            <span class="n">full_response_text</span> <span class="o">+=</span> <span class="n">delta</span>

            <span class="c1"># Create a raw object for the event stream</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">last_chat_response</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">last_chat_response</span><span class="o">.</span><span class="n">raw</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">)</span>
                <span class="k">else</span> <span class="n">last_chat_response</span><span class="o">.</span><span class="n">raw</span>
            <span class="p">)</span>

            <span class="c1"># Write delta to the event stream</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">write_event_to_stream</span><span class="p">(</span>
                <span class="n">AgentStream</span><span class="p">(</span>
                    <span class="n">delta</span><span class="o">=</span><span class="n">delta</span><span class="p">,</span>
                    <span class="n">response</span><span class="o">=</span><span class="n">full_response_text</span><span class="p">,</span>
                    <span class="c1"># We&#39;ll add the tool call after processing the full response</span>
                    <span class="n">tool_calls</span><span class="o">=</span><span class="p">[],</span>
                    <span class="n">raw</span><span class="o">=</span><span class="n">raw</span><span class="p">,</span>
                    <span class="n">current_agent_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Extract code from the response</span>
        <span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_code_from_response</span><span class="p">(</span><span class="n">full_response_text</span><span class="p">)</span>

        <span class="c1"># Create a tool call for executing the code if code was found</span>
        <span class="n">tool_calls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">code</span><span class="p">:</span>
            <span class="n">tool_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>

            <span class="n">tool_calls</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ToolSelection</span><span class="p">(</span>
                    <span class="n">tool_id</span><span class="o">=</span><span class="n">tool_id</span><span class="p">,</span>
                    <span class="n">tool_name</span><span class="o">=</span><span class="n">EXECUTE_TOOL_NAME</span><span class="p">,</span>
                    <span class="n">tool_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="n">code</span><span class="p">},</span>
                <span class="p">)</span>
            <span class="p">]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="p">,</span> <span class="n">FunctionCallingLLM</span><span class="p">):</span>
            <span class="n">extra_tool_calls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">get_tool_calls_from_response</span><span class="p">(</span>
                <span class="n">last_chat_response</span><span class="p">,</span> <span class="n">error_on_no_tool_call</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            <span class="n">tool_calls</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">extra_tool_calls</span><span class="p">)</span>

        <span class="c1"># Add the response to the scratchpad</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;assistant&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">full_response_text</span><span class="p">)</span>
        <span class="n">scratchpad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scratchpad_key</span><span class="p">,</span> <span class="n">scratchpad</span><span class="p">)</span>

        <span class="c1"># Create the raw object for the output</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">last_chat_response</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">last_chat_response</span><span class="o">.</span><span class="n">raw</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">)</span>
            <span class="k">else</span> <span class="n">last_chat_response</span><span class="o">.</span><span class="n">raw</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">AgentOutput</span><span class="p">(</span>
            <span class="n">response</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
            <span class="n">tool_calls</span><span class="o">=</span><span class="n">tool_calls</span><span class="p">,</span>
            <span class="n">raw</span><span class="o">=</span><span class="n">raw</span><span class="p">,</span>
            <span class="n">current_agent_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">handle_tool_call_results</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolCallResult</span><span class="p">],</span> <span class="n">memory</span><span class="p">:</span> <span class="n">BaseMemory</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle tool call results for code act agent.&quot;&quot;&quot;</span>
        <span class="n">scratchpad</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scratchpad_key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[]</span>
        <span class="p">)</span>

        <span class="c1"># handle code execution and handoff</span>
        <span class="k">for</span> <span class="n">tool_call_result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="c1"># Format the output as a tool response message</span>
            <span class="k">if</span> <span class="n">tool_call_result</span><span class="o">.</span><span class="n">tool_name</span> <span class="o">==</span> <span class="n">EXECUTE_TOOL_NAME</span><span class="p">:</span>
                <span class="n">code_result</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Result of executing the code given:</span><span class="se">\n\n</span><span class="si">{</span><span class="n">tool_call_result</span><span class="o">.</span><span class="n">tool_output</span><span class="o">.</span><span class="n">content</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">scratchpad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">ChatMessage</span><span class="p">(</span>
                        <span class="n">role</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span>
                        <span class="n">content</span><span class="o">=</span><span class="n">code_result</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">tool_call_result</span><span class="o">.</span><span class="n">tool_name</span> <span class="o">==</span> <span class="s2">&quot;handoff&quot;</span><span class="p">:</span>
                <span class="n">scratchpad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">ChatMessage</span><span class="p">(</span>
                        <span class="n">role</span><span class="o">=</span><span class="s2">&quot;tool&quot;</span><span class="p">,</span>
                        <span class="n">blocks</span><span class="o">=</span><span class="n">tool_call_result</span><span class="o">.</span><span class="n">tool_output</span><span class="o">.</span><span class="n">blocks</span><span class="p">,</span>
                        <span class="n">additional_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;tool_call_id&quot;</span><span class="p">:</span> <span class="n">tool_call_result</span><span class="o">.</span><span class="n">tool_id</span><span class="p">},</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown tool name: </span><span class="si">{</span><span class="n">tool_call_result</span><span class="o">.</span><span class="n">tool_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scratchpad_key</span><span class="p">,</span> <span class="n">scratchpad</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">finalize</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">AgentOutput</span><span class="p">,</span> <span class="n">memory</span><span class="p">:</span> <span class="n">BaseMemory</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentOutput</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finalize the code act agent.</span>

<span class="sd">        Adds all in-progress messages to memory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scratchpad</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scratchpad_key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[]</span>
        <span class="p">)</span>
        <span class="k">await</span> <span class="n">memory</span><span class="o">.</span><span class="n">aput_messages</span><span class="p">(</span><span class="n">scratchpad</span><span class="p">)</span>

        <span class="c1"># reset scratchpad</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scratchpad_key</span><span class="p">,</span> <span class="p">[])</span>

        <span class="k">return</span> <span class="n">output</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="llama_index.core.agent.workflow.CodeActAgent.take_step" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">take_step</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#llama_index.core.agent.workflow.CodeActAgent.take_step" class="headerlink" title="Permanent link">#</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">take_step</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.workflow.Context" href="../workflow/context/#workflows.context.Context">Context</a></span><span class="p">,</span> <span class="n">llm_input</span><span class="p">:</span> <span class="n"><span title="typing.List">List</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.llms.ChatMessage" href="../llms/#llama_index.core.base.llms.types.ChatMessage">ChatMessage</a></span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n"><span title="typing.Sequence">Sequence</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.tools.BaseTool" href="../tools/#llama_index.core.tools.types.BaseTool">BaseTool</a></span><span class="p">],</span> <span class="n">memory</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.memory.BaseMemory" href="../memory/#llama_index.core.memory.types.BaseMemory">BaseMemory</a></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.agent.workflow.workflow_events.AgentOutput" href="#llama_index.core.agent.workflow.AgentOutput">AgentOutput</a></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Take a single step with the code act agent.</p>

            <details class="quote">
              <summary>Source code in <code>llama_index\core\agent\workflow\codeact_agent.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">take_step</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span>
    <span class="n">llm_input</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span>
    <span class="n">tools</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">BaseTool</span><span class="p">],</span>
    <span class="n">memory</span><span class="p">:</span> <span class="n">BaseMemory</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentOutput</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Take a single step with the code act agent.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">code_execute_fn</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;code_execute_fn must be provided for CodeActAgent&quot;</span><span class="p">)</span>

    <span class="c1"># Get current scratchpad</span>
    <span class="n">scratchpad</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scratchpad_key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[]</span>
    <span class="p">)</span>
    <span class="n">current_llm_input</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">llm_input</span><span class="p">,</span> <span class="o">*</span><span class="n">scratchpad</span><span class="p">]</span>

    <span class="c1"># Create a system message with tool descriptions</span>
    <span class="n">tool_descriptions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_tool_descriptions</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
    <span class="n">system_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">code_act_system_prompt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">tool_descriptions</span><span class="o">=</span><span class="n">tool_descriptions</span>
    <span class="p">)</span>

    <span class="c1"># Add or overwrite system message</span>
    <span class="n">has_system</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">msg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">current_llm_input</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">role</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;system&quot;</span><span class="p">:</span>
            <span class="n">current_llm_input</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">system_prompt</span><span class="p">)</span>
            <span class="n">has_system</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">break</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">has_system</span><span class="p">:</span>
        <span class="n">current_llm_input</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span> <span class="n">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">system_prompt</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># Write the input to the event stream</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">write_event_to_stream</span><span class="p">(</span>
        <span class="n">AgentInput</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">current_llm_input</span><span class="p">,</span> <span class="n">current_agent_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># For now, only support the handoff tool</span>
    <span class="c1"># All other tools should be part of the code execution</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">tool</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;handoff&quot;</span> <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="p">,</span> <span class="n">FunctionCallingLLM</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;llm must be a function calling LLM to use handoff&quot;</span><span class="p">)</span>

        <span class="n">tools</span> <span class="o">=</span> <span class="p">[</span><span class="n">tool</span> <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">tools</span> <span class="k">if</span> <span class="n">tool</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;handoff&quot;</span><span class="p">]</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">astream_chat_with_tools</span><span class="p">(</span>
            <span class="n">tools</span><span class="p">,</span> <span class="n">chat_history</span><span class="o">=</span><span class="n">current_llm_input</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">astream_chat</span><span class="p">(</span><span class="n">current_llm_input</span><span class="p">)</span>

    <span class="c1"># Initialize for streaming</span>
    <span class="n">last_chat_response</span> <span class="o">=</span> <span class="n">ChatResponse</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">ChatMessage</span><span class="p">())</span>
    <span class="n">full_response_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="c1"># Process streaming response</span>
    <span class="k">async</span> <span class="k">for</span> <span class="n">last_chat_response</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">last_chat_response</span><span class="o">.</span><span class="n">delta</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="n">full_response_text</span> <span class="o">+=</span> <span class="n">delta</span>

        <span class="c1"># Create a raw object for the event stream</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">last_chat_response</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">last_chat_response</span><span class="o">.</span><span class="n">raw</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">)</span>
            <span class="k">else</span> <span class="n">last_chat_response</span><span class="o">.</span><span class="n">raw</span>
        <span class="p">)</span>

        <span class="c1"># Write delta to the event stream</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">write_event_to_stream</span><span class="p">(</span>
            <span class="n">AgentStream</span><span class="p">(</span>
                <span class="n">delta</span><span class="o">=</span><span class="n">delta</span><span class="p">,</span>
                <span class="n">response</span><span class="o">=</span><span class="n">full_response_text</span><span class="p">,</span>
                <span class="c1"># We&#39;ll add the tool call after processing the full response</span>
                <span class="n">tool_calls</span><span class="o">=</span><span class="p">[],</span>
                <span class="n">raw</span><span class="o">=</span><span class="n">raw</span><span class="p">,</span>
                <span class="n">current_agent_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># Extract code from the response</span>
    <span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_code_from_response</span><span class="p">(</span><span class="n">full_response_text</span><span class="p">)</span>

    <span class="c1"># Create a tool call for executing the code if code was found</span>
    <span class="n">tool_calls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">code</span><span class="p">:</span>
        <span class="n">tool_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>

        <span class="n">tool_calls</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">ToolSelection</span><span class="p">(</span>
                <span class="n">tool_id</span><span class="o">=</span><span class="n">tool_id</span><span class="p">,</span>
                <span class="n">tool_name</span><span class="o">=</span><span class="n">EXECUTE_TOOL_NAME</span><span class="p">,</span>
                <span class="n">tool_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="n">code</span><span class="p">},</span>
            <span class="p">)</span>
        <span class="p">]</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="p">,</span> <span class="n">FunctionCallingLLM</span><span class="p">):</span>
        <span class="n">extra_tool_calls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">get_tool_calls_from_response</span><span class="p">(</span>
            <span class="n">last_chat_response</span><span class="p">,</span> <span class="n">error_on_no_tool_call</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">tool_calls</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">extra_tool_calls</span><span class="p">)</span>

    <span class="c1"># Add the response to the scratchpad</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;assistant&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">full_response_text</span><span class="p">)</span>
    <span class="n">scratchpad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scratchpad_key</span><span class="p">,</span> <span class="n">scratchpad</span><span class="p">)</span>

    <span class="c1"># Create the raw object for the output</span>
    <span class="n">raw</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">last_chat_response</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">last_chat_response</span><span class="o">.</span><span class="n">raw</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">)</span>
        <span class="k">else</span> <span class="n">last_chat_response</span><span class="o">.</span><span class="n">raw</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">AgentOutput</span><span class="p">(</span>
        <span class="n">response</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
        <span class="n">tool_calls</span><span class="o">=</span><span class="n">tool_calls</span><span class="p">,</span>
        <span class="n">raw</span><span class="o">=</span><span class="n">raw</span><span class="p">,</span>
        <span class="n">current_agent_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="llama_index.core.agent.workflow.CodeActAgent.handle_tool_call_results" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">handle_tool_call_results</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#llama_index.core.agent.workflow.CodeActAgent.handle_tool_call_results" class="headerlink" title="Permanent link">#</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">handle_tool_call_results</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.workflow.Context" href="../workflow/context/#workflows.context.Context">Context</a></span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n"><span title="typing.List">List</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.agent.workflow.workflow_events.ToolCallResult" href="#llama_index.core.agent.workflow.ToolCallResult">ToolCallResult</a></span><span class="p">],</span> <span class="n">memory</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.memory.BaseMemory" href="../memory/#llama_index.core.memory.types.BaseMemory">BaseMemory</a></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Handle tool call results for code act agent.</p>

            <details class="quote">
              <summary>Source code in <code>llama_index\core\agent\workflow\codeact_agent.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">handle_tool_call_results</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolCallResult</span><span class="p">],</span> <span class="n">memory</span><span class="p">:</span> <span class="n">BaseMemory</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle tool call results for code act agent.&quot;&quot;&quot;</span>
    <span class="n">scratchpad</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scratchpad_key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[]</span>
    <span class="p">)</span>

    <span class="c1"># handle code execution and handoff</span>
    <span class="k">for</span> <span class="n">tool_call_result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="c1"># Format the output as a tool response message</span>
        <span class="k">if</span> <span class="n">tool_call_result</span><span class="o">.</span><span class="n">tool_name</span> <span class="o">==</span> <span class="n">EXECUTE_TOOL_NAME</span><span class="p">:</span>
            <span class="n">code_result</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Result of executing the code given:</span><span class="se">\n\n</span><span class="si">{</span><span class="n">tool_call_result</span><span class="o">.</span><span class="n">tool_output</span><span class="o">.</span><span class="n">content</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">scratchpad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">ChatMessage</span><span class="p">(</span>
                    <span class="n">role</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span>
                    <span class="n">content</span><span class="o">=</span><span class="n">code_result</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">tool_call_result</span><span class="o">.</span><span class="n">tool_name</span> <span class="o">==</span> <span class="s2">&quot;handoff&quot;</span><span class="p">:</span>
            <span class="n">scratchpad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">ChatMessage</span><span class="p">(</span>
                    <span class="n">role</span><span class="o">=</span><span class="s2">&quot;tool&quot;</span><span class="p">,</span>
                    <span class="n">blocks</span><span class="o">=</span><span class="n">tool_call_result</span><span class="o">.</span><span class="n">tool_output</span><span class="o">.</span><span class="n">blocks</span><span class="p">,</span>
                    <span class="n">additional_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;tool_call_id&quot;</span><span class="p">:</span> <span class="n">tool_call_result</span><span class="o">.</span><span class="n">tool_id</span><span class="p">},</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown tool name: </span><span class="si">{</span><span class="n">tool_call_result</span><span class="o">.</span><span class="n">tool_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scratchpad_key</span><span class="p">,</span> <span class="n">scratchpad</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="llama_index.core.agent.workflow.CodeActAgent.finalize" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">finalize</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#llama_index.core.agent.workflow.CodeActAgent.finalize" class="headerlink" title="Permanent link">#</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">finalize</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.workflow.Context" href="../workflow/context/#workflows.context.Context">Context</a></span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.agent.workflow.workflow_events.AgentOutput" href="#llama_index.core.agent.workflow.AgentOutput">AgentOutput</a></span><span class="p">,</span> <span class="n">memory</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.memory.BaseMemory" href="../memory/#llama_index.core.memory.types.BaseMemory">BaseMemory</a></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.agent.workflow.workflow_events.AgentOutput" href="#llama_index.core.agent.workflow.AgentOutput">AgentOutput</a></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Finalize the code act agent.</p>
<p>Adds all in-progress messages to memory.</p>

            <details class="quote">
              <summary>Source code in <code>llama_index\core\agent\workflow\codeact_agent.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">finalize</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">AgentOutput</span><span class="p">,</span> <span class="n">memory</span><span class="p">:</span> <span class="n">BaseMemory</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentOutput</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Finalize the code act agent.</span>

<span class="sd">    Adds all in-progress messages to memory.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">scratchpad</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scratchpad_key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[]</span>
    <span class="p">)</span>
    <span class="k">await</span> <span class="n">memory</span><span class="o">.</span><span class="n">aput_messages</span><span class="p">(</span><span class="n">scratchpad</span><span class="p">)</span>

    <span class="c1"># reset scratchpad</span>
    <span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scratchpad_key</span><span class="p">,</span> <span class="p">[])</span>

    <span class="k">return</span> <span class="n">output</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="llama_index.core.agent.workflow.AgentInput" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">AgentInput</span>


<a href="#llama_index.core.agent.workflow.AgentInput" class="headerlink" title="Permanent link">#</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="llama_index.core.workflow.Event" href="../workflow/events/#workflows.events.Event">Event</a></code></p>


        <p>LLM input.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>input</code>
            </td>
            <td>
                  <code>list[<a class="autorefs autorefs-internal" title="llama_index.core.llms.ChatMessage" href="../llms/#llama_index.core.base.llms.types.ChatMessage">ChatMessage</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>current_agent_name</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>






              <details class="quote">
                <summary>Source code in <code>llama_index\core\agent\workflow\workflow_events.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">AgentInput</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;LLM input.&quot;&quot;&quot;</span>

    <span class="nb">input</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]</span>
    <span class="n">current_agent_name</span><span class="p">:</span> <span class="nb">str</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="llama_index.core.agent.workflow.AgentStream" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">AgentStream</span>


<a href="#llama_index.core.agent.workflow.AgentStream" class="headerlink" title="Permanent link">#</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="llama_index.core.workflow.Event" href="../workflow/events/#workflows.events.Event">Event</a></code></p>


        <p>Agent stream.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>delta</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>response</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>current_agent_name</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tool_calls</code>
            </td>
            <td>
                  <code>list[<span title="llama_index.core.tools.ToolSelection">ToolSelection</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>raw</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>






              <details class="quote">
                <summary>Source code in <code>llama_index\core\agent\workflow\workflow_events.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">AgentStream</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Agent stream.&quot;&quot;&quot;</span>

    <span class="n">delta</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">response</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">current_agent_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">tool_calls</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ToolSelection</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">raw</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="llama_index.core.agent.workflow.AgentOutput" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">AgentOutput</span>


<a href="#llama_index.core.agent.workflow.AgentOutput" class="headerlink" title="Permanent link">#</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="llama_index.core.workflow.Event" href="../workflow/events/#workflows.events.Event">Event</a></code></p>


        <p>LLM output.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>response</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="llama_index.core.llms.ChatMessage" href="../llms/#llama_index.core.base.llms.types.ChatMessage">ChatMessage</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tool_calls</code>
            </td>
            <td>
                  <code>list[<span title="llama_index.core.tools.ToolSelection">ToolSelection</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>raw</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>current_agent_name</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>






              <details class="quote">
                <summary>Source code in <code>llama_index\core\agent\workflow\workflow_events.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">AgentOutput</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;LLM output.&quot;&quot;&quot;</span>

    <span class="n">response</span><span class="p">:</span> <span class="n">ChatMessage</span>
    <span class="n">structured_response</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">current_agent_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">raw</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">tool_calls</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ToolSelection</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">retry_messages</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_pydantic_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">structured_response</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">structured_response</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">model_validate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structured_response</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Conversion of structured response to Pydantic model failed because:</span><span class="se">\n\n</span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">Please check the model you provided.&quot;</span><span class="p">,</span>
                <span class="n">PydanticConversionWarning</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">content</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="llama_index.core.agent.workflow.ToolCall" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">ToolCall</span>


<a href="#llama_index.core.agent.workflow.ToolCall" class="headerlink" title="Permanent link">#</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="llama_index.core.workflow.Event" href="../workflow/events/#workflows.events.Event">Event</a></code></p>


        <p>All tool calls are surfaced.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>tool_name</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tool_kwargs</code>
            </td>
            <td>
                  <code>dict</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tool_id</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>






              <details class="quote">
                <summary>Source code in <code>llama_index\core\agent\workflow\workflow_events.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">ToolCall</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;All tool calls are surfaced.&quot;&quot;&quot;</span>

    <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">tool_kwargs</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="n">tool_id</span><span class="p">:</span> <span class="nb">str</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="llama_index.core.agent.workflow.ToolCallResult" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">ToolCallResult</span>


<a href="#llama_index.core.agent.workflow.ToolCallResult" class="headerlink" title="Permanent link">#</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="llama_index.core.workflow.Event" href="../workflow/events/#workflows.events.Event">Event</a></code></p>


        <p>Tool call result.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>tool_output</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="llama_index.core.tools.ToolOutput" href="../tools/#llama_index.core.tools.types.ToolOutput">ToolOutput</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>return_direct</code>
            </td>
            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>






              <details class="quote">
                <summary>Source code in <code>llama_index\core\agent\workflow\workflow_events.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">ToolCallResult</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tool call result.&quot;&quot;&quot;</span>

    <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">tool_kwargs</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="n">tool_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">tool_output</span><span class="p">:</span> <span class="n">ToolOutput</span>
    <span class="n">return_direct</span><span class="p">:</span> <span class="nb">bool</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>




  </div>

    </div>

</div>









  




                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
       
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../" class="md-footer__link md-footer__link--prev" aria-label="Previous: API Reference">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                API Reference
              </div>
            </div>
          </a>
        
        
          
          <a href="azure_foundry_agent/" class="md-footer__link md-footer__link--next" aria-label="Next: Azure foundry agent">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Azure foundry agent
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <readthedocs-flyout position="bottom-left"></readthedocs-flyout>
      
    </div>
  </div>
</footer>
      
<!-- Google Tag Manager -->
<script>
  (function (w, d, s, l, i) {
    w[l] = w[l] || [];
    w[l].push({ "gtm.start": new Date().getTime(), event: "gtm.js" });
    var f = d.getElementsByTagName(s)[0],
      j = d.createElement(s),
      dl = l != "dataLayer" ? "&l=" + l : "";
    j.async = true;
    j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
    f.parentNode.insertBefore(j, f);
  })(window, document, "script", "dataLayer", "GTM-WWRFB36R");
</script>
<!-- End Google Tag Manager -->

    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.prune", "navigation.tabs", "navigation.indexes", "navigation.top", "navigation.footer", "toc.follow", "content.code.copy", "search.suggest", "search.highlight"], "search": "../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.88dd0f4e.min.js"></script>
      
        <script src="../../javascript/runllm.js"></script>
      
        <script src="../../javascript/algolia.js"></script>
      
    
  </body>
</html>