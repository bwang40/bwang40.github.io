
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://docs.llamaindex.ai/en/stable/api_reference/memory/memory/">
      
      
        <link rel="prev" href="../mem0/">
      
      
        <link rel="next" href="../simple_composable_memory/">
      
      
      <link rel="icon" href="../../../_static/assets/LlamaLogoBrowserTab.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.49">
    
    
      
        <title>Memory - LlamaIndex</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.6f8fc17f.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../../css/style.css">
    
      <link rel="stylesheet" href="../../../css/algolia.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-BYVB1ZVE6J"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-BYVB1ZVE6J",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-BYVB1ZVE6J",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#llama_index.core.memory.Memory" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="LlamaIndex" class="md-header__button md-logo" aria-label="LlamaIndex" data-md-component="logo">
      
  <img src="../../../_static/assets/LlamaSquareBlack.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            LlamaIndex
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Memory
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="purple"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="purple"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      

<!-- Search interface -->
<div id="docsearch"></div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../.." class="md-tabs__link">
          
  
    
  
  Home

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../understanding/" class="md-tabs__link">
          
  
    
  
  Learn

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../use_cases/" class="md-tabs__link">
          
  
    
  
  Use Cases

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../examples/" class="md-tabs__link">
          
  
    
  
  Examples

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../module_guides/" class="md-tabs__link">
          
  
    
  
  Component Guides

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../optimizing/production_rag/" class="md-tabs__link">
          
  
    
  
  Advanced Topics

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../" class="md-tabs__link">
          
  
    
  
  API Reference

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../community/integrations/" class="md-tabs__link">
          
  
    
  
  Open-Source Community

        </a>
      </li>
    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="https://docs.cloud.llamaindex.ai/" class="md-tabs__link">
        
  
    
  
  LlamaCloud

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="LlamaIndex" class="md-nav__button md-logo" aria-label="LlamaIndex" data-md-component="logo">
      
  <img src="../../../_static/assets/LlamaSquareBlack.svg" alt="logo">

    </a>
    LlamaIndex
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../.." class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Home
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../understanding/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Learn
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../use_cases/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Use Cases
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../examples/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Examples
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../module_guides/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Component Guides
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../optimizing/production_rag/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Advanced Topics
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
        
        
      
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    API Reference
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7" id="__nav_7_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../agent/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Agents
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../callbacks/agentops/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Callbacks
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
          
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../chat_engines/condense_plus_context/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Chat Engines
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../embeddings/adapter/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Embeddings
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../evaluation/answer_relevancy/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Evaluation
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../graph_rag/cognee/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Graph RAG
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../indices/bge_m3/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Indexes
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../ingestion/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Ingestion
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
          
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../instrumentation/event_handlers/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Instrumentation
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../llms/ai21/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    LLMs
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../llama_dataset/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Llama Datasets
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../llama_deploy" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Llama Deploy
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../packs/agent_search_retriever/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Llama Packs
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../llama_deploy/apiserver.md" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    LlamaDeploy
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_16" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Memory
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7_16" id="__nav_7_16_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_16_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7_16">
            <span class="md-nav__icon md-icon"></span>
            Memory
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chat_memory_buffer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Chat memory buffer
  </span>
  

      </a>
    </li>
  

              
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../mem0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Mem0
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Memory
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Memory
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#llama_index.core.memory.Memory" class="md-nav__link">
    <span class="md-ellipsis">
      Memory
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Memory">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#llama_index.core.memory.Memory.from_defaults" class="md-nav__link">
    <span class="md-ellipsis">
      from_defaults
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llama_index.core.memory.Memory.aget" class="md-nav__link">
    <span class="md-ellipsis">
      aget
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llama_index.core.memory.Memory.aput" class="md-nav__link">
    <span class="md-ellipsis">
      aput
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llama_index.core.memory.Memory.aput_messages" class="md-nav__link">
    <span class="md-ellipsis">
      aput_messages
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llama_index.core.memory.Memory.aset" class="md-nav__link">
    <span class="md-ellipsis">
      aset
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llama_index.core.memory.Memory.aget_all" class="md-nav__link">
    <span class="md-ellipsis">
      aget_all
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llama_index.core.memory.Memory.areset" class="md-nav__link">
    <span class="md-ellipsis">
      areset
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llama_index.core.memory.Memory.get" class="md-nav__link">
    <span class="md-ellipsis">
      get
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llama_index.core.memory.Memory.get_all" class="md-nav__link">
    <span class="md-ellipsis">
      get_all
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llama_index.core.memory.Memory.put" class="md-nav__link">
    <span class="md-ellipsis">
      put
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llama_index.core.memory.Memory.set" class="md-nav__link">
    <span class="md-ellipsis">
      set
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llama_index.core.memory.Memory.reset" class="md-nav__link">
    <span class="md-ellipsis">
      reset
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llama_index.core.memory.BaseMemoryBlock" class="md-nav__link">
    <span class="md-ellipsis">
      BaseMemoryBlock
    </span>
  </a>
  
    <nav class="md-nav" aria-label="BaseMemoryBlock">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#llama_index.core.memory.BaseMemoryBlock.aget" class="md-nav__link">
    <span class="md-ellipsis">
      aget
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llama_index.core.memory.BaseMemoryBlock.aput" class="md-nav__link">
    <span class="md-ellipsis">
      aput
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llama_index.core.memory.BaseMemoryBlock.atruncate" class="md-nav__link">
    <span class="md-ellipsis">
      atruncate
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llama_index.core.memory.InsertMethod" class="md-nav__link">
    <span class="md-ellipsis">
      InsertMethod
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llama_index.core.memory.StaticMemoryBlock" class="md-nav__link">
    <span class="md-ellipsis">
      StaticMemoryBlock
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llama_index.core.memory.VectorMemoryBlock" class="md-nav__link">
    <span class="md-ellipsis">
      VectorMemoryBlock
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llama_index.core.memory.FactExtractionMemoryBlock" class="md-nav__link">
    <span class="md-ellipsis">
      FactExtractionMemoryBlock
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../simple_composable_memory/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Simple composable memory
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../vector_memory/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Vector memory
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../mem0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Mem0
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../llama_deploy/message_queues/index.md" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Message Queues
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../extractors/documentcontext/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Metadata Extractors
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../multi_modal_llms/anthropic/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Multi-Modal LLMs
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../node_parser/alibabacloud_aisearch/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Node Parsers & Text Splitters
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../postprocessor/NER_PII/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Node Postprocessors
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../objects/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Object Stores
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../observability/otel/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Observability
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../output_parsers/guardrails/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Output Parsers
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../program/evaporate/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Programs
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../prompts/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Prompts
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../protocols/ag_ui/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Protocols
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../query_engine/FLARE/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Query Engines
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../query_pipeline/agent/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Query Pipeline
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../question_gen/guidance/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Question Generators
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../readers/agent_search/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Readers
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../response_synthesizers/accumulate/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Response Synthesizers
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../retrievers/auto_merging/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Retrievers
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../schema/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Schema
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../selectors/notdiamond/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Selectors
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../sparse_embeddings/fastembed/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Sparse Embeddings
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    
  
  
    <a href="../../storage/chat_store/async_sql/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Storage
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../tools/agentql/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Tools
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../voice_agents/elevenlabs/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Voice Agents
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../workflow/decorators/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Workflow
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../community/integrations/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Open-Source Community
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="https://docs.cloud.llamaindex.ai/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    LlamaCloud
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#llama_index.core.memory.Memory" class="md-nav__link">
    <span class="md-ellipsis">
      Memory
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Memory">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#llama_index.core.memory.Memory.from_defaults" class="md-nav__link">
    <span class="md-ellipsis">
      from_defaults
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llama_index.core.memory.Memory.aget" class="md-nav__link">
    <span class="md-ellipsis">
      aget
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llama_index.core.memory.Memory.aput" class="md-nav__link">
    <span class="md-ellipsis">
      aput
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llama_index.core.memory.Memory.aput_messages" class="md-nav__link">
    <span class="md-ellipsis">
      aput_messages
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llama_index.core.memory.Memory.aset" class="md-nav__link">
    <span class="md-ellipsis">
      aset
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llama_index.core.memory.Memory.aget_all" class="md-nav__link">
    <span class="md-ellipsis">
      aget_all
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llama_index.core.memory.Memory.areset" class="md-nav__link">
    <span class="md-ellipsis">
      areset
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llama_index.core.memory.Memory.get" class="md-nav__link">
    <span class="md-ellipsis">
      get
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llama_index.core.memory.Memory.get_all" class="md-nav__link">
    <span class="md-ellipsis">
      get_all
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llama_index.core.memory.Memory.put" class="md-nav__link">
    <span class="md-ellipsis">
      put
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llama_index.core.memory.Memory.set" class="md-nav__link">
    <span class="md-ellipsis">
      set
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llama_index.core.memory.Memory.reset" class="md-nav__link">
    <span class="md-ellipsis">
      reset
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llama_index.core.memory.BaseMemoryBlock" class="md-nav__link">
    <span class="md-ellipsis">
      BaseMemoryBlock
    </span>
  </a>
  
    <nav class="md-nav" aria-label="BaseMemoryBlock">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#llama_index.core.memory.BaseMemoryBlock.aget" class="md-nav__link">
    <span class="md-ellipsis">
      aget
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llama_index.core.memory.BaseMemoryBlock.aput" class="md-nav__link">
    <span class="md-ellipsis">
      aput
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llama_index.core.memory.BaseMemoryBlock.atruncate" class="md-nav__link">
    <span class="md-ellipsis">
      atruncate
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llama_index.core.memory.InsertMethod" class="md-nav__link">
    <span class="md-ellipsis">
      InsertMethod
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llama_index.core.memory.StaticMemoryBlock" class="md-nav__link">
    <span class="md-ellipsis">
      StaticMemoryBlock
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llama_index.core.memory.VectorMemoryBlock" class="md-nav__link">
    <span class="md-ellipsis">
      VectorMemoryBlock
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llama_index.core.memory.FactExtractionMemoryBlock" class="md-nav__link">
    <span class="md-ellipsis">
      FactExtractionMemoryBlock
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>Memory</h1>

<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">








  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="llama_index.core.memory.Memory" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">Memory</span>


<a href="#llama_index.core.memory.Memory" class="headerlink" title="Permanent link">#</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="llama_index.core.memory.types.BaseMemory" href="../#llama_index.core.memory.types.BaseMemory">BaseMemory</a></code></p>


        <p>A memory module that waterfalls into memory blocks.</p>
<p>Works by orchestrating around
- a FIFO queue of messages
- a list of memory blocks
- various parameters (pressure size, token limit, etc.)</p>
<p>When the FIFO queue reaches the token limit, the oldest messages within the pressure size are ejected from the FIFO queue.
The messages are then processed by each memory block.</p>
<p>When pulling messages from this memory, the memory blocks are processed in order, and the messages are injected into the system message or the latest user message.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>token_limit</code>
            </td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The overall token limit of the memory.</p>
              </div>
            </td>
            <td>
                  <code>30000</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>token_flush_size</code>
            </td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The token size to use for flushing the FIFO queue.</p>
              </div>
            </td>
            <td>
                  <code>3000</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>chat_history_token_ratio</code>
            </td>
            <td>
                  <code>float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum percentage ratio of total token limit reserved for chat history.</p>
              </div>
            </td>
            <td>
                  <code>0.7</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>memory_blocks</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<a class="autorefs autorefs-internal" title="llama_index.core.memory.memory.BaseMemoryBlock" href="#llama_index.core.memory.BaseMemoryBlock">BaseMemoryBlock</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The list of memory blocks to use.</p>
              </div>
            </td>
            <td>
                  <code>[]</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>memory_blocks_template</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="llama_index.core.prompts.RichPromptTemplate" href="../../prompts/#llama_index.core.prompts.RichPromptTemplate">RichPromptTemplate</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The template to use for formatting the memory blocks.</p>
              </div>
            </td>
            <td>
                  <code>RichPromptTemplate(metadata={}, template_vars=[&#39;memory_blocks&#39;], kwargs={}, output_parser=None, template_var_mappings=None, function_mappings=None, template_str=&#39;\n&lt;memory&gt;\n{% for (block_name, block_content) in memory_blocks %}\n&lt;{{ block_name }}&gt;\n  {% for block in block_content %}\n    {% if block.block_type == &#34;text&#34; %}\n{{ block.text }}\n    {% elif block.block_type == &#34;image&#34; %}\n      {% if block.url %}\n        {{ (block.url | string) | image }}\n      {% elif block.path %}\n        {{ (block.path | string) | image }}\n      {% endif %}\n    {% elif block.block_type == &#34;audio&#34; %}\n      {% if block.url %}\n        {{ (block.url | string) | audio }}\n      {% elif block.path %}\n        {{ (block.path | string) | audio }}\n      {% endif %}\n    {% endif %}\n  {% endfor %}\n&lt;/{{ block_name }}&gt;\n{% endfor %}\n&lt;/memory&gt;\n&#39;)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>insert_method</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="llama_index.core.memory.memory.InsertMethod" href="#llama_index.core.memory.InsertMethod">InsertMethod</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to inject memory blocks into a system message or into the latest user message.</p>
              </div>
            </td>
            <td>
                  <code>&lt;InsertMethod.SYSTEM: &#39;system&#39;&gt;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>image_token_size_estimate</code>
            </td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The token size estimate for images.</p>
              </div>
            </td>
            <td>
                  <code>256</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>audio_token_size_estimate</code>
            </td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The token size estimate for audio.</p>
              </div>
            </td>
            <td>
                  <code>256</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tokenizer_fn</code>
            </td>
            <td>
                  <code><span title="typing.Callable">Callable</span>[list, <span title="typing.List">List</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The tokenizer function to use for token counting.</p>
              </div>
            </td>
            <td>
                  <code>functools.partial(&lt;bound method Encoding.encode of &lt;Encoding &#39;cl100k_base&#39;&gt;&gt;, allowed_special=&#39;all&#39;)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>sql_store</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="llama_index.core.storage.chat_store.sql.SQLAlchemyChatStore" href="../../storage/chat_store/async_sql/#llama_index.core.storage.chat_store.sql.SQLAlchemyChatStore">SQLAlchemyChatStore</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The chat store to use for storing messages.</p>
              </div>
            </td>
            <td>
                  <code>SQLAlchemyChatStore(table_name=&#39;llama_index_memory&#39;, async_database_uri=&#39;sqlite+aiosqlite:///:memory:&#39;)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>session_id</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The key to use for storing messages in the chat store.</p>
              </div>
            </td>
            <td>
                  <code>&#39;c1ccd46d-8e77-4858-8660-09a82719a000&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>






              <details class="quote">
                <summary>Source code in <code>llama_index\core\memory\memory.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Memory</span><span class="p">(</span><span class="n">BaseMemory</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A memory module that waterfalls into memory blocks.</span>

<span class="sd">    Works by orchestrating around</span>
<span class="sd">    - a FIFO queue of messages</span>
<span class="sd">    - a list of memory blocks</span>
<span class="sd">    - various parameters (pressure size, token limit, etc.)</span>

<span class="sd">    When the FIFO queue reaches the token limit, the oldest messages within the pressure size are ejected from the FIFO queue.</span>
<span class="sd">    The messages are then processed by each memory block.</span>

<span class="sd">    When pulling messages from this memory, the memory blocks are processed in order, and the messages are injected into the system message or the latest user message.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">model_config</span> <span class="o">=</span> <span class="n">ConfigDict</span><span class="p">(</span><span class="n">arbitrary_types_allowed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">token_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_TOKEN_LIMIT</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The overall token limit of the memory.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">token_flush_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_FLUSH_SIZE</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The token size to use for flushing the FIFO queue.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">chat_history_token_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Minimum percentage ratio of total token limit reserved for chat history.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">memory_blocks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">BaseMemoryBlock</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The list of memory blocks to use.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">memory_blocks_template</span><span class="p">:</span> <span class="n">RichPromptTemplate</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_MEMORY_BLOCKS_TEMPLATE</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The template to use for formatting the memory blocks.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">insert_method</span><span class="p">:</span> <span class="n">InsertMethod</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="n">InsertMethod</span><span class="o">.</span><span class="n">SYSTEM</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Whether to inject memory blocks into a system message or into the latest user message.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">image_token_size_estimate</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The token size estimate for images.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">audio_token_size_estimate</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The token size estimate for audio.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">tokenizer_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="n">get_tokenizer</span><span class="p">,</span>
        <span class="n">exclude</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The tokenizer function to use for token counting.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">sql_store</span><span class="p">:</span> <span class="n">SQLAlchemyChatStore</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="n">get_default_chat_store</span><span class="p">,</span>
        <span class="n">exclude</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The chat store to use for storing messages.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="n">generate_chat_store_key</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The key to use for storing messages in the chat store.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">class_name</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Memory&quot;</span>

    <span class="nd">@model_validator</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;before&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">validate_memory</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="c1"># Validate token limit</span>
        <span class="n">token_limit</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;token_limit&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">token_limit</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Token limit must be set and greater than 0.&quot;</span><span class="p">)</span>

        <span class="n">tokenizer_fn</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tokenizer_fn&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tokenizer_fn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">values</span><span class="p">[</span><span class="s2">&quot;tokenizer_fn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_tokenizer</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;token_flush_size&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">values</span><span class="p">[</span><span class="s2">&quot;token_flush_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">token_limit</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;token_flush_size&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">token_limit</span><span class="p">:</span>
            <span class="n">values</span><span class="p">[</span><span class="s2">&quot;token_flush_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">token_limit</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>

        <span class="c1"># validate all blocks have unique names</span>
        <span class="n">block_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">block</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;memory_blocks&quot;</span><span class="p">,</span> <span class="p">[])]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">block_names</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">block_names</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All memory blocks must have unique names.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">values</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_defaults</span><span class="p">(</span>  <span class="c1"># type: ignore[override]</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">session_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">chat_history</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">token_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_TOKEN_LIMIT</span><span class="p">,</span>
        <span class="n">memory_blocks</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">BaseMemoryBlock</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tokenizer_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">chat_history_token_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">,</span>
        <span class="n">token_flush_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_FLUSH_SIZE</span><span class="p">,</span>
        <span class="n">memory_blocks_template</span><span class="p">:</span> <span class="n">RichPromptTemplate</span> <span class="o">=</span> <span class="n">DEFAULT_MEMORY_BLOCKS_TEMPLATE</span><span class="p">,</span>
        <span class="n">insert_method</span><span class="p">:</span> <span class="n">InsertMethod</span> <span class="o">=</span> <span class="n">InsertMethod</span><span class="o">.</span><span class="n">SYSTEM</span><span class="p">,</span>
        <span class="n">image_token_size_estimate</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
        <span class="n">audio_token_size_estimate</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
        <span class="c1"># SQLAlchemyChatStore parameters</span>
        <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;llama_index_memory&quot;</span><span class="p">,</span>
        <span class="n">async_database_uri</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">async_engine</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AsyncEngine</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Memory&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize Memory.&quot;&quot;&quot;</span>
        <span class="n">session_id</span> <span class="o">=</span> <span class="n">session_id</span> <span class="ow">or</span> <span class="n">generate_chat_store_key</span><span class="p">()</span>

        <span class="c1"># If not using the SQLAlchemyChatStore, provide an error</span>
        <span class="n">sql_store</span> <span class="o">=</span> <span class="n">SQLAlchemyChatStore</span><span class="p">(</span>
            <span class="n">table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span>
            <span class="n">async_database_uri</span><span class="o">=</span><span class="n">async_database_uri</span><span class="p">,</span>
            <span class="n">async_engine</span><span class="o">=</span><span class="n">async_engine</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">chat_history</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">asyncio_run</span><span class="p">(</span><span class="n">sql_store</span><span class="o">.</span><span class="n">set_messages</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="n">chat_history</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">token_flush_size</span> <span class="o">&gt;</span> <span class="n">token_limit</span><span class="p">:</span>
            <span class="n">token_flush_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">token_limit</span> <span class="o">*</span> <span class="mf">0.7</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">token_limit</span><span class="o">=</span><span class="n">token_limit</span><span class="p">,</span>
            <span class="n">tokenizer_fn</span><span class="o">=</span><span class="n">tokenizer_fn</span> <span class="ow">or</span> <span class="n">get_tokenizer</span><span class="p">(),</span>
            <span class="n">sql_store</span><span class="o">=</span><span class="n">sql_store</span><span class="p">,</span>
            <span class="n">session_id</span><span class="o">=</span><span class="n">session_id</span><span class="p">,</span>
            <span class="n">memory_blocks</span><span class="o">=</span><span class="n">memory_blocks</span> <span class="ow">or</span> <span class="p">[],</span>
            <span class="n">chat_history_token_ratio</span><span class="o">=</span><span class="n">chat_history_token_ratio</span><span class="p">,</span>
            <span class="n">token_flush_size</span><span class="o">=</span><span class="n">token_flush_size</span><span class="p">,</span>
            <span class="n">memory_blocks_template</span><span class="o">=</span><span class="n">memory_blocks_template</span><span class="p">,</span>
            <span class="n">insert_method</span><span class="o">=</span><span class="n">insert_method</span><span class="p">,</span>
            <span class="n">image_token_size_estimate</span><span class="o">=</span><span class="n">image_token_size_estimate</span><span class="p">,</span>
            <span class="n">audio_token_size_estimate</span><span class="o">=</span><span class="n">audio_token_size_estimate</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_estimate_token_count</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">message_or_blocks</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
            <span class="nb">str</span><span class="p">,</span> <span class="n">ChatMessage</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">ContentBlock</span><span class="p">]</span>
        <span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Estimate token count for a message.&quot;&quot;&quot;</span>
        <span class="n">token_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Normalize the input to a list of ContentBlocks</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message_or_blocks</span><span class="p">,</span> <span class="n">ChatMessage</span><span class="p">):</span>
            <span class="n">blocks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span>
                <span class="n">Union</span><span class="p">[</span>
                    <span class="n">TextBlock</span><span class="p">,</span>
                    <span class="n">ImageBlock</span><span class="p">,</span>
                    <span class="n">AudioBlock</span><span class="p">,</span>
                    <span class="n">DocumentBlock</span><span class="p">,</span>
                    <span class="n">CitableBlock</span><span class="p">,</span>
                    <span class="n">CitationBlock</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">message_or_blocks</span><span class="o">.</span><span class="n">blocks</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">CachePoint</span><span class="p">):</span>
                    <span class="n">blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>

            <span class="c1"># Estimate the token count for the additional kwargs</span>
            <span class="k">if</span> <span class="n">message_or_blocks</span><span class="o">.</span><span class="n">additional_kwargs</span><span class="p">:</span>
                <span class="n">token_count</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_fn</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">message_or_blocks</span><span class="o">.</span><span class="n">additional_kwargs</span><span class="p">))</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message_or_blocks</span><span class="p">,</span> <span class="n">List</span><span class="p">):</span>
            <span class="c1"># Type narrow the list</span>
            <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">ChatMessage</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">message_or_blocks</span><span class="p">):</span>
                <span class="n">messages</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">message_or_blocks</span><span class="p">)</span>

                <span class="n">blocks</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">blocks</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">CachePoint</span><span class="p">):</span>
                            <span class="n">blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>

                <span class="c1"># Estimate the token count for the additional kwargs</span>
                <span class="n">token_count</span> <span class="o">+=</span> <span class="nb">sum</span><span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_fn</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">additional_kwargs</span><span class="p">)))</span>
                    <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">messages</span>
                    <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">additional_kwargs</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span>
                    <span class="n">item</span><span class="p">,</span> <span class="p">(</span><span class="n">TextBlock</span><span class="p">,</span> <span class="n">ImageBlock</span><span class="p">,</span> <span class="n">AudioBlock</span><span class="p">,</span> <span class="n">DocumentBlock</span><span class="p">,</span> <span class="n">CachePoint</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">message_or_blocks</span>
            <span class="p">):</span>
                <span class="n">blocks</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">message_or_blocks</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">CachePoint</span><span class="p">):</span>
                        <span class="n">blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">cast</span><span class="p">(</span>
                                <span class="n">Union</span><span class="p">[</span><span class="n">TextBlock</span><span class="p">,</span> <span class="n">ImageBlock</span><span class="p">,</span> <span class="n">AudioBlock</span><span class="p">,</span> <span class="n">DocumentBlock</span><span class="p">],</span>
                                <span class="n">item</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid message type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">message_or_blocks</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message_or_blocks</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">blocks</span> <span class="o">=</span> <span class="p">[</span><span class="n">TextBlock</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">message_or_blocks</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid message type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">message_or_blocks</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Estimate the token count for each block</span>
        <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">TextBlock</span><span class="p">):</span>
                <span class="n">token_count</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_fn</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">text</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">ImageBlock</span><span class="p">):</span>
                <span class="n">token_count</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_token_size_estimate</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">AudioBlock</span><span class="p">):</span>
                <span class="n">token_count</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">audio_token_size_estimate</span>

        <span class="k">return</span> <span class="n">token_count</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_get_memory_blocks_content</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">chat_history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span>
        <span class="nb">input</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ChatMessage</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">block_kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get content from memory blocks in priority order.&quot;&quot;&quot;</span>
        <span class="n">content_per_memory_block</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">block_input</span> <span class="o">=</span> <span class="n">chat_history</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">block_input</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">chat_history</span><span class="p">,</span> <span class="n">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="nb">input</span><span class="p">)]</span>

        <span class="c1"># Process memory blocks in priority order</span>
        <span class="k">for</span> <span class="n">memory_block</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">memory_blocks</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">x</span><span class="o">.</span><span class="n">priority</span><span class="p">):</span>
            <span class="n">content</span> <span class="o">=</span> <span class="k">await</span> <span class="n">memory_block</span><span class="o">.</span><span class="n">aget</span><span class="p">(</span>
                <span class="n">block_input</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="o">**</span><span class="n">block_kwargs</span>
            <span class="p">)</span>

            <span class="c1"># Handle different return types from memory blocks</span>
            <span class="k">if</span> <span class="n">content</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="c1"># Memory block returned content blocks</span>
                <span class="n">content_per_memory_block</span><span class="p">[</span><span class="n">memory_block</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">content</span>
            <span class="k">elif</span> <span class="n">content</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="c1"># Memory block returned a string</span>
                <span class="n">content_per_memory_block</span><span class="p">[</span><span class="n">memory_block</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">content</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">content</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Invalid content type received from memory block </span><span class="si">{</span><span class="n">memory_block</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">content_per_memory_block</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_truncate_memory_blocks</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">content_per_memory_block</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">memory_blocks_tokens</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">chat_history_tokens</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Truncate memory blocks if total token count exceeds limit.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">memory_blocks_tokens</span> <span class="o">+</span> <span class="n">chat_history_tokens</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">token_limit</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">content_per_memory_block</span>

        <span class="n">tokens_to_truncate</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">memory_blocks_tokens</span> <span class="o">+</span> <span class="n">chat_history_tokens</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">token_limit</span>
        <span class="p">)</span>
        <span class="n">truncated_content</span> <span class="o">=</span> <span class="n">content_per_memory_block</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Truncate memory blocks based on priority</span>
        <span class="k">for</span> <span class="n">memory_block</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">memory_blocks</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">priority</span>
        <span class="p">):</span>  <span class="c1"># Lower priority first</span>
            <span class="c1"># Skip memory blocks with priority 0, they should never be truncated</span>
            <span class="k">if</span> <span class="n">memory_block</span><span class="o">.</span><span class="n">priority</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">tokens_to_truncate</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="c1"># Truncate content and measure tokens saved</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">truncated_content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">memory_block</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="p">[])</span>

            <span class="n">truncated_block_content</span> <span class="o">=</span> <span class="k">await</span> <span class="n">memory_block</span><span class="o">.</span><span class="n">atruncate</span><span class="p">(</span>
                <span class="n">content</span><span class="p">,</span> <span class="n">tokens_to_truncate</span>
            <span class="p">)</span>

            <span class="c1"># Calculate tokens saved</span>
            <span class="n">original_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_estimate_token_count</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">truncated_block_content</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">new_tokens</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_estimate_token_count</span><span class="p">(</span><span class="n">truncated_block_content</span><span class="p">)</span>

            <span class="n">tokens_saved</span> <span class="o">=</span> <span class="n">original_tokens</span> <span class="o">-</span> <span class="n">new_tokens</span>
            <span class="n">tokens_to_truncate</span> <span class="o">-=</span> <span class="n">tokens_saved</span>

            <span class="c1"># Update the content blocks</span>
            <span class="k">if</span> <span class="n">truncated_block_content</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">truncated_content</span><span class="p">[</span><span class="n">memory_block</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">truncated_content</span><span class="p">[</span><span class="n">memory_block</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">truncated_block_content</span>

        <span class="c1"># handle case where we still have tokens to truncate</span>
        <span class="c1"># just remove the blocks starting from the least priority</span>
        <span class="k">for</span> <span class="n">memory_block</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">memory_blocks</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">priority</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">memory_block</span><span class="o">.</span><span class="n">priority</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">tokens_to_truncate</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="c1"># Truncate content and measure tokens saved</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">truncated_content</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">memory_block</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">tokens_to_truncate</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_estimate_token_count</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">truncated_content</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_format_memory_blocks</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">content_per_memory_block</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">ContentBlock</span><span class="p">]]],</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Format memory blocks content into template data and chat messages.&quot;&quot;&quot;</span>
        <span class="n">memory_blocks_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">ContentBlock</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">chat_message_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_blocks</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">block</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">content_per_memory_block</span><span class="p">:</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">content_per_memory_block</span><span class="p">[</span><span class="n">block</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

                <span class="c1"># Skip empty memory blocks</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">content</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="p">(</span>
                    <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="n">content</span>
                    <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ChatMessage</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="n">chat_message_data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">memory_blocks_data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">block</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="p">[</span><span class="n">TextBlock</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">content</span><span class="p">)]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">memory_blocks_data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">block</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">content</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">memory_blocks_data</span><span class="p">,</span> <span class="n">chat_message_data</span>

    <span class="k">def</span> <span class="nf">_insert_memory_content</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">chat_history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span>
        <span class="n">memory_content</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ContentBlock</span><span class="p">],</span>
        <span class="n">chat_message_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Insert memory content into chat history based on insert method.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">chat_history</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Process chat messages</span>
        <span class="k">if</span> <span class="n">chat_message_data</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">chat_message_data</span><span class="p">,</span> <span class="o">*</span><span class="n">result</span><span class="p">]</span>

        <span class="c1"># Process template-based memory blocks</span>
        <span class="k">if</span> <span class="n">memory_content</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">insert_method</span> <span class="o">==</span> <span class="n">InsertMethod</span><span class="o">.</span><span class="n">SYSTEM</span><span class="p">:</span>
                <span class="c1"># Find system message or create a new one</span>
                <span class="n">system_idx</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">msg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;system&quot;</span><span class="p">),</span> <span class="kc">None</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">system_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Update existing system message</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">system_idx</span><span class="p">]</span><span class="o">.</span><span class="n">blocks</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="o">*</span><span class="n">memory_content</span><span class="p">,</span>
                        <span class="o">*</span><span class="n">result</span><span class="p">[</span><span class="n">system_idx</span><span class="p">]</span><span class="o">.</span><span class="n">blocks</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Create new system message at the beginning</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="n">blocks</span><span class="o">=</span><span class="n">memory_content</span><span class="p">))</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">insert_method</span> <span class="o">==</span> <span class="n">InsertMethod</span><span class="o">.</span><span class="n">USER</span><span class="p">:</span>
                <span class="c1"># Find the latest user message</span>
                <span class="n">session_idx</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">msg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">result</span><span class="p">))</span> <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;user&quot;</span><span class="p">),</span>
                    <span class="kc">None</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">session_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Get actual index (since we enumerated in reverse)</span>
                    <span class="n">actual_idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">session_idx</span>
                    <span class="c1"># Update existing user message</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">actual_idx</span><span class="p">]</span><span class="o">.</span><span class="n">blocks</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="o">*</span><span class="n">memory_content</span><span class="p">,</span>
                        <span class="o">*</span><span class="n">result</span><span class="p">[</span><span class="n">actual_idx</span><span class="p">]</span><span class="o">.</span><span class="n">blocks</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">blocks</span><span class="o">=</span><span class="n">memory_content</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">aget</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ChatMessage</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">block_kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]:</span>  <span class="c1"># type: ignore[override]</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get messages with memory blocks included (async).&quot;&quot;&quot;</span>
        <span class="c1"># Get chat history efficiently</span>
        <span class="n">chat_history</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql_store</span><span class="o">.</span><span class="n">get_messages</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">MessageStatus</span><span class="o">.</span><span class="n">ACTIVE</span>
        <span class="p">)</span>
        <span class="n">chat_history_tokens</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_estimate_token_count</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">chat_history</span>
        <span class="p">)</span>

        <span class="c1"># Get memory blocks content</span>
        <span class="n">content_per_memory_block</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_memory_blocks_content</span><span class="p">(</span>
            <span class="n">chat_history</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="nb">input</span><span class="p">,</span> <span class="o">**</span><span class="n">block_kwargs</span>
        <span class="p">)</span>

        <span class="c1"># Calculate memory blocks tokens</span>
        <span class="n">memory_blocks_tokens</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_estimate_token_count</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">content_per_memory_block</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="c1"># Handle truncation if needed</span>
        <span class="n">truncated_content</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_truncate_memory_blocks</span><span class="p">(</span>
            <span class="n">content_per_memory_block</span><span class="p">,</span> <span class="n">memory_blocks_tokens</span><span class="p">,</span> <span class="n">chat_history_tokens</span>
        <span class="p">)</span>

        <span class="c1"># Format template-based memory blocks</span>
        <span class="n">memory_blocks_data</span><span class="p">,</span> <span class="n">chat_message_data</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_memory_blocks</span><span class="p">(</span>
            <span class="n">truncated_content</span>
        <span class="p">)</span>

        <span class="c1"># Create messages from template content</span>
        <span class="n">memory_content</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">memory_blocks_data</span><span class="p">:</span>
            <span class="n">memory_block_messages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_blocks_template</span><span class="o">.</span><span class="n">format_messages</span><span class="p">(</span>
                <span class="n">memory_blocks</span><span class="o">=</span><span class="n">memory_blocks_data</span>
            <span class="p">)</span>
            <span class="n">memory_content</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">memory_block_messages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">blocks</span> <span class="k">if</span> <span class="n">memory_block_messages</span> <span class="k">else</span> <span class="p">[]</span>
            <span class="p">)</span>

        <span class="c1"># Insert memory content into chat history</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_insert_memory_content</span><span class="p">(</span>
            <span class="n">chat_history</span><span class="p">,</span> <span class="n">memory_content</span><span class="p">,</span> <span class="n">chat_message_data</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_manage_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Manage the FIFO queue.</span>

<span class="sd">        This function manages the memory queue using a waterfall approach:</span>
<span class="sd">        1. If the queue exceeds the token limit, it removes oldest messages first</span>
<span class="sd">        2. Removed messages are archived and passed to memory blocks</span>
<span class="sd">        3. It ensures conversation integrity by keeping related messages together</span>
<span class="sd">        4. It maintains at least one complete conversation turn</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Calculate if we need to waterfall</span>
        <span class="n">current_queue</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql_store</span><span class="o">.</span><span class="n">get_messages</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">MessageStatus</span><span class="o">.</span><span class="n">ACTIVE</span>
        <span class="p">)</span>

        <span class="c1"># If current queue is empty, return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">current_queue</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">tokens_in_current_queue</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_estimate_token_count</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">current_queue</span>
        <span class="p">)</span>

        <span class="c1"># If we&#39;re over the token limit, initiate waterfall</span>
        <span class="n">token_limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">token_limit</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">chat_history_token_ratio</span>
        <span class="k">if</span> <span class="n">tokens_in_current_queue</span> <span class="o">&gt;</span> <span class="n">token_limit</span><span class="p">:</span>
            <span class="c1"># Process from oldest to newest, but efficiently with pop() operations</span>
            <span class="n">reversed_queue</span> <span class="o">=</span> <span class="n">current_queue</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># newest first, oldest last</span>

            <span class="c1"># Calculate approximate number of messages to remove</span>
            <span class="n">tokens_to_remove</span> <span class="o">=</span> <span class="n">tokens_in_current_queue</span> <span class="o">-</span> <span class="n">token_limit</span>

            <span class="k">while</span> <span class="n">tokens_to_remove</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># If only one message left, keep it regardless of token count</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">reversed_queue</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">break</span>

                <span class="c1"># Collect messages to flush (up to flush size)</span>
                <span class="n">messages_to_flush</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">flushed_tokens</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="c1"># Remove oldest messages (from end of reversed list) until reaching flush size</span>
                <span class="k">while</span> <span class="p">(</span>
                    <span class="n">flushed_tokens</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">token_flush_size</span>
                    <span class="ow">and</span> <span class="n">reversed_queue</span>
                    <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">reversed_queue</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
                <span class="p">):</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="n">reversed_queue</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                    <span class="n">messages_to_flush</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                    <span class="n">flushed_tokens</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_estimate_token_count</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

                <span class="c1"># Ensure we keep at least one message</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">reversed_queue</span> <span class="ow">and</span> <span class="n">messages_to_flush</span><span class="p">:</span>
                    <span class="n">reversed_queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">messages_to_flush</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>

                <span class="c1"># We need to maintain conversation integrity</span>
                <span class="c1"># Messages should be removed in complete conversation turns</span>
                <span class="n">chronological_view</span> <span class="o">=</span> <span class="n">reversed_queue</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># View in chronological order</span>

                <span class="c1"># Find the correct conversation boundary</span>
                <span class="c1"># We want the first message in our remaining queue to be a user message</span>
                <span class="c1"># and the last message to be from assistant or tool</span>
                <span class="k">if</span> <span class="n">chronological_view</span><span class="p">:</span>
                    <span class="c1"># Keep removing messages until first remaining message is from user</span>
                    <span class="c1"># This ensures we start with a user message</span>
                    <span class="k">while</span> <span class="p">(</span>
                        <span class="n">chronological_view</span>
                        <span class="ow">and</span> <span class="n">chronological_view</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">role</span> <span class="o">!=</span> <span class="s2">&quot;user&quot;</span>
                        <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">reversed_queue</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
                    <span class="p">):</span>
                        <span class="k">if</span> <span class="n">reversed_queue</span><span class="p">:</span>
                            <span class="n">messages_to_flush</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reversed_queue</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>
                            <span class="n">chronological_view</span> <span class="o">=</span> <span class="n">reversed_queue</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">break</span>

                    <span class="c1"># If we end up with an empty queue, keep at least one full conversation turn</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">reversed_queue</span> <span class="ow">and</span> <span class="n">messages_to_flush</span><span class="p">:</span>
                        <span class="c1"># Find the most recent complete conversation turn</span>
                        <span class="c1"># (user  assistant/tool sequence) in messages_to_flush</span>
                        <span class="n">found_user</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">turn_messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

                        <span class="c1"># Go through messages_to_flush in reverse (newest first)</span>
                        <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">messages_to_flush</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;user&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">found_user</span><span class="p">:</span>
                                <span class="n">found_user</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="n">turn_messages</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="n">found_user</span><span class="p">:</span>
                                <span class="n">turn_messages</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">break</span>

                        <span class="c1"># If we found a complete turn, keep it</span>
                        <span class="k">if</span> <span class="n">found_user</span> <span class="ow">and</span> <span class="n">turn_messages</span><span class="p">:</span>
                            <span class="c1"># Remove these messages from messages_to_flush</span>
                            <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">turn_messages</span><span class="p">:</span>
                                <span class="n">messages_to_flush</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                            <span class="c1"># Add them back to the queue</span>
                            <span class="n">reversed_queue</span> <span class="o">=</span> <span class="n">turn_messages</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">reversed_queue</span>

                <span class="c1"># Archive the flushed messages</span>
                <span class="k">if</span> <span class="n">messages_to_flush</span><span class="p">:</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql_store</span><span class="o">.</span><span class="n">archive_oldest_messages</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">messages_to_flush</span><span class="p">)</span>
                    <span class="p">)</span>

                    <span class="c1"># Waterfall the flushed messages to memory blocks</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
                        <span class="o">*</span><span class="p">[</span>
                            <span class="n">block</span><span class="o">.</span><span class="n">aput</span><span class="p">(</span>
                                <span class="n">messages_to_flush</span><span class="p">,</span>
                                <span class="n">from_short_term_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                            <span class="p">)</span>
                            <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_blocks</span>
                        <span class="p">]</span>
                    <span class="p">)</span>

                <span class="c1"># Recalculate remaining tokens</span>
                <span class="n">chronological_view</span> <span class="o">=</span> <span class="n">reversed_queue</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">tokens_in_current_queue</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_estimate_token_count</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">chronological_view</span>
                <span class="p">)</span>
                <span class="n">tokens_to_remove</span> <span class="o">=</span> <span class="n">tokens_in_current_queue</span> <span class="o">-</span> <span class="n">token_limit</span>

                <span class="c1"># Exit if we&#39;ve flushed everything possible but still over limit</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">messages_to_flush</span><span class="p">:</span>
                    <span class="k">break</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">aput</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">ChatMessage</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a message to the chat store and process waterfall logic if needed.&quot;&quot;&quot;</span>
        <span class="c1"># Add the message to the chat store</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql_store</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">MessageStatus</span><span class="o">.</span><span class="n">ACTIVE</span>
        <span class="p">)</span>

        <span class="c1"># Ensure the active queue is managed</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manage_queue</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">aput_messages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a list of messages to the chat store and process waterfall logic if needed.&quot;&quot;&quot;</span>
        <span class="c1"># Add the messages to the chat store</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql_store</span><span class="o">.</span><span class="n">add_messages</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">MessageStatus</span><span class="o">.</span><span class="n">ACTIVE</span>
        <span class="p">)</span>

        <span class="c1"># Ensure the active queue is managed</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manage_queue</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">aset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the chat history.&quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql_store</span><span class="o">.</span><span class="n">set_messages</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">MessageStatus</span><span class="o">.</span><span class="n">ACTIVE</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">aget_all</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">MessageStatus</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all messages.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql_store</span><span class="o">.</span><span class="n">get_messages</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">areset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">MessageStatus</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset the memory.&quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql_store</span><span class="o">.</span><span class="n">delete_messages</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">)</span>

    <span class="c1"># ---- Sync method wrappers ----</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ChatMessage</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">block_kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]:</span>  <span class="c1"># type: ignore[override]</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get messages with memory blocks included.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">asyncio_run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aget</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="nb">input</span><span class="p">,</span> <span class="o">**</span><span class="n">block_kwargs</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">MessageStatus</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all messages.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">asyncio_run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aget_all</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">ChatMessage</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a message to the chat store and process waterfall logic if needed.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">asyncio_run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aput</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the chat history.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">asyncio_run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aset</span><span class="p">(</span><span class="n">messages</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset the memory.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">asyncio_run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">areset</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="llama_index.core.memory.Memory.from_defaults" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">from_defaults</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#llama_index.core.memory.Memory.from_defaults" class="headerlink" title="Permanent link">#</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">from_defaults</span><span class="p">(</span><span class="n">session_id</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">chat_history</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="typing.List">List</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.base.llms.types.ChatMessage" href="../../llms/#llama_index.core.base.llms.types.ChatMessage">ChatMessage</a></span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">token_limit</span><span class="p">:</span> <span class="n">int</span> <span class="o">=</span> <span class="n"><span title="llama_index.core.memory.memory.DEFAULT_TOKEN_LIMIT">DEFAULT_TOKEN_LIMIT</span></span><span class="p">,</span> <span class="n">memory_blocks</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="typing.List">List</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.memory.memory.BaseMemoryBlock" href="#llama_index.core.memory.BaseMemoryBlock">BaseMemoryBlock</a></span><span class="p">[</span><span class="n"><span title="typing.Any">Any</span></span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tokenizer_fn</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="typing.Callable">Callable</span></span><span class="p">[[</span><span class="n">str</span><span class="p">],</span> <span class="n"><span title="typing.List">List</span></span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">chat_history_token_ratio</span><span class="p">:</span> <span class="n">float</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">,</span> <span class="n">token_flush_size</span><span class="p">:</span> <span class="n">int</span> <span class="o">=</span> <span class="n"><span title="llama_index.core.memory.memory.DEFAULT_FLUSH_SIZE">DEFAULT_FLUSH_SIZE</span></span><span class="p">,</span> <span class="n">memory_blocks_template</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.prompts.RichPromptTemplate" href="../../prompts/#llama_index.core.prompts.RichPromptTemplate">RichPromptTemplate</a></span> <span class="o">=</span> <span class="n"><span title="llama_index.core.memory.memory.DEFAULT_MEMORY_BLOCKS_TEMPLATE">DEFAULT_MEMORY_BLOCKS_TEMPLATE</span></span><span class="p">,</span> <span class="n">insert_method</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.memory.memory.InsertMethod" href="#llama_index.core.memory.InsertMethod">InsertMethod</a></span> <span class="o">=</span> <span class="n"><span title="llama_index.core.memory.memory.InsertMethod.SYSTEM">SYSTEM</span></span><span class="p">,</span> <span class="n">image_token_size_estimate</span><span class="p">:</span> <span class="n">int</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span> <span class="n">audio_token_size_estimate</span><span class="p">:</span> <span class="n">int</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="n">str</span> <span class="o">=</span> <span class="s1">&#39;llama_index_memory&#39;</span><span class="p">,</span> <span class="n">async_database_uri</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">async_engine</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="sqlalchemy.ext.asyncio.AsyncEngine">AsyncEngine</span></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.memory.memory.Memory" href="#llama_index.core.memory.Memory">Memory</a></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Initialize Memory.</p>

            <details class="quote">
              <summary>Source code in <code>llama_index\core\memory\memory.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">from_defaults</span><span class="p">(</span>  <span class="c1"># type: ignore[override]</span>
    <span class="bp">cls</span><span class="p">,</span>
    <span class="n">session_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">chat_history</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">token_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_TOKEN_LIMIT</span><span class="p">,</span>
    <span class="n">memory_blocks</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">BaseMemoryBlock</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">tokenizer_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">chat_history_token_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">,</span>
    <span class="n">token_flush_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_FLUSH_SIZE</span><span class="p">,</span>
    <span class="n">memory_blocks_template</span><span class="p">:</span> <span class="n">RichPromptTemplate</span> <span class="o">=</span> <span class="n">DEFAULT_MEMORY_BLOCKS_TEMPLATE</span><span class="p">,</span>
    <span class="n">insert_method</span><span class="p">:</span> <span class="n">InsertMethod</span> <span class="o">=</span> <span class="n">InsertMethod</span><span class="o">.</span><span class="n">SYSTEM</span><span class="p">,</span>
    <span class="n">image_token_size_estimate</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
    <span class="n">audio_token_size_estimate</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
    <span class="c1"># SQLAlchemyChatStore parameters</span>
    <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;llama_index_memory&quot;</span><span class="p">,</span>
    <span class="n">async_database_uri</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">async_engine</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AsyncEngine</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Memory&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize Memory.&quot;&quot;&quot;</span>
    <span class="n">session_id</span> <span class="o">=</span> <span class="n">session_id</span> <span class="ow">or</span> <span class="n">generate_chat_store_key</span><span class="p">()</span>

    <span class="c1"># If not using the SQLAlchemyChatStore, provide an error</span>
    <span class="n">sql_store</span> <span class="o">=</span> <span class="n">SQLAlchemyChatStore</span><span class="p">(</span>
        <span class="n">table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span>
        <span class="n">async_database_uri</span><span class="o">=</span><span class="n">async_database_uri</span><span class="p">,</span>
        <span class="n">async_engine</span><span class="o">=</span><span class="n">async_engine</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">chat_history</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">asyncio_run</span><span class="p">(</span><span class="n">sql_store</span><span class="o">.</span><span class="n">set_messages</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="n">chat_history</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">token_flush_size</span> <span class="o">&gt;</span> <span class="n">token_limit</span><span class="p">:</span>
        <span class="n">token_flush_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">token_limit</span> <span class="o">*</span> <span class="mf">0.7</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
        <span class="n">token_limit</span><span class="o">=</span><span class="n">token_limit</span><span class="p">,</span>
        <span class="n">tokenizer_fn</span><span class="o">=</span><span class="n">tokenizer_fn</span> <span class="ow">or</span> <span class="n">get_tokenizer</span><span class="p">(),</span>
        <span class="n">sql_store</span><span class="o">=</span><span class="n">sql_store</span><span class="p">,</span>
        <span class="n">session_id</span><span class="o">=</span><span class="n">session_id</span><span class="p">,</span>
        <span class="n">memory_blocks</span><span class="o">=</span><span class="n">memory_blocks</span> <span class="ow">or</span> <span class="p">[],</span>
        <span class="n">chat_history_token_ratio</span><span class="o">=</span><span class="n">chat_history_token_ratio</span><span class="p">,</span>
        <span class="n">token_flush_size</span><span class="o">=</span><span class="n">token_flush_size</span><span class="p">,</span>
        <span class="n">memory_blocks_template</span><span class="o">=</span><span class="n">memory_blocks_template</span><span class="p">,</span>
        <span class="n">insert_method</span><span class="o">=</span><span class="n">insert_method</span><span class="p">,</span>
        <span class="n">image_token_size_estimate</span><span class="o">=</span><span class="n">image_token_size_estimate</span><span class="p">,</span>
        <span class="n">audio_token_size_estimate</span><span class="o">=</span><span class="n">audio_token_size_estimate</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="llama_index.core.memory.Memory.aget" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">aget</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#llama_index.core.memory.Memory.aget" class="headerlink" title="Permanent link">#</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">aget</span><span class="p">(</span><span class="nb">input</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="typing.Union">Union</span></span><span class="p">[</span><span class="n">str</span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.base.llms.types.ChatMessage" href="../../llms/#llama_index.core.base.llms.types.ChatMessage">ChatMessage</a></span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">block_kwargs</span><span class="p">:</span> <span class="n"><span title="typing.Any">Any</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="typing.List">List</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.base.llms.types.ChatMessage" href="../../llms/#llama_index.core.base.llms.types.ChatMessage">ChatMessage</a></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Get messages with memory blocks included (async).</p>

            <details class="quote">
              <summary>Source code in <code>llama_index\core\memory\memory.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">aget</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ChatMessage</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">block_kwargs</span><span class="p">:</span> <span class="n">Any</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]:</span>  <span class="c1"># type: ignore[override]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get messages with memory blocks included (async).&quot;&quot;&quot;</span>
    <span class="c1"># Get chat history efficiently</span>
    <span class="n">chat_history</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql_store</span><span class="o">.</span><span class="n">get_messages</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">MessageStatus</span><span class="o">.</span><span class="n">ACTIVE</span>
    <span class="p">)</span>
    <span class="n">chat_history_tokens</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_estimate_token_count</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">chat_history</span>
    <span class="p">)</span>

    <span class="c1"># Get memory blocks content</span>
    <span class="n">content_per_memory_block</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_memory_blocks_content</span><span class="p">(</span>
        <span class="n">chat_history</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="nb">input</span><span class="p">,</span> <span class="o">**</span><span class="n">block_kwargs</span>
    <span class="p">)</span>

    <span class="c1"># Calculate memory blocks tokens</span>
    <span class="n">memory_blocks_tokens</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_estimate_token_count</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">content_per_memory_block</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="c1"># Handle truncation if needed</span>
    <span class="n">truncated_content</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_truncate_memory_blocks</span><span class="p">(</span>
        <span class="n">content_per_memory_block</span><span class="p">,</span> <span class="n">memory_blocks_tokens</span><span class="p">,</span> <span class="n">chat_history_tokens</span>
    <span class="p">)</span>

    <span class="c1"># Format template-based memory blocks</span>
    <span class="n">memory_blocks_data</span><span class="p">,</span> <span class="n">chat_message_data</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_memory_blocks</span><span class="p">(</span>
        <span class="n">truncated_content</span>
    <span class="p">)</span>

    <span class="c1"># Create messages from template content</span>
    <span class="n">memory_content</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">memory_blocks_data</span><span class="p">:</span>
        <span class="n">memory_block_messages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_blocks_template</span><span class="o">.</span><span class="n">format_messages</span><span class="p">(</span>
            <span class="n">memory_blocks</span><span class="o">=</span><span class="n">memory_blocks_data</span>
        <span class="p">)</span>
        <span class="n">memory_content</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">memory_block_messages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">blocks</span> <span class="k">if</span> <span class="n">memory_block_messages</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="p">)</span>

    <span class="c1"># Insert memory content into chat history</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_insert_memory_content</span><span class="p">(</span>
        <span class="n">chat_history</span><span class="p">,</span> <span class="n">memory_content</span><span class="p">,</span> <span class="n">chat_message_data</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="llama_index.core.memory.Memory.aput" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">aput</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#llama_index.core.memory.Memory.aput" class="headerlink" title="Permanent link">#</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">aput</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.base.llms.types.ChatMessage" href="../../llms/#llama_index.core.base.llms.types.ChatMessage">ChatMessage</a></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Add a message to the chat store and process waterfall logic if needed.</p>

            <details class="quote">
              <summary>Source code in <code>llama_index\core\memory\memory.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">aput</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">ChatMessage</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add a message to the chat store and process waterfall logic if needed.&quot;&quot;&quot;</span>
    <span class="c1"># Add the message to the chat store</span>
    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql_store</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">MessageStatus</span><span class="o">.</span><span class="n">ACTIVE</span>
    <span class="p">)</span>

    <span class="c1"># Ensure the active queue is managed</span>
    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manage_queue</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="llama_index.core.memory.Memory.aput_messages" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">aput_messages</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#llama_index.core.memory.Memory.aput_messages" class="headerlink" title="Permanent link">#</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">aput_messages</span><span class="p">(</span><span class="n">messages</span><span class="p">:</span> <span class="n"><span title="typing.List">List</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.base.llms.types.ChatMessage" href="../../llms/#llama_index.core.base.llms.types.ChatMessage">ChatMessage</a></span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Add a list of messages to the chat store and process waterfall logic if needed.</p>

            <details class="quote">
              <summary>Source code in <code>llama_index\core\memory\memory.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">aput_messages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add a list of messages to the chat store and process waterfall logic if needed.&quot;&quot;&quot;</span>
    <span class="c1"># Add the messages to the chat store</span>
    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql_store</span><span class="o">.</span><span class="n">add_messages</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">MessageStatus</span><span class="o">.</span><span class="n">ACTIVE</span>
    <span class="p">)</span>

    <span class="c1"># Ensure the active queue is managed</span>
    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manage_queue</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="llama_index.core.memory.Memory.aset" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">aset</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#llama_index.core.memory.Memory.aset" class="headerlink" title="Permanent link">#</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">aset</span><span class="p">(</span><span class="n">messages</span><span class="p">:</span> <span class="n"><span title="typing.List">List</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.base.llms.types.ChatMessage" href="../../llms/#llama_index.core.base.llms.types.ChatMessage">ChatMessage</a></span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Set the chat history.</p>

            <details class="quote">
              <summary>Source code in <code>llama_index\core\memory\memory.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">aset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set the chat history.&quot;&quot;&quot;</span>
    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql_store</span><span class="o">.</span><span class="n">set_messages</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">MessageStatus</span><span class="o">.</span><span class="n">ACTIVE</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="llama_index.core.memory.Memory.aget_all" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">aget_all</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#llama_index.core.memory.Memory.aget_all" class="headerlink" title="Permanent link">#</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">aget_all</span><span class="p">(</span><span class="n">status</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="llama_index.core.storage.chat_store.sql.MessageStatus">MessageStatus</span></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="typing.List">List</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.base.llms.types.ChatMessage" href="../../llms/#llama_index.core.base.llms.types.ChatMessage">ChatMessage</a></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Get all messages.</p>

            <details class="quote">
              <summary>Source code in <code>llama_index\core\memory\memory.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">aget_all</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">MessageStatus</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get all messages.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql_store</span><span class="o">.</span><span class="n">get_messages</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="llama_index.core.memory.Memory.areset" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">areset</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#llama_index.core.memory.Memory.areset" class="headerlink" title="Permanent link">#</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">areset</span><span class="p">(</span><span class="n">status</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="llama_index.core.storage.chat_store.sql.MessageStatus">MessageStatus</span></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Reset the memory.</p>

            <details class="quote">
              <summary>Source code in <code>llama_index\core\memory\memory.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">areset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">MessageStatus</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reset the memory.&quot;&quot;&quot;</span>
    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql_store</span><span class="o">.</span><span class="n">delete_messages</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="llama_index.core.memory.Memory.get" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">get</span>


<a href="#llama_index.core.memory.Memory.get" class="headerlink" title="Permanent link">#</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">get</span><span class="p">(</span><span class="nb">input</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="typing.Union">Union</span></span><span class="p">[</span><span class="n">str</span><span class="p">,</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.base.llms.types.ChatMessage" href="../../llms/#llama_index.core.base.llms.types.ChatMessage">ChatMessage</a></span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">block_kwargs</span><span class="p">:</span> <span class="n"><span title="typing.Any">Any</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="typing.List">List</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.base.llms.types.ChatMessage" href="../../llms/#llama_index.core.base.llms.types.ChatMessage">ChatMessage</a></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Get messages with memory blocks included.</p>

            <details class="quote">
              <summary>Source code in <code>llama_index\core\memory\memory.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ChatMessage</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">block_kwargs</span><span class="p">:</span> <span class="n">Any</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]:</span>  <span class="c1"># type: ignore[override]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get messages with memory blocks included.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">asyncio_run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aget</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="nb">input</span><span class="p">,</span> <span class="o">**</span><span class="n">block_kwargs</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="llama_index.core.memory.Memory.get_all" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">get_all</span>


<a href="#llama_index.core.memory.Memory.get_all" class="headerlink" title="Permanent link">#</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">get_all</span><span class="p">(</span><span class="n">status</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="llama_index.core.storage.chat_store.sql.MessageStatus">MessageStatus</span></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="typing.List">List</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.base.llms.types.ChatMessage" href="../../llms/#llama_index.core.base.llms.types.ChatMessage">ChatMessage</a></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Get all messages.</p>

            <details class="quote">
              <summary>Source code in <code>llama_index\core\memory\memory.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">MessageStatus</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get all messages.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">asyncio_run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aget_all</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="llama_index.core.memory.Memory.put" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">put</span>


<a href="#llama_index.core.memory.Memory.put" class="headerlink" title="Permanent link">#</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">put</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.base.llms.types.ChatMessage" href="../../llms/#llama_index.core.base.llms.types.ChatMessage">ChatMessage</a></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Add a message to the chat store and process waterfall logic if needed.</p>

            <details class="quote">
              <summary>Source code in <code>llama_index\core\memory\memory.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">ChatMessage</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add a message to the chat store and process waterfall logic if needed.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">asyncio_run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aput</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="llama_index.core.memory.Memory.set" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">set</span>


<a href="#llama_index.core.memory.Memory.set" class="headerlink" title="Permanent link">#</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nb">set</span><span class="p">(</span><span class="nf">messages</span><span class="p">:</span> <span class="n"><span title="typing.List">List</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.base.llms.types.ChatMessage" href="../../llms/#llama_index.core.base.llms.types.ChatMessage">ChatMessage</a></span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Set the chat history.</p>

            <details class="quote">
              <summary>Source code in <code>llama_index\core\memory\memory.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set the chat history.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">asyncio_run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aset</span><span class="p">(</span><span class="n">messages</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="llama_index.core.memory.Memory.reset" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">reset</span>


<a href="#llama_index.core.memory.Memory.reset" class="headerlink" title="Permanent link">#</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">reset</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Reset the memory.</p>

            <details class="quote">
              <summary>Source code in <code>llama_index\core\memory\memory.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reset the memory.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">asyncio_run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">areset</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="llama_index.core.memory.BaseMemoryBlock" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">BaseMemoryBlock</span>


<a href="#llama_index.core.memory.BaseMemoryBlock" class="headerlink" title="Permanent link">#</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="llama_index.core.bridge.pydantic.BaseModel">BaseModel</span></code>, <code><span title="typing.Generic">Generic</span>[<span title="llama_index.core.memory.memory.T">T</span>]</code></p>


        <p>A base class for memory blocks.</p>
<p>Subclasses must implement the <code>aget</code> and <code>aput</code> methods.
Optionally, subclasses can implement the <code>atruncate</code> method, which is used to reduce the size of the memory block.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>name</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name/identifier of the memory block.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>description</code>
            </td>
            <td>
                  <code>str | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A description of the memory block.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>priority</code>
            </td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Priority of this memory block (0 = never truncate, 1 = highest priority, etc.).</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>accept_short_term_memory</code>
            </td>
            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to accept puts from messages ejected from the short-term memory.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>






              <details class="quote">
                <summary>Source code in <code>llama_index\core\memory\memory.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">BaseMemoryBlock</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">,</span> <span class="n">Generic</span><span class="p">[</span><span class="n">T</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A base class for memory blocks.</span>

<span class="sd">    Subclasses must implement the `aget` and `aput` methods.</span>
<span class="sd">    Optionally, subclasses can implement the `atruncate` method, which is used to reduce the size of the memory block.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">model_config</span> <span class="o">=</span> <span class="n">ConfigDict</span><span class="p">(</span><span class="n">arbitrary_types_allowed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;The name/identifier of the memory block.&quot;</span><span class="p">)</span>
    <span class="n">description</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;A description of the memory block.&quot;</span>
    <span class="p">)</span>
    <span class="n">priority</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Priority of this memory block (0 = never truncate, 1 = highest priority, etc.).&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">accept_short_term_memory</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Whether to accept puts from messages ejected from the short-term memory.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">_aget</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">block_kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pull the memory block (async).&quot;&quot;&quot;</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">aget</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">block_kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pull the memory block (async).</span>

<span class="sd">        Returns:</span>
<span class="sd">            T: The memory block content. One of:</span>
<span class="sd">            - str: A simple text string to be inserted into the template.</span>
<span class="sd">            - List[ContentBlock]: A list of content blocks to be inserted into the template.</span>
<span class="sd">            - List[ChatMessage]: A list of chat messages to be directly appended to the chat history.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aget</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="o">**</span><span class="n">block_kwargs</span><span class="p">)</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">_aput</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Push to the memory block (async).&quot;&quot;&quot;</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">aput</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span>
        <span class="n">from_short_term_memory</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">session_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Push to the memory block (async).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">from_short_term_memory</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">accept_short_term_memory</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">session_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
                <span class="n">message</span><span class="o">.</span><span class="n">additional_kwargs</span><span class="p">[</span><span class="s2">&quot;session_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session_id</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aput</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">atruncate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="n">T</span><span class="p">,</span> <span class="n">tokens_to_truncate</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Truncate the memory block content to the given token limit.</span>

<span class="sd">        By default, truncation will remove the entire block content.</span>

<span class="sd">        Args:</span>
<span class="sd">            content:</span>
<span class="sd">                The content of type T, depending on what the memory block returns.</span>
<span class="sd">            tokens_to_truncate:</span>
<span class="sd">                The number of tokens requested to truncate the content by.</span>
<span class="sd">                Blocks may or may not truncate to the exact number of tokens requested, but it</span>
<span class="sd">                can be used as a hint for the block to truncate.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The truncated content of type T, or None if the content is completely truncated.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="llama_index.core.memory.BaseMemoryBlock.aget" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">aget</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#llama_index.core.memory.BaseMemoryBlock.aget" class="headerlink" title="Permanent link">#</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">aget</span><span class="p">(</span><span class="n">messages</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="typing.List">List</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.base.llms.types.ChatMessage" href="../../llms/#llama_index.core.base.llms.types.ChatMessage">ChatMessage</a></span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">block_kwargs</span><span class="p">:</span> <span class="n"><span title="typing.Any">Any</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="llama_index.core.memory.memory.T">T</span></span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Pull the memory block (async).</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>T</code></td>            <td>
                  <code><span title="llama_index.core.memory.memory.T">T</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The memory block content. One of:</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td></td>            <td>
                  <code><span title="llama_index.core.memory.memory.T">T</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li>str: A simple text string to be inserted into the template.</li>
</ul>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td></td>            <td>
                  <code><span title="llama_index.core.memory.memory.T">T</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li>List[ContentBlock]: A list of content blocks to be inserted into the template.</li>
</ul>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td></td>            <td>
                  <code><span title="llama_index.core.memory.memory.T">T</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li>List[ChatMessage]: A list of chat messages to be directly appended to the chat history.</li>
</ul>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>llama_index\core\memory\memory.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">aget</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">block_kwargs</span><span class="p">:</span> <span class="n">Any</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pull the memory block (async).</span>

<span class="sd">    Returns:</span>
<span class="sd">        T: The memory block content. One of:</span>
<span class="sd">        - str: A simple text string to be inserted into the template.</span>
<span class="sd">        - List[ContentBlock]: A list of content blocks to be inserted into the template.</span>
<span class="sd">        - List[ChatMessage]: A list of chat messages to be directly appended to the chat history.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aget</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="o">**</span><span class="n">block_kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="llama_index.core.memory.BaseMemoryBlock.aput" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">aput</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#llama_index.core.memory.BaseMemoryBlock.aput" class="headerlink" title="Permanent link">#</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">aput</span><span class="p">(</span><span class="n">messages</span><span class="p">:</span> <span class="n"><span title="typing.List">List</span></span><span class="p">[</span><span class="n"><a class="autorefs autorefs-internal" title="llama_index.core.base.llms.types.ChatMessage" href="../../llms/#llama_index.core.base.llms.types.ChatMessage">ChatMessage</a></span><span class="p">],</span> <span class="n">from_short_term_memory</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Push to the memory block (async).</p>

            <details class="quote">
              <summary>Source code in <code>llama_index\core\memory\memory.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">aput</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span>
    <span class="n">from_short_term_memory</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">session_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Push to the memory block (async).&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">from_short_term_memory</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">accept_short_term_memory</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">session_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
            <span class="n">message</span><span class="o">.</span><span class="n">additional_kwargs</span><span class="p">[</span><span class="s2">&quot;session_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session_id</span>

    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aput</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="llama_index.core.memory.BaseMemoryBlock.atruncate" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">atruncate</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#llama_index.core.memory.BaseMemoryBlock.atruncate" class="headerlink" title="Permanent link">#</a></h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">atruncate</span><span class="p">(</span><span class="n">content</span><span class="p">:</span> <span class="n"><span title="llama_index.core.memory.memory.T">T</span></span><span class="p">,</span> <span class="n">tokens_to_truncate</span><span class="p">:</span> <span class="n">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="typing.Optional">Optional</span></span><span class="p">[</span><span class="n"><span title="llama_index.core.memory.memory.T">T</span></span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Truncate the memory block content to the given token limit.</p>
<p>By default, truncation will remove the entire block content.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>content</code>
            </td>
            <td>
                  <code><span title="llama_index.core.memory.memory.T">T</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The content of type T, depending on what the memory block returns.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tokens_to_truncate</code>
            </td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of tokens requested to truncate the content by.
Blocks may or may not truncate to the exact number of tokens requested, but it
can be used as a hint for the block to truncate.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="llama_index.core.memory.memory.T">T</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The truncated content of type T, or None if the content is completely truncated.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>llama_index\core\memory\memory.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">atruncate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="n">T</span><span class="p">,</span> <span class="n">tokens_to_truncate</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Truncate the memory block content to the given token limit.</span>

<span class="sd">    By default, truncation will remove the entire block content.</span>

<span class="sd">    Args:</span>
<span class="sd">        content:</span>
<span class="sd">            The content of type T, depending on what the memory block returns.</span>
<span class="sd">        tokens_to_truncate:</span>
<span class="sd">            The number of tokens requested to truncate the content by.</span>
<span class="sd">            Blocks may or may not truncate to the exact number of tokens requested, but it</span>
<span class="sd">            can be used as a hint for the block to truncate.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The truncated content of type T, or None if the content is completely truncated.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="llama_index.core.memory.InsertMethod" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">InsertMethod</span>


<a href="#llama_index.core.memory.InsertMethod" class="headerlink" title="Permanent link">#</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="enum.Enum">Enum</span></code></p>







              <details class="quote">
                <summary>Source code in <code>llama_index\core\memory\memory.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">InsertMethod</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">SYSTEM</span> <span class="o">=</span> <span class="s2">&quot;system&quot;</span>
    <span class="n">USER</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="llama_index.core.memory.StaticMemoryBlock" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">StaticMemoryBlock</span>


<a href="#llama_index.core.memory.StaticMemoryBlock" class="headerlink" title="Permanent link">#</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="llama_index.core.memory.memory.BaseMemoryBlock" href="#llama_index.core.memory.BaseMemoryBlock">BaseMemoryBlock</a>[<span title="typing.List">List</span>[<span title="llama_index.core.base.llms.types.ContentBlock">ContentBlock</span>]]</code></p>


        <p>A memory block that returns static text.</p>
<p>This block is useful for including constant information or instructions
in the context without relying on external processing.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>name</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the memory block.</p>
              </div>
            </td>
            <td>
                  <code>&#39;StaticContent&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>static_content</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[Annotated[<span title="typing.Union">Union</span>[<a class="autorefs autorefs-internal" title="llama_index.core.base.llms.types.TextBlock" href="../../llms/#llama_index.core.base.llms.types.TextBlock">TextBlock</a>, ImageBlock, AudioBlock, DocumentBlock], FieldInfo]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Static text or content to be returned by this memory block.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>






              <details class="quote">
                <summary>Source code in <code>llama_index\core\memory\memory_blocks\static.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">StaticMemoryBlock</span><span class="p">(</span><span class="n">BaseMemoryBlock</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ContentBlock</span><span class="p">]]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A memory block that returns static text.</span>

<span class="sd">    This block is useful for including constant information or instructions</span>
<span class="sd">    in the context without relying on external processing.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;StaticContent&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The name of the memory block.&quot;</span>
    <span class="p">)</span>
    <span class="n">static_content</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ContentBlock</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Static text or content to be returned by this memory block.&quot;</span>
    <span class="p">)</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;static_content&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;before&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">validate_static_content</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">ContentBlock</span><span class="p">]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ContentBlock</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="p">[</span><span class="n">TextBlock</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">v</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_aget</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">block_kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ContentBlock</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the static text, potentially filtered by conditions.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">static_content</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_aput</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;No-op for static blocks as they don&#39;t change.&quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="llama_index.core.memory.VectorMemoryBlock" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">VectorMemoryBlock</span>


<a href="#llama_index.core.memory.VectorMemoryBlock" class="headerlink" title="Permanent link">#</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="llama_index.core.memory.memory.BaseMemoryBlock" href="#llama_index.core.memory.BaseMemoryBlock">BaseMemoryBlock</a>[str]</code></p>


        <p>A memory block that retrieves relevant information from a vector store.</p>
<p>This block stores conversation history in a vector store and retrieves
relevant information based on the most recent messages.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>name</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the memory block.</p>
              </div>
            </td>
            <td>
                  <code>&#39;RetrievedMessages&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>vector_store</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="llama_index.core.vector_stores.types.BasePydanticVectorStore" href="../../storage/vector_store/#llama_index.core.vector_stores.types.BasePydanticVectorStore">BasePydanticVectorStore</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The vector store to use for retrieval.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>embed_model</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="llama_index.core.base.embeddings.base.BaseEmbedding" href="../../embeddings/#llama_index.core.embeddings.BaseEmbedding">BaseEmbedding</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The embedding model to use for encoding queries and documents.</p>
              </div>
            </td>
            <td>
                  <code>OpenAIEmbedding(model_name=&#39;text-embedding-ada-002&#39;, embed_batch_size=100, callback_manager=&lt;llama_index.core.callbacks.base.CallbackManager object at 0x0000022D4AF73EF0&gt;, num_workers=None, embeddings_cache=None, additional_kwargs={}, api_key=&#39;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&#39;, api_base=&#39;https://api.openai.com/v1&#39;, api_version=&#39;&#39;, max_retries=10, timeout=60.0, default_headers=None, reuse_client=True, dimensions=None)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>similarity_top_k</code>
            </td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of top results to return.</p>
              </div>
            </td>
            <td>
                  <code>2</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>retrieval_context_window</code>
            </td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum number of messages to include for context when retrieving.</p>
              </div>
            </td>
            <td>
                  <code>5</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>format_template</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="llama_index.core.prompts.BasePromptTemplate" href="../../prompts/#llama_index.core.prompts.BasePromptTemplate">BasePromptTemplate</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Template for formatting the retrieved information.</p>
              </div>
            </td>
            <td>
                  <code>RichPromptTemplate(metadata={}, template_vars=[&#39;text&#39;], kwargs={}, output_parser=None, template_var_mappings=None, function_mappings=None, template_str=&#39;{{ text }}&#39;)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>node_postprocessors</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<a class="autorefs autorefs-internal" title="llama_index.core.postprocessor.types.BaseNodePostprocessor" href="../../postprocessor/#llama_index.core.postprocessor.types.BaseNodePostprocessor">BaseNodePostprocessor</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of node postprocessors to apply to the retrieved nodes containing messages.</p>
              </div>
            </td>
            <td>
                  <code>[]</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>query_kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[str, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments for the vector store query.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>






              <details class="quote">
                <summary>Source code in <code>llama_index\core\memory\memory_blocks\vector.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">VectorMemoryBlock</span><span class="p">(</span><span class="n">BaseMemoryBlock</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A memory block that retrieves relevant information from a vector store.</span>

<span class="sd">    This block stores conversation history in a vector store and retrieves</span>
<span class="sd">    relevant information based on the most recent messages.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;RetrievedMessages&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The name of the memory block.&quot;</span>
    <span class="p">)</span>
    <span class="n">vector_store</span><span class="p">:</span> <span class="n">BasePydanticVectorStore</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The vector store to use for retrieval.&quot;</span>
    <span class="p">)</span>
    <span class="n">embed_model</span><span class="p">:</span> <span class="n">BaseEmbedding</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="n">get_default_embed_model</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The embedding model to use for encoding queries and documents.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">similarity_top_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Number of top results to return.&quot;</span>
    <span class="p">)</span>
    <span class="n">retrieval_context_window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Maximum number of messages to include for context when retrieving.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">format_template</span><span class="p">:</span> <span class="n">BasePromptTemplate</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_RETRIEVED_TEXT_TEMPLATE</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Template for formatting the retrieved information.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">node_postprocessors</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">BaseNodePostprocessor</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;List of node postprocessors to apply to the retrieved nodes containing messages.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">query_kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Additional keyword arguments for the vector store query.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;vector_store&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;before&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">validate_vector_store</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;BasePydanticVectorStore&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">BasePydanticVectorStore</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;vector_store must be a BasePydanticVectorStore&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="o">.</span><span class="n">stores_text</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;vector_store must store text to be used as a retrieval memory block&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">v</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;format_template&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;before&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">validate_format_template</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;BasePromptTemplate&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;{{&quot;</span> <span class="ow">in</span> <span class="n">v</span> <span class="ow">and</span> <span class="s2">&quot;}}&quot;</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">RichPromptTemplate</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">PromptTemplate</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">v</span>

    <span class="k">def</span> <span class="nf">_get_text_from_messages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the text from the messages.&quot;&quot;&quot;</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">message</span><span class="o">.</span><span class="n">blocks</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">TextBlock</span><span class="p">):</span>
                    <span class="n">text</span> <span class="o">+=</span> <span class="n">block</span><span class="o">.</span><span class="n">text</span>

        <span class="k">return</span> <span class="n">text</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_aget</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">messages</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">session_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">block_kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve relevant information based on recent messages.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">messages</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># Use the last message or a context window of messages for the query</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">retrieval_context_window</span> <span class="o">&gt;</span> <span class="mi">1</span>
            <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieval_context_window</span>
        <span class="p">):</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">messages</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">retrieval_context_window</span> <span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">messages</span>

        <span class="n">query_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_text_from_messages</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">query_text</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># Handle filtering by session_id</span>
        <span class="k">if</span> <span class="n">session_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">filter</span> <span class="o">=</span> <span class="n">MetadataFilter</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;session_id&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">session_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;filters&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_kwargs</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">query_kwargs</span><span class="p">[</span><span class="s2">&quot;filters&quot;</span><span class="p">],</span> <span class="n">MetadataFilters</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">query_kwargs</span><span class="p">[</span><span class="s2">&quot;filters&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">filter</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">query_kwargs</span><span class="p">[</span><span class="s2">&quot;filters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MetadataFilters</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="p">[</span><span class="nb">filter</span><span class="p">])</span>

        <span class="c1"># Create and execute the query</span>
        <span class="n">query_embedding</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_model</span><span class="o">.</span><span class="n">aget_query_embedding</span><span class="p">(</span><span class="n">query_text</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">VectorStoreQuery</span><span class="p">(</span>
            <span class="n">query_str</span><span class="o">=</span><span class="n">query_text</span><span class="p">,</span>
            <span class="n">query_embedding</span><span class="o">=</span><span class="n">query_embedding</span><span class="p">,</span>
            <span class="n">similarity_top_k</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">similarity_top_k</span><span class="p">,</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">query_kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_store</span><span class="o">.</span><span class="n">aquery</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">nodes_with_scores</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">NodeWithScore</span><span class="p">(</span><span class="n">node</span><span class="o">=</span><span class="n">node</span><span class="p">,</span> <span class="n">score</span><span class="o">=</span><span class="n">score</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">nodes</span> <span class="ow">or</span> <span class="p">[],</span> <span class="n">results</span><span class="o">.</span><span class="n">similarities</span> <span class="ow">or</span> <span class="p">[])</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">nodes_with_scores</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># Apply postprocessors</span>
        <span class="k">for</span> <span class="n">postprocessor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_postprocessors</span><span class="p">:</span>
            <span class="n">nodes_with_scores</span> <span class="o">=</span> <span class="k">await</span> <span class="n">postprocessor</span><span class="o">.</span><span class="n">apostprocess_nodes</span><span class="p">(</span>
                <span class="n">nodes_with_scores</span><span class="p">,</span> <span class="n">query_str</span><span class="o">=</span><span class="n">query_text</span>
            <span class="p">)</span>

        <span class="c1"># Format the results</span>
        <span class="n">retrieved_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">node</span><span class="o">.</span><span class="n">get_content</span><span class="p">()</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes_with_scores</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">retrieved_text</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_aput</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Store messages in the vector store for future retrieval.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">messages</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Format messages with role, text content, and additional info</span>
        <span class="n">texts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">session_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_text_from_messages</span><span class="p">([</span><span class="n">message</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># special case for session_id</span>
            <span class="k">if</span> <span class="s2">&quot;session_id&quot;</span> <span class="ow">in</span> <span class="n">message</span><span class="o">.</span><span class="n">additional_kwargs</span><span class="p">:</span>
                <span class="n">session_id</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">additional_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;session_id&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">additional_kwargs</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Additional Info: (</span><span class="si">{</span><span class="n">message</span><span class="o">.</span><span class="n">additional_kwargs</span><span class="si">!s}</span><span class="s2">)&quot;</span>

            <span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;message role=&#39;</span><span class="si">{</span><span class="n">message</span><span class="o">.</span><span class="n">role</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&#39;&gt;</span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s2">&lt;/message&gt;&quot;</span>
            <span class="n">texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">texts</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Get embeddings</span>
        <span class="n">text_node</span> <span class="o">=</span> <span class="n">TextNode</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">texts</span><span class="p">),</span> <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;session_id&quot;</span><span class="p">:</span> <span class="n">session_id</span><span class="p">})</span>
        <span class="n">text_node</span><span class="o">.</span><span class="n">embedding</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_model</span><span class="o">.</span><span class="n">aget_text_embedding</span><span class="p">(</span><span class="n">text_node</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

        <span class="c1"># Add to vector store, one node per entire message batch</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_store</span><span class="o">.</span><span class="n">async_add</span><span class="p">([</span><span class="n">text_node</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="llama_index.core.memory.FactExtractionMemoryBlock" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">FactExtractionMemoryBlock</span>


<a href="#llama_index.core.memory.FactExtractionMemoryBlock" class="headerlink" title="Permanent link">#</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="llama_index.core.memory.memory.BaseMemoryBlock" href="#llama_index.core.memory.BaseMemoryBlock">BaseMemoryBlock</a>[str]</code></p>


        <p>A memory block that extracts key facts from conversation history using an LLM.</p>
<p>This block identifies and stores discrete facts disclosed during the conversation,
structuring them in XML format for easy parsing and retrieval.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>name</code>
            </td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the memory block.</p>
              </div>
            </td>
            <td>
                  <code>&#39;ExtractedFacts&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>llm</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="llama_index.core.llms.LLM" href="../../llms/#llama_index.core.llms.llm.LLM">LLM</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The LLM to use for fact extraction.</p>
              </div>
            </td>
            <td>
                  <code>OpenAI(callback_manager=&lt;llama_index.core.callbacks.base.CallbackManager object at 0x0000022D4AF73EF0&gt;, system_prompt=None, messages_to_prompt=&lt;function messages_to_prompt at 0x0000022D478E5EE0&gt;, completion_to_prompt=&lt;function default_completion_to_prompt at 0x0000022D479794E0&gt;, output_parser=None, pydantic_program_mode=&lt;PydanticProgramMode.DEFAULT: &#39;default&#39;&gt;, query_wrapper_prompt=None, model=&#39;gpt-3.5-turbo&#39;, temperature=0.1, max_tokens=None, logprobs=None, top_logprobs=0, additional_kwargs={}, max_retries=3, timeout=60.0, default_headers=None, reuse_client=True, api_key=&#39;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&#39;, api_base=&#39;https://api.openai.com/v1&#39;, api_version=&#39;&#39;, strict=False, reasoning_effort=None, modalities=None, audio_config=None)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>facts</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[str]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of extracted facts from the conversation.</p>
              </div>
            </td>
            <td>
                  <code>[]</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_facts</code>
            </td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum number of facts to store.</p>
              </div>
            </td>
            <td>
                  <code>50</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>fact_extraction_prompt_template</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="llama_index.core.prompts.BasePromptTemplate" href="../../prompts/#llama_index.core.prompts.BasePromptTemplate">BasePromptTemplate</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Template for the fact extraction prompt.</p>
              </div>
            </td>
            <td>
                  <code>RichPromptTemplate(metadata={}, template_vars=[&#39;existing_facts&#39;], kwargs={}, output_parser=None, template_var_mappings=None, function_mappings=None, template_str=&#39;You are a precise fact extraction system designed to identify key information from conversations.\n\nINSTRUCTIONS:\n1. Review the conversation segment provided prior to this message\n2. Extract specific, concrete facts the user has disclosed or important information discovered\n3. Focus on factual information like preferences, personal details, requirements, constraints, or context\n4. Format each fact as a separate &lt;fact&gt; XML tag\n5. Do not include opinions, summaries, or interpretations - only extract explicit information\n6. Do not duplicate facts that are already in the existing facts list\n\n&lt;existing_facts&gt;\n{{ existing_facts }}\n&lt;/existing_facts&gt;\n\nReturn ONLY the extracted facts in this exact format:\n&lt;facts&gt;\n  &lt;fact&gt;Specific fact 1&lt;/fact&gt;\n  &lt;fact&gt;Specific fact 2&lt;/fact&gt;\n  &lt;!-- More facts as needed --&gt;\n&lt;/facts&gt;\n\nIf no new facts are present, return: &lt;facts&gt;&lt;/facts&gt;&#39;)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>fact_condense_prompt_template</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="llama_index.core.prompts.BasePromptTemplate" href="../../prompts/#llama_index.core.prompts.BasePromptTemplate">BasePromptTemplate</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Template for the fact condense prompt.</p>
              </div>
            </td>
            <td>
                  <code>RichPromptTemplate(metadata={}, template_vars=[&#39;existing_facts&#39;, &#39;max_facts&#39;], kwargs={}, output_parser=None, template_var_mappings=None, function_mappings=None, template_str=&#39;You are a precise fact condensing system designed to identify key information from conversations.\n\nINSTRUCTIONS:\n1. Review the current list of existing facts\n2. Condense the facts into a more concise list, less than {{ max_facts }} facts\n3. Focus on factual information like preferences, personal details, requirements, constraints, or context\n4. Format each fact as a separate &lt;fact&gt; XML tag\n5. Do not include opinions, summaries, or interpretations - only extract explicit information\n6. Do not duplicate facts that are already in the existing facts list\n\n&lt;existing_facts&gt;\n{{ existing_facts }}\n&lt;/existing_facts&gt;\n\nReturn ONLY the condensed facts in this exact format:\n&lt;facts&gt;\n  &lt;fact&gt;Specific fact 1&lt;/fact&gt;\n  &lt;fact&gt;Specific fact 2&lt;/fact&gt;\n  &lt;!-- More facts as needed --&gt;\n&lt;/facts&gt;\n\nIf no new facts are present, return: &lt;facts&gt;&lt;/facts&gt;&#39;)</code>
            </td>
          </tr>
      </tbody>
    </table>






              <details class="quote">
                <summary>Source code in <code>llama_index\core\memory\memory_blocks\fact.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">FactExtractionMemoryBlock</span><span class="p">(</span><span class="n">BaseMemoryBlock</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A memory block that extracts key facts from conversation history using an LLM.</span>

<span class="sd">    This block identifies and stores discrete facts disclosed during the conversation,</span>
<span class="sd">    structuring them in XML format for easy parsing and retrieval.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;ExtractedFacts&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The name of the memory block.&quot;</span>
    <span class="p">)</span>
    <span class="n">llm</span><span class="p">:</span> <span class="n">LLM</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="n">get_default_llm</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The LLM to use for fact extraction.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">facts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;List of extracted facts from the conversation.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">max_facts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The maximum number of facts to store.&quot;</span>
    <span class="p">)</span>
    <span class="n">fact_extraction_prompt_template</span><span class="p">:</span> <span class="n">BasePromptTemplate</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_FACT_EXTRACT_PROMPT</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Template for the fact extraction prompt.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">fact_condense_prompt_template</span><span class="p">:</span> <span class="n">BasePromptTemplate</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_FACT_CONDENSE_PROMPT</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Template for the fact condense prompt.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;fact_extraction_prompt_template&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;before&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">validate_fact_extraction_prompt_template</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">BasePromptTemplate</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BasePromptTemplate</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;{{&quot;</span> <span class="ow">in</span> <span class="n">v</span> <span class="ow">and</span> <span class="s2">&quot;}}&quot;</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">RichPromptTemplate</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">PromptTemplate</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_aget</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">block_kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the current facts as formatted text.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">facts</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;&lt;fact&gt;</span><span class="si">{</span><span class="n">fact</span><span class="si">}</span><span class="s2">&lt;/fact&gt;&quot;</span> <span class="k">for</span> <span class="n">fact</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">facts</span><span class="p">])</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_aput</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract facts from new messages and add them to the facts list.&quot;&quot;&quot;</span>
        <span class="c1"># Skip if no messages</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">messages</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Format existing facts for the prompt</span>
        <span class="n">existing_facts_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">facts</span><span class="p">:</span>
            <span class="n">existing_facts_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;&lt;fact&gt;</span><span class="si">{</span><span class="n">fact</span><span class="si">}</span><span class="s2">&lt;/fact&gt;&quot;</span> <span class="k">for</span> <span class="n">fact</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">facts</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="c1"># Create the prompt</span>
        <span class="n">prompt_messages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fact_extraction_prompt_template</span><span class="o">.</span><span class="n">format_messages</span><span class="p">(</span>
            <span class="n">existing_facts</span><span class="o">=</span><span class="n">existing_facts_text</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Get the facts extraction</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">achat</span><span class="p">(</span><span class="n">messages</span><span class="o">=</span><span class="p">[</span><span class="o">*</span><span class="n">messages</span><span class="p">,</span> <span class="o">*</span><span class="n">prompt_messages</span><span class="p">])</span>

        <span class="c1"># Parse the XML response to extract facts</span>
        <span class="n">facts_text</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="n">new_facts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_facts_xml</span><span class="p">(</span><span class="n">facts_text</span><span class="p">)</span>

        <span class="c1"># Add new facts to the list, avoiding exact-match duplicates</span>
        <span class="k">for</span> <span class="n">fact</span> <span class="ow">in</span> <span class="n">new_facts</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fact</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">facts</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">facts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fact</span><span class="p">)</span>

        <span class="c1"># Condense the facts if they exceed the max_facts</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">facts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_facts</span><span class="p">:</span>
            <span class="n">existing_facts_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;&lt;fact&gt;</span><span class="si">{</span><span class="n">fact</span><span class="si">}</span><span class="s2">&lt;/fact&gt;&quot;</span> <span class="k">for</span> <span class="n">fact</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">facts</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="n">prompt_messages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fact_condense_prompt_template</span><span class="o">.</span><span class="n">format_messages</span><span class="p">(</span>
                <span class="n">existing_facts</span><span class="o">=</span><span class="n">existing_facts_text</span><span class="p">,</span>
                <span class="n">max_facts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_facts</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">achat</span><span class="p">(</span><span class="n">messages</span><span class="o">=</span><span class="p">[</span><span class="o">*</span><span class="n">messages</span><span class="p">,</span> <span class="o">*</span><span class="n">prompt_messages</span><span class="p">])</span>
            <span class="n">new_facts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_facts_xml</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">facts</span> <span class="o">=</span> <span class="n">new_facts</span>

    <span class="k">def</span> <span class="nf">_parse_facts_xml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse facts from XML format.&quot;&quot;&quot;</span>
        <span class="n">facts</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Extract content between &lt;fact&gt; tags</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&lt;fact&gt;(.*?)&lt;/fact&gt;&quot;</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">xml_text</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>

        <span class="c1"># Clean up extracted facts</span>
        <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
            <span class="n">fact</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">fact</span><span class="p">:</span>
                <span class="n">facts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fact</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">facts</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>




  </div>

    </div>

</div>









  




                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
       
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../mem0/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Mem0">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Mem0
              </div>
            </div>
          </a>
        
        
          
          <a href="../simple_composable_memory/" class="md-footer__link md-footer__link--next" aria-label="Next: Simple composable memory">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Simple composable memory
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <readthedocs-flyout position="bottom-left"></readthedocs-flyout>
      
    </div>
  </div>
</footer>
      
<!-- Google Tag Manager -->
<script>
  (function (w, d, s, l, i) {
    w[l] = w[l] || [];
    w[l].push({ "gtm.start": new Date().getTime(), event: "gtm.js" });
    var f = d.getElementsByTagName(s)[0],
      j = d.createElement(s),
      dl = l != "dataLayer" ? "&l=" + l : "";
    j.async = true;
    j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
    f.parentNode.insertBefore(j, f);
  })(window, document, "script", "dataLayer", "GTM-WWRFB36R");
</script>
<!-- End Google Tag Manager -->

    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.instant", "navigation.prune", "navigation.tabs", "navigation.indexes", "navigation.top", "navigation.footer", "toc.follow", "content.code.copy", "search.suggest", "search.highlight"], "search": "../../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.88dd0f4e.min.js"></script>
      
        <script src="../../../javascript/runllm.js"></script>
      
        <script src="../../../javascript/algolia.js"></script>
      
    
  </body>
</html>